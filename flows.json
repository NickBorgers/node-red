[
    {
        "id": "d7a3510d.e93d98",
        "type": "tab",
        "label": "State Tracking",
        "disabled": false,
        "info": ""
    },
    {
        "id": "634c78c80eb9f37e",
        "type": "tab",
        "label": "Configuration",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "499c53680d148fb0",
        "type": "tab",
        "label": "Calendar",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "16cd74edb3f2c03d",
        "type": "tab",
        "label": "Hue Control",
        "disabled": false,
        "info": ""
    },
    {
        "id": "90f5fe8cb80ae6a7",
        "type": "tab",
        "label": "Music",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "45c21b8b98ae2f01",
        "type": "tab",
        "label": "Vacuum",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "95cf961539320dd3",
        "type": "tab",
        "label": "Sleep Hygiene",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "9e0490d1fc323107",
        "type": "tab",
        "label": "Log",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "6a064f420a191bf8",
        "type": "tab",
        "label": "Climate Control",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "0d2150a703bedcd6",
        "type": "tab",
        "label": "Nagging",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "b2cc5799.eea9d",
        "type": "homekit-bridge",
        "bridgeName": "NodeRed1",
        "pinCode": "169-45-991",
        "port": "",
        "advertiser": "bonjour-hap",
        "allowInsecureRequest": false,
        "manufacturer": "NRCHKB",
        "model": "1.4.3",
        "serialNo": "Default Serial Number",
        "firmwareRev": "1.4.3",
        "hardwareRev": "1.4.3",
        "softwareRev": "1.4.3",
        "customMdnsConfig": false,
        "mdnsMulticast": true,
        "mdnsInterface": "",
        "mdnsPort": "",
        "mdnsIp": "",
        "mdnsTtl": "",
        "mdnsLoopback": true,
        "mdnsReuseAddr": true,
        "allowMessagePassthrough": true
    },
    {
        "id": "e3cb7570.0dbb48",
        "type": "shared-state",
        "name": "isNickHome",
        "lbl": "Nick Home",
        "tags": "State, Presence",
        "historyCount": "1",
        "dataType": "bool",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": ""
    },
    {
        "id": "99455ccf.2c8498",
        "type": "shared-state",
        "name": "isCarolineHome",
        "lbl": "Caroline Home",
        "tags": "Presence, State",
        "historyCount": "1",
        "dataType": "bool",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": ""
    },
    {
        "id": "1dd96a4a.9d6316",
        "type": "shared-state",
        "name": "isAnyoneHome",
        "lbl": "Anyone Home",
        "tags": "State,Presence",
        "historyCount": "1",
        "dataType": "bool",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": ""
    },
    {
        "id": "174c278f.609ec8",
        "type": "shared-state",
        "name": "sunevent",
        "lbl": "Sun Event",
        "tags": "Ambient",
        "historyCount": "12",
        "dataType": "str",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": ""
    },
    {
        "id": "b69e9a96.7fc43",
        "type": "shared-state",
        "name": "isMasterAsleep",
        "lbl": "Master Asleep",
        "tags": "State",
        "historyCount": "1",
        "dataType": "bool",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": ""
    },
    {
        "id": "7cd072335f421810",
        "type": "sonos-config",
        "name": "Living Room",
        "serialnum": "",
        "ipaddress": "living-room.sonos.nickborgers.com"
    },
    {
        "id": "eb483a028b06c90a",
        "type": "sonos-config",
        "name": "Master Bathroom",
        "serialnum": "",
        "ipaddress": "master-bath.sonos.nickborgers.com"
    },
    {
        "id": "80cf2bfc253ff8c2",
        "type": "sonos-config",
        "name": "Master Bedroom",
        "serialnum": "",
        "ipaddress": "master-bedroom.sonos.nickborgers.com"
    },
    {
        "id": "047dcd09c592e040",
        "type": "sonos-config",
        "name": "Nook",
        "serialnum": "",
        "ipaddress": "nook.sonos.nickborgers.com"
    },
    {
        "id": "156ccde543ba4845",
        "type": "shared-state",
        "name": "isGuestAsleep",
        "lbl": "Guest Asleep",
        "tags": "",
        "historyCount": "2",
        "dataType": "bool",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": ""
    },
    {
        "id": "659fd61043193a4d",
        "type": "shared-state",
        "name": "musicPlaylistNumbers",
        "lbl": "Music Playlist Numbers",
        "tags": "State,Audio",
        "historyCount": "10",
        "dataType": "obj",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": ""
    },
    {
        "id": "8c211e55da1f4c7f",
        "type": "shared-state",
        "name": "musicPlaybackType",
        "lbl": "Music Playback Type",
        "tags": "State,Audio",
        "historyCount": "10",
        "dataType": "str",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": ""
    },
    {
        "id": "e4f5bf03444063a0",
        "type": "shared-state",
        "name": "musicConfig",
        "lbl": "Music Config",
        "tags": "",
        "historyCount": "0",
        "dataType": "obj",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": ""
    },
    {
        "id": "b74697c734ad5557",
        "type": "shared-state",
        "name": "currentlyPlayingMusic",
        "lbl": "Currently Playing Music",
        "tags": "",
        "historyCount": "2",
        "dataType": "obj",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": ""
    },
    {
        "id": "86b433f8beadaac5",
        "type": "shared-state",
        "name": "hueConfig",
        "lbl": "Hue Config",
        "tags": "",
        "historyCount": "2",
        "dataType": "obj",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": ""
    },
    {
        "id": "60c1725bc2519ee0",
        "type": "shared-state",
        "name": "isEveryoneAsleep",
        "lbl": "Everyone Asleep",
        "tags": "",
        "historyCount": "2",
        "dataType": "bool",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": ""
    },
    {
        "id": "8c8dbb69a0c4c67f",
        "type": "shared-state",
        "name": "isMasterBedroomDoorOpen",
        "lbl": "Is Master Bedroom Door Open?",
        "tags": "",
        "historyCount": "2",
        "dataType": "bool",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": ""
    },
    {
        "id": "3e3052d11dc41010",
        "type": "shared-state",
        "name": "isGuestBedroomDoorOpen",
        "lbl": "Is Guest Bedroom Door Open?",
        "tags": "",
        "historyCount": "2",
        "dataType": "bool",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": ""
    },
    {
        "id": "a5ea3d0a7df352b2",
        "type": "shared-state",
        "name": "isHaveGuests",
        "lbl": "Have Guests?",
        "tags": "",
        "historyCount": "2",
        "dataType": "bool",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": ""
    },
    {
        "id": "3d96ef25996d1dd1",
        "type": "shared-state",
        "name": "reset",
        "lbl": "Reset",
        "tags": "",
        "historyCount": "2",
        "dataType": "num",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": ""
    },
    {
        "id": "3ec50562615a9f50",
        "type": "server",
        "name": "Home Assistant",
        "version": 5,
        "addon": false,
        "rejectUnauthorizedCerts": true,
        "ha_boolean": "y|yes|true|on|home|open",
        "connectionDelay": true,
        "cacheJson": true,
        "heartbeat": false,
        "heartbeatInterval": "30",
        "areaSelector": "friendlyName",
        "deviceSelector": "friendlyName",
        "entitySelector": "friendlyName",
        "statusSeparator": ": ",
        "statusYear": "hidden",
        "statusMonth": "short",
        "statusDay": "numeric",
        "statusHourCycle": "default",
        "statusTimeFormat": "h:m",
        "enableGlobalContextStore": false
    },
    {
        "id": "d9abb6b3441e0c2a",
        "type": "shared-state",
        "name": "isTVPlaying",
        "lbl": "Is TV Playing?",
        "tags": "",
        "historyCount": "1",
        "dataType": "bool",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": ""
    },
    {
        "id": "e498a23d75394b05",
        "type": "shared-state",
        "name": "lastVacuumingTimestamp",
        "lbl": "Last Vaccuming Timestamp",
        "tags": "",
        "historyCount": "4",
        "dataType": "num",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": "s"
    },
    {
        "id": "89337ebbba16965d",
        "type": "ttsultimate-config",
        "name": "TTS Service",
        "noderedipaddress": "AUTODISCOVER",
        "noderedport": "1980",
        "purgediratrestart": "leave",
        "ttsservice": "googletranslate",
        "TTSRootFolderPath": ""
    },
    {
        "id": "440f06b05d48d38b",
        "type": "sonos-config",
        "name": "Guest Bedroom",
        "serialnum": "",
        "ipaddress": "guest-bedroom.sonos.nickborgers.com"
    },
    {
        "id": "efc87f0de00a2d36",
        "type": "shared-state",
        "name": "dayPhase",
        "lbl": "Day Phase",
        "tags": "",
        "historyCount": "12",
        "dataType": "str",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": ""
    },
    {
        "id": "e98cb8b7d7a02f27",
        "type": "log-elk-logger",
        "name": "Elasticsearch",
        "url": "https://10.212.99.6:9200",
        "filename": "log-elk.log",
        "maxsize": "1",
        "maxfiles": "2",
        "logelk": true,
        "logfile": false,
        "logconsole": false,
        "logdebug": false
    },
    {
        "id": "b63f730b24581cdc",
        "type": "miio-roborock-server",
        "name": "Vacuum",
        "ip": "10.212.100.101",
        "polling": "10"
    },
    {
        "id": "9784d6c488d7a77e",
        "type": "shared-state",
        "name": "isTVon",
        "lbl": "Is TV On?",
        "tags": "",
        "historyCount": "2",
        "dataType": "bool",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": ""
    },
    {
        "id": "f4fbefedb919c3c1",
        "type": "shared-state",
        "name": "schedule",
        "lbl": "Schedule",
        "tags": "",
        "historyCount": "2",
        "dataType": "obj",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": ""
    },
    {
        "id": "e1e1553b9b6a27c9",
        "type": "shared-state",
        "name": "isAppleTVPlaying",
        "lbl": "Is Apple TV Playing?",
        "tags": "",
        "historyCount": "2",
        "dataType": "bool",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": ""
    },
    {
        "id": "611761b9dd5c9c4c",
        "type": "shared-state",
        "name": "climateConfig",
        "lbl": "Climate Config",
        "tags": "",
        "historyCount": "1",
        "dataType": "obj",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": ""
    },
    {
        "id": "816d3fb762a92b71",
        "type": "shared-state",
        "name": "humidityOfBedroom",
        "lbl": "Humidity of Bedroom",
        "tags": "",
        "historyCount": "2",
        "dataType": "num",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": ""
    },
    {
        "id": "d19054ef0f693509",
        "type": "shared-state",
        "name": "humidityOfLivingRoomWindow",
        "lbl": "Humidity of Living Room Window",
        "tags": "",
        "historyCount": "2",
        "dataType": "num",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": ""
    },
    {
        "id": "7e0b34e77bae8edb",
        "type": "shared-state",
        "name": "humidityOfLivingRoomCenter",
        "lbl": "Humidity of Living Room Center",
        "tags": "",
        "historyCount": "2",
        "dataType": "num",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": ""
    },
    {
        "id": "51ddddf9304ec19f",
        "type": "shared-state",
        "name": "humidityOfMasterBedroom",
        "lbl": "Humidity of Master Bedroom",
        "tags": "",
        "historyCount": "2",
        "dataType": "num",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": ""
    },
    {
        "id": "4faab2d5448df995",
        "type": "shared-state",
        "name": "temperatureOfMasterBedroom",
        "lbl": "Temperature of Master Bedroom",
        "tags": "",
        "historyCount": "2",
        "dataType": "num",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": "F"
    },
    {
        "id": "098765180c8f29ad",
        "type": "shared-state",
        "name": "temperatureOfLivingRoomCenter",
        "lbl": "Temperature of Living Room Center",
        "tags": "",
        "historyCount": "2",
        "dataType": "num",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": "F"
    },
    {
        "id": "0133e13457d0b692",
        "type": "shared-state",
        "name": "temperatureOfLivingRoomWindow",
        "lbl": "Temperature of Living Room Window",
        "tags": "",
        "historyCount": "2",
        "dataType": "num",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": "F"
    },
    {
        "id": "60f1a7e39e0a4f1c",
        "type": "shared-state",
        "name": "temperatureOfBedroom",
        "lbl": "Temperature of Bedroom",
        "tags": "",
        "historyCount": "2",
        "dataType": "num",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": "F"
    },
    {
        "id": "1ce72a9fb27d8577",
        "type": "shared-state",
        "name": "isHumidifierOn",
        "lbl": "Is Humdifier On?",
        "tags": "",
        "historyCount": "2",
        "dataType": "bool",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": ""
    },
    {
        "id": "26ccc92b36b23b99",
        "type": "shared-state",
        "name": "isAnyoneAsleep",
        "lbl": "Anyone Asleep",
        "tags": "",
        "historyCount": "2",
        "dataType": "bool",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": ""
    },
    {
        "id": "21cd8d0ba24c57ec",
        "type": "shared-state",
        "name": "temperatureOfOutside",
        "lbl": "Temperature Of Outside",
        "tags": "",
        "historyCount": "2",
        "dataType": "num",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": "F"
    },
    {
        "id": "fdd67c92f6cdbe67",
        "type": "shared-state",
        "name": "humidityOfOutside",
        "lbl": "Humditiy of Outside",
        "tags": "",
        "historyCount": "2",
        "dataType": "num",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": ""
    },
    {
        "id": "b7959b8b695cb2e3",
        "type": "shared-state",
        "name": "currentClimate",
        "lbl": "Current Climate",
        "tags": "",
        "historyCount": "2",
        "dataType": "obj",
        "boolType": "bool",
        "boolStrTrue": "",
        "boolStrFalse": "",
        "precision": "",
        "numMin": "",
        "numMax": "",
        "unit": ""
    },
    {
        "id": "ee6f66f1.a3f1d",
        "type": "homekit-service",
        "z": "d7a3510d.e93d98",
        "isParent": true,
        "hostType": "0",
        "bridge": "b2cc5799.eea9d",
        "accessoryId": "",
        "parentService": "",
        "name": "Nick Home",
        "serviceName": "Switch",
        "topic": "",
        "filter": false,
        "manufacturer": "NRCHKB",
        "model": "1.4.3",
        "serialNo": "Default Serial Number",
        "firmwareRev": "1.4.3",
        "hardwareRev": "1.4.3",
        "softwareRev": "1.4.3",
        "cameraConfigVideoProcessor": "ffmpeg",
        "cameraConfigSource": "",
        "cameraConfigStillImageSource": "",
        "cameraConfigMaxStreams": 2,
        "cameraConfigMaxWidth": 1280,
        "cameraConfigMaxHeight": 720,
        "cameraConfigMaxFPS": 10,
        "cameraConfigMaxBitrate": 300,
        "cameraConfigVideoCodec": "libx264",
        "cameraConfigAudioCodec": "libfdk_aac",
        "cameraConfigAudio": false,
        "cameraConfigPacketSize": 1316,
        "cameraConfigVerticalFlip": false,
        "cameraConfigHorizontalFlip": false,
        "cameraConfigMapVideo": "0:0",
        "cameraConfigMapAudio": "0:1",
        "cameraConfigVideoFilter": "scale=1280:720",
        "cameraConfigAdditionalCommandLine": "-tune zerolatency",
        "cameraConfigDebug": false,
        "cameraConfigSnapshotOutput": "disabled",
        "cameraConfigInterfaceName": "",
        "characteristicProperties": "{}",
        "waitForSetupMsg": false,
        "outputs": 2,
        "x": 570,
        "y": 140,
        "wires": [
            [
                "b36f048.1426478"
            ],
            []
        ]
    },
    {
        "id": "e23ac102.8d3f",
        "type": "homekit-service",
        "z": "d7a3510d.e93d98",
        "isParent": true,
        "hostType": "0",
        "bridge": "b2cc5799.eea9d",
        "accessoryId": "",
        "parentService": "",
        "name": "Caroline Home",
        "serviceName": "Switch",
        "topic": "",
        "filter": false,
        "manufacturer": "NRCHKB",
        "model": "1.4.3",
        "serialNo": "Default Serial Number",
        "firmwareRev": "1.4.3",
        "hardwareRev": "1.4.3",
        "softwareRev": "1.4.3",
        "cameraConfigVideoProcessor": "ffmpeg",
        "cameraConfigSource": "",
        "cameraConfigStillImageSource": "",
        "cameraConfigMaxStreams": 2,
        "cameraConfigMaxWidth": 1280,
        "cameraConfigMaxHeight": 720,
        "cameraConfigMaxFPS": 10,
        "cameraConfigMaxBitrate": 300,
        "cameraConfigVideoCodec": "libx264",
        "cameraConfigAudioCodec": "libfdk_aac",
        "cameraConfigAudio": false,
        "cameraConfigPacketSize": 1316,
        "cameraConfigVerticalFlip": false,
        "cameraConfigHorizontalFlip": false,
        "cameraConfigMapVideo": "0:0",
        "cameraConfigMapAudio": "0:1",
        "cameraConfigVideoFilter": "scale=1280:720",
        "cameraConfigAdditionalCommandLine": "-tune zerolatency",
        "cameraConfigDebug": false,
        "cameraConfigSnapshotOutput": "disabled",
        "cameraConfigInterfaceName": "",
        "characteristicProperties": "{}",
        "waitForSetupMsg": false,
        "outputs": 2,
        "x": 580,
        "y": 200,
        "wires": [
            [
                "69314c4a.ac5ad4"
            ],
            []
        ]
    },
    {
        "id": "9460cec7.a8b9e8",
        "type": "set-shared-state",
        "z": "d7a3510d.e93d98",
        "state": "e3cb7570.0dbb48",
        "name": "Nick Home",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 990,
        "y": 140,
        "wires": []
    },
    {
        "id": "b36f048.1426478",
        "type": "change",
        "z": "d7a3510d.e93d98",
        "name": "Move on to value",
        "rules": [
            {
                "t": "move",
                "p": "payload.On",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 790,
        "y": 140,
        "wires": [
            [
                "9460cec7.a8b9e8"
            ]
        ]
    },
    {
        "id": "69314c4a.ac5ad4",
        "type": "change",
        "z": "d7a3510d.e93d98",
        "name": "Move on to value",
        "rules": [
            {
                "t": "move",
                "p": "payload.On",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 790,
        "y": 200,
        "wires": [
            [
                "a413c4b7.cd166"
            ]
        ]
    },
    {
        "id": "a413c4b7.cd166",
        "type": "set-shared-state",
        "z": "d7a3510d.e93d98",
        "state": "99455ccf.2c8498",
        "name": "Caroline Home",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 1000,
        "y": 200,
        "wires": []
    },
    {
        "id": "f06d7079.efbcb8",
        "type": "get-shared-state",
        "z": "d7a3510d.e93d98",
        "state": "99455ccf.2c8498",
        "name": "Caroline Home",
        "triggerOnInit": true,
        "x": 160,
        "y": 300,
        "wires": [
            [
                "8be3694e.cfd798"
            ]
        ]
    },
    {
        "id": "899f1300.9a473",
        "type": "get-shared-state",
        "z": "d7a3510d.e93d98",
        "state": "e3cb7570.0dbb48",
        "name": "Nick Home",
        "triggerOnInit": true,
        "x": 140,
        "y": 360,
        "wires": [
            [
                "8be3694e.cfd798"
            ]
        ]
    },
    {
        "id": "8be3694e.cfd798",
        "type": "function",
        "z": "d7a3510d.e93d98",
        "name": "Are either of us home?",
        "func": "// If either of us are home, someone is home; otherwise neither of us are home\nmsg.payload = global.get(\"state\").isNickHome.value || global.get(\"state\").isCarolineHome.value\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 340,
        "wires": [
            [
                "f1794f1d.551a68"
            ]
        ]
    },
    {
        "id": "f1794f1d.551a68",
        "type": "set-shared-state",
        "z": "d7a3510d.e93d98",
        "state": "1dd96a4a.9d6316",
        "name": "Anyone Home",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 600,
        "y": 340,
        "wires": []
    },
    {
        "id": "2c7e04dc.e42d34",
        "type": "comment",
        "z": "d7a3510d.e93d98",
        "name": "Presence Tracking",
        "info": "",
        "x": 110,
        "y": 40,
        "wires": []
    },
    {
        "id": "8c3e3030.04e5a",
        "type": "comment",
        "z": "d7a3510d.e93d98",
        "name": "Presence Triggers from Homekit",
        "info": "",
        "x": 200,
        "y": 100,
        "wires": []
    },
    {
        "id": "638b4007.2cea98",
        "type": "comment",
        "z": "d7a3510d.e93d98",
        "name": "Manage @home variable",
        "info": "",
        "x": 190,
        "y": 260,
        "wires": []
    },
    {
        "id": "7111de05.4d357",
        "type": "comment",
        "z": "d7a3510d.e93d98",
        "name": "Sleeper Tracking",
        "info": "",
        "x": 100,
        "y": 440,
        "wires": []
    },
    {
        "id": "f0e93991.7ec61",
        "type": "comment",
        "z": "d7a3510d.e93d98",
        "name": "Are masters asleep?",
        "info": "",
        "x": 150,
        "y": 480,
        "wires": []
    },
    {
        "id": "d3ddb03d.1dba08",
        "type": "homekit-service",
        "z": "d7a3510d.e93d98",
        "isParent": true,
        "hostType": "0",
        "bridge": "b2cc5799.eea9d",
        "accessoryId": "",
        "parentService": "",
        "name": "Masters Asleep",
        "serviceName": "Switch",
        "topic": "",
        "filter": false,
        "manufacturer": "NRCHKB",
        "model": "1.4.3",
        "serialNo": "Default Serial Number",
        "firmwareRev": "1.4.3",
        "hardwareRev": "1.4.3",
        "softwareRev": "1.4.3",
        "cameraConfigVideoProcessor": "ffmpeg",
        "cameraConfigSource": "",
        "cameraConfigStillImageSource": "",
        "cameraConfigMaxStreams": 2,
        "cameraConfigMaxWidth": 1280,
        "cameraConfigMaxHeight": 720,
        "cameraConfigMaxFPS": 10,
        "cameraConfigMaxBitrate": 300,
        "cameraConfigVideoCodec": "libx264",
        "cameraConfigAudioCodec": "libfdk_aac",
        "cameraConfigAudio": false,
        "cameraConfigPacketSize": 1316,
        "cameraConfigVerticalFlip": false,
        "cameraConfigHorizontalFlip": false,
        "cameraConfigMapVideo": "0:0",
        "cameraConfigMapAudio": "0:1",
        "cameraConfigVideoFilter": "scale=1280:720",
        "cameraConfigAdditionalCommandLine": "-tune zerolatency",
        "cameraConfigDebug": false,
        "cameraConfigSnapshotOutput": "disabled",
        "cameraConfigInterfaceName": "",
        "characteristicProperties": "{}",
        "waitForSetupMsg": false,
        "outputs": 2,
        "x": 560,
        "y": 520,
        "wires": [
            [
                "d235bec0.ec595"
            ],
            []
        ]
    },
    {
        "id": "d235bec0.ec595",
        "type": "change",
        "z": "d7a3510d.e93d98",
        "name": "Move on to value",
        "rules": [
            {
                "t": "move",
                "p": "payload.On",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 770,
        "y": 520,
        "wires": [
            [
                "df524162.b52ae8"
            ]
        ]
    },
    {
        "id": "df524162.b52ae8",
        "type": "set-shared-state",
        "z": "d7a3510d.e93d98",
        "state": "b69e9a96.7fc43",
        "name": "Master Asleep",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 960,
        "y": 520,
        "wires": []
    },
    {
        "id": "5d4ad8acbf758ea3",
        "type": "comment",
        "z": "d7a3510d.e93d98",
        "name": "Are Guests Asleep?",
        "info": "",
        "x": 150,
        "y": 600,
        "wires": []
    },
    {
        "id": "74b1e4364e7efcf2",
        "type": "set-shared-state",
        "z": "d7a3510d.e93d98",
        "state": "156ccde543ba4845",
        "name": "Guest Asleep",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 960,
        "y": 660,
        "wires": []
    },
    {
        "id": "4d2643c154b00b0a",
        "type": "get-shared-state",
        "z": "d7a3510d.e93d98",
        "state": "99455ccf.2c8498",
        "name": "Caroline Home",
        "triggerOnInit": true,
        "x": 160,
        "y": 200,
        "wires": [
            [
                "9394ca10e90da60a"
            ]
        ]
    },
    {
        "id": "9394ca10e90da60a",
        "type": "change",
        "z": "d7a3510d.e93d98",
        "name": "Move value to On",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "payload.On",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 370,
        "y": 200,
        "wires": [
            [
                "e23ac102.8d3f"
            ]
        ]
    },
    {
        "id": "3b2d7059456eab23",
        "type": "get-shared-state",
        "z": "d7a3510d.e93d98",
        "state": "e3cb7570.0dbb48",
        "name": "Nick Home",
        "triggerOnInit": true,
        "x": 140,
        "y": 140,
        "wires": [
            [
                "467d34c94ce60834"
            ]
        ]
    },
    {
        "id": "467d34c94ce60834",
        "type": "change",
        "z": "d7a3510d.e93d98",
        "name": "Move value to On",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "payload.On",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 370,
        "y": 140,
        "wires": [
            [
                "ee6f66f1.a3f1d"
            ]
        ]
    },
    {
        "id": "3bcef5f89ded8641",
        "type": "get-shared-state",
        "z": "d7a3510d.e93d98",
        "state": "b69e9a96.7fc43",
        "name": "Master Asleep",
        "triggerOnInit": true,
        "x": 150,
        "y": 520,
        "wires": [
            [
                "494477a5e37d3abe"
            ]
        ]
    },
    {
        "id": "494477a5e37d3abe",
        "type": "change",
        "z": "d7a3510d.e93d98",
        "name": "Move value to On",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "payload.On",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 350,
        "y": 520,
        "wires": [
            [
                "d3ddb03d.1dba08"
            ]
        ]
    },
    {
        "id": "04cec9c3f2834033",
        "type": "homekit-service",
        "z": "d7a3510d.e93d98",
        "isParent": true,
        "hostType": "0",
        "bridge": "b2cc5799.eea9d",
        "accessoryId": "",
        "parentService": "",
        "name": "Master Bedroom Door Open",
        "serviceName": "Switch",
        "topic": "",
        "filter": false,
        "manufacturer": "NRCHKB",
        "model": "1.4.3",
        "serialNo": "Default Serial Number",
        "firmwareRev": "1.4.3",
        "hardwareRev": "1.4.3",
        "softwareRev": "1.4.3",
        "cameraConfigVideoProcessor": "ffmpeg",
        "cameraConfigSource": "",
        "cameraConfigStillImageSource": "",
        "cameraConfigMaxStreams": 2,
        "cameraConfigMaxWidth": 1280,
        "cameraConfigMaxHeight": 720,
        "cameraConfigMaxFPS": 10,
        "cameraConfigMaxBitrate": 300,
        "cameraConfigVideoCodec": "libx264",
        "cameraConfigAudioCodec": "libfdk_aac",
        "cameraConfigAudio": false,
        "cameraConfigPacketSize": 1316,
        "cameraConfigVerticalFlip": false,
        "cameraConfigHorizontalFlip": false,
        "cameraConfigMapVideo": "0:0",
        "cameraConfigMapAudio": "0:1",
        "cameraConfigVideoFilter": "scale=1280:720",
        "cameraConfigAdditionalCommandLine": "-tune zerolatency",
        "cameraConfigDebug": false,
        "cameraConfigSnapshotOutput": "disabled",
        "cameraConfigInterfaceName": "",
        "characteristicProperties": "{}",
        "waitForSetupMsg": false,
        "outputs": 2,
        "x": 200,
        "y": 1080,
        "wires": [
            [
                "92a787a17e5a68cc"
            ],
            []
        ]
    },
    {
        "id": "394af9bb2a153a77",
        "type": "homekit-service",
        "z": "d7a3510d.e93d98",
        "isParent": true,
        "hostType": "0",
        "bridge": "b2cc5799.eea9d",
        "accessoryId": "",
        "parentService": "",
        "name": "Guest Bedroom Door State",
        "serviceName": "Switch",
        "topic": "",
        "filter": false,
        "manufacturer": "NRCHKB",
        "model": "1.4.3",
        "serialNo": "Default Serial Number",
        "firmwareRev": "1.4.3",
        "hardwareRev": "1.4.3",
        "softwareRev": "1.4.3",
        "cameraConfigVideoProcessor": "ffmpeg",
        "cameraConfigSource": "",
        "cameraConfigStillImageSource": "",
        "cameraConfigMaxStreams": 2,
        "cameraConfigMaxWidth": 1280,
        "cameraConfigMaxHeight": 720,
        "cameraConfigMaxFPS": 10,
        "cameraConfigMaxBitrate": 300,
        "cameraConfigVideoCodec": "libx264",
        "cameraConfigAudioCodec": "libfdk_aac",
        "cameraConfigAudio": false,
        "cameraConfigPacketSize": 1316,
        "cameraConfigVerticalFlip": false,
        "cameraConfigHorizontalFlip": false,
        "cameraConfigMapVideo": "0:0",
        "cameraConfigMapAudio": "0:1",
        "cameraConfigVideoFilter": "scale=1280:720",
        "cameraConfigAdditionalCommandLine": "-tune zerolatency",
        "cameraConfigDebug": false,
        "cameraConfigSnapshotOutput": "disabled",
        "cameraConfigInterfaceName": "",
        "characteristicProperties": "{}",
        "waitForSetupMsg": false,
        "outputs": 2,
        "x": 200,
        "y": 1140,
        "wires": [
            [
                "38b97ca236e8163d"
            ],
            []
        ]
    },
    {
        "id": "b9496f0c3ed2fd10",
        "type": "homekit-service",
        "z": "d7a3510d.e93d98",
        "isParent": true,
        "hostType": "0",
        "bridge": "b2cc5799.eea9d",
        "accessoryId": "",
        "parentService": "",
        "name": "Guest Asleep",
        "serviceName": "Switch",
        "topic": "",
        "filter": false,
        "manufacturer": "NRCHKB",
        "model": "1.4.3",
        "serialNo": "Default Serial Number",
        "firmwareRev": "1.4.3",
        "hardwareRev": "1.4.3",
        "softwareRev": "1.4.3",
        "cameraConfigVideoProcessor": "ffmpeg",
        "cameraConfigSource": "",
        "cameraConfigStillImageSource": "",
        "cameraConfigMaxStreams": 2,
        "cameraConfigMaxWidth": 1280,
        "cameraConfigMaxHeight": 720,
        "cameraConfigMaxFPS": 10,
        "cameraConfigMaxBitrate": 300,
        "cameraConfigVideoCodec": "libx264",
        "cameraConfigAudioCodec": "libfdk_aac",
        "cameraConfigAudio": false,
        "cameraConfigPacketSize": 1316,
        "cameraConfigVerticalFlip": false,
        "cameraConfigHorizontalFlip": false,
        "cameraConfigMapVideo": "0:0",
        "cameraConfigMapAudio": "0:1",
        "cameraConfigVideoFilter": "scale=1280:720",
        "cameraConfigAdditionalCommandLine": "-tune zerolatency",
        "cameraConfigDebug": false,
        "cameraConfigSnapshotOutput": "disabled",
        "cameraConfigInterfaceName": "",
        "characteristicProperties": "{}",
        "waitForSetupMsg": false,
        "outputs": 2,
        "x": 560,
        "y": 660,
        "wires": [
            [
                "07d850c58997c540"
            ],
            []
        ]
    },
    {
        "id": "6dd5f9bf57603ff8",
        "type": "set-shared-state",
        "z": "d7a3510d.e93d98",
        "state": "60c1725bc2519ee0",
        "name": "Everyone Asleep",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 610,
        "y": 800,
        "wires": []
    },
    {
        "id": "bd78e51ac972145a",
        "type": "comment",
        "z": "d7a3510d.e93d98",
        "name": "Manage Asleep variable",
        "info": "",
        "x": 160,
        "y": 720,
        "wires": []
    },
    {
        "id": "909071c9eb13c82c",
        "type": "get-shared-state",
        "z": "d7a3510d.e93d98",
        "state": "b69e9a96.7fc43",
        "name": "Master Asleep",
        "triggerOnInit": true,
        "x": 150,
        "y": 780,
        "wires": [
            [
                "ca90adbe07cc8c51"
            ]
        ]
    },
    {
        "id": "1d1bf915a3307b0c",
        "type": "get-shared-state",
        "z": "d7a3510d.e93d98",
        "state": "156ccde543ba4845",
        "name": "Guest Asleep",
        "triggerOnInit": true,
        "x": 150,
        "y": 840,
        "wires": [
            [
                "ca90adbe07cc8c51"
            ]
        ]
    },
    {
        "id": "ca90adbe07cc8c51",
        "type": "function",
        "z": "d7a3510d.e93d98",
        "name": "Is everyone asleep?",
        "func": "// If everyone is asleep true otherwise false\nmsg.payload = global.get(\"state\").isMasterAsleep.value && global.get(\"state\").isGuestAsleep.value\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 800,
        "wires": [
            [
                "6dd5f9bf57603ff8"
            ]
        ]
    },
    {
        "id": "3d5eef3f9864a2fa",
        "type": "comment",
        "z": "d7a3510d.e93d98",
        "name": "Door Tracking",
        "info": "",
        "x": 130,
        "y": 1020,
        "wires": []
    },
    {
        "id": "92a787a17e5a68cc",
        "type": "change",
        "z": "d7a3510d.e93d98",
        "name": "Move on to value",
        "rules": [
            {
                "t": "move",
                "p": "payload.On",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 450,
        "y": 1080,
        "wires": [
            [
                "74c36bd307050540"
            ]
        ]
    },
    {
        "id": "07d850c58997c540",
        "type": "change",
        "z": "d7a3510d.e93d98",
        "name": "Move on to value",
        "rules": [
            {
                "t": "move",
                "p": "payload.On",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 770,
        "y": 660,
        "wires": [
            [
                "74b1e4364e7efcf2"
            ]
        ]
    },
    {
        "id": "05ac5235e80b464e",
        "type": "change",
        "z": "d7a3510d.e93d98",
        "name": "Move value to On",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "payload.On",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 350,
        "y": 660,
        "wires": [
            [
                "b9496f0c3ed2fd10"
            ]
        ]
    },
    {
        "id": "21c335cc7ba24c56",
        "type": "get-shared-state",
        "z": "d7a3510d.e93d98",
        "state": "156ccde543ba4845",
        "name": "Guest Asleep",
        "triggerOnInit": true,
        "x": 150,
        "y": 660,
        "wires": [
            [
                "05ac5235e80b464e"
            ]
        ]
    },
    {
        "id": "74c36bd307050540",
        "type": "set-shared-state",
        "z": "d7a3510d.e93d98",
        "state": "8c8dbb69a0c4c67f",
        "name": "Is Master Bedroom Door Open?",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 710,
        "y": 1080,
        "wires": []
    },
    {
        "id": "38b97ca236e8163d",
        "type": "change",
        "z": "d7a3510d.e93d98",
        "name": "Move on to value",
        "rules": [
            {
                "t": "move",
                "p": "payload.On",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 450,
        "y": 1140,
        "wires": [
            [
                "19ef2aa0c73641ce"
            ]
        ]
    },
    {
        "id": "19ef2aa0c73641ce",
        "type": "set-shared-state",
        "z": "d7a3510d.e93d98",
        "state": "3e3052d11dc41010",
        "name": "Is Guest Bedroom Door Open?",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 710,
        "y": 1140,
        "wires": []
    },
    {
        "id": "33941ae1433a1b4e",
        "type": "homekit-service",
        "z": "d7a3510d.e93d98",
        "isParent": true,
        "hostType": "0",
        "bridge": "b2cc5799.eea9d",
        "accessoryId": "",
        "parentService": "",
        "name": "Have Guests",
        "serviceName": "Switch",
        "topic": "",
        "filter": false,
        "manufacturer": "NRCHKB",
        "model": "1.4.3",
        "serialNo": "Default Serial Number",
        "firmwareRev": "1.4.3",
        "hardwareRev": "1.4.3",
        "softwareRev": "1.4.3",
        "cameraConfigVideoProcessor": "ffmpeg",
        "cameraConfigSource": "",
        "cameraConfigStillImageSource": "",
        "cameraConfigMaxStreams": 2,
        "cameraConfigMaxWidth": 1280,
        "cameraConfigMaxHeight": 720,
        "cameraConfigMaxFPS": 10,
        "cameraConfigMaxBitrate": 300,
        "cameraConfigVideoCodec": "libx264",
        "cameraConfigAudioCodec": "libfdk_aac",
        "cameraConfigAudio": false,
        "cameraConfigPacketSize": 1316,
        "cameraConfigVerticalFlip": false,
        "cameraConfigHorizontalFlip": false,
        "cameraConfigMapVideo": "0:0",
        "cameraConfigMapAudio": "0:1",
        "cameraConfigVideoFilter": "scale=1280:720",
        "cameraConfigAdditionalCommandLine": "-tune zerolatency",
        "cameraConfigDebug": false,
        "cameraConfigSnapshotOutput": "disabled",
        "cameraConfigInterfaceName": "",
        "characteristicProperties": "{}",
        "waitForSetupMsg": false,
        "outputs": 2,
        "x": 550,
        "y": 1280,
        "wires": [
            [
                "ef38dc46cc944eaf"
            ],
            []
        ]
    },
    {
        "id": "ad2b0d5d23831af5",
        "type": "set-shared-state",
        "z": "d7a3510d.e93d98",
        "state": "a5ea3d0a7df352b2",
        "name": "Have Guests?",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 940,
        "y": 1280,
        "wires": []
    },
    {
        "id": "ef38dc46cc944eaf",
        "type": "change",
        "z": "d7a3510d.e93d98",
        "name": "Move on to value",
        "rules": [
            {
                "t": "move",
                "p": "payload.On",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 750,
        "y": 1280,
        "wires": [
            [
                "ad2b0d5d23831af5"
            ]
        ]
    },
    {
        "id": "18b1ebcd18d0855c",
        "type": "change",
        "z": "d7a3510d.e93d98",
        "name": "Move value to On",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "payload.On",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 350,
        "y": 1280,
        "wires": [
            [
                "33941ae1433a1b4e"
            ]
        ]
    },
    {
        "id": "8d006bf9909b6636",
        "type": "get-shared-state",
        "z": "d7a3510d.e93d98",
        "state": "a5ea3d0a7df352b2",
        "name": "Have Guests?",
        "triggerOnInit": true,
        "x": 150,
        "y": 1280,
        "wires": [
            [
                "18b1ebcd18d0855c"
            ]
        ]
    },
    {
        "id": "45fde91860361e14",
        "type": "comment",
        "z": "d7a3510d.e93d98",
        "name": "Have Guests",
        "info": "",
        "x": 130,
        "y": 1220,
        "wires": []
    },
    {
        "id": "f1aab11be0de5020",
        "type": "comment",
        "z": "d7a3510d.e93d98",
        "name": "Sleep Detection",
        "info": "",
        "x": 140,
        "y": 1360,
        "wires": []
    },
    {
        "id": "a3b3ee64f48787b9",
        "type": "function",
        "z": "d7a3510d.e93d98",
        "name": "Applicability Checks",
        "func": "// Check if anyone is home\nif(global.get(\"state\").isAnyoneHome.value == false) {\n    return null\n}\n// Check if guests currently considered asleep\nif(global.get(\"state\").isGuestAsleep.value) {\n    // They are, nothing to change here\n    return null\n}\n// Do we even have a guest right now?\nif(global.get(\"state\").isHaveGuests.value == false) {\n    // Nope! stop doing this\n    return null\n}\n// Didn't disqualify this, it's what we were waiting for\nreturn msg",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 500,
        "y": 1400,
        "wires": [
            [
                "823d1203f1396da2"
            ]
        ]
    },
    {
        "id": "6748f17a07e44567",
        "type": "set-shared-state",
        "z": "d7a3510d.e93d98",
        "state": "156ccde543ba4845",
        "name": "Guest Asleep",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 860,
        "y": 1400,
        "wires": []
    },
    {
        "id": "c6a29d3ee318916f",
        "type": "comment",
        "z": "d7a3510d.e93d98",
        "name": "Wake Detection",
        "info": "",
        "x": 140,
        "y": 1540,
        "wires": []
    },
    {
        "id": "305a7e035256ae31",
        "type": "get-shared-state",
        "z": "d7a3510d.e93d98",
        "state": "8c8dbb69a0c4c67f",
        "name": "Is Master Bedroom Door Open?",
        "triggerOnInit": false,
        "x": 210,
        "y": 1580,
        "wires": [
            [
                "e308dfc1c82afa45"
            ]
        ]
    },
    {
        "id": "206aa2d74e27096a",
        "type": "set-shared-state",
        "z": "d7a3510d.e93d98",
        "state": "b69e9a96.7fc43",
        "name": "Master Asleep",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 700,
        "y": 1580,
        "wires": []
    },
    {
        "id": "c8c2e4225d27f8bb",
        "type": "get-shared-state",
        "z": "d7a3510d.e93d98",
        "state": "3e3052d11dc41010",
        "name": "Is Guest Bedroom Door Open?",
        "triggerOnInit": false,
        "x": 210,
        "y": 1640,
        "wires": [
            [
                "21aa277aaf073eb4"
            ]
        ]
    },
    {
        "id": "940899f761329f39",
        "type": "set-shared-state",
        "z": "d7a3510d.e93d98",
        "state": "156ccde543ba4845",
        "name": "Guest Asleep",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 700,
        "y": 1640,
        "wires": []
    },
    {
        "id": "697bee2d0b291c02",
        "type": "get-shared-state",
        "z": "d7a3510d.e93d98",
        "state": "a5ea3d0a7df352b2",
        "name": "Have Guests?",
        "triggerOnInit": true,
        "x": 830,
        "y": 820,
        "wires": [
            [
                "0e3907f2e4812720"
            ]
        ]
    },
    {
        "id": "020b3295fb0fa526",
        "type": "comment",
        "z": "d7a3510d.e93d98",
        "name": "If we don't have guests, they're asleep if master is asleep",
        "info": "",
        "x": 970,
        "y": 760,
        "wires": []
    },
    {
        "id": "0e3907f2e4812720",
        "type": "function",
        "z": "d7a3510d.e93d98",
        "name": "Do we have guests?",
        "func": "// If we don't have guests, their asleep status should match master\nif (global.get(\"state\").isHaveGuests.value == false) {\n    msg.payload = global.get(\"state\").isMasterAsleep.value\n    return msg;\n}\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1040,
        "y": 840,
        "wires": [
            [
                "d51c49cc4596b1df"
            ]
        ]
    },
    {
        "id": "d51c49cc4596b1df",
        "type": "set-shared-state",
        "z": "d7a3510d.e93d98",
        "state": "156ccde543ba4845",
        "name": "Guest Asleep",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 1260,
        "y": 840,
        "wires": []
    },
    {
        "id": "f36ec6cadd9d9633",
        "type": "server-state-changed",
        "z": "d7a3510d.e93d98",
        "name": "Guest Bedroom Lamp Off for 1 minute",
        "server": "3ec50562615a9f50",
        "version": 4,
        "exposeToHomeAssistant": false,
        "haConfig": [
            {
                "property": "name",
                "value": ""
            },
            {
                "property": "icon",
                "value": ""
            }
        ],
        "entityidfilter": "light.guest_bedroom_lamp",
        "entityidfiltertype": "exact",
        "outputinitially": false,
        "state_type": "str",
        "haltifstate": "off",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "outputs": 2,
        "output_only_on_state_change": true,
        "for": "1",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 230,
        "y": 1400,
        "wires": [
            [
                "a3b3ee64f48787b9"
            ],
            []
        ]
    },
    {
        "id": "823d1203f1396da2",
        "type": "change",
        "z": "d7a3510d.e93d98",
        "name": "Set to True",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "true",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 690,
        "y": 1400,
        "wires": [
            [
                "6748f17a07e44567"
            ]
        ]
    },
    {
        "id": "c2d2df4417b94c03",
        "type": "server-state-changed",
        "z": "d7a3510d.e93d98",
        "name": "Guest Bedroom Lamp On for 1 minute",
        "server": "3ec50562615a9f50",
        "version": 4,
        "exposeToHomeAssistant": false,
        "haConfig": [
            {
                "property": "name",
                "value": ""
            },
            {
                "property": "icon",
                "value": ""
            }
        ],
        "entityidfilter": "light.guest_bedroom_lamp",
        "entityidfiltertype": "exact",
        "outputinitially": false,
        "state_type": "str",
        "haltifstate": "on",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "outputs": 2,
        "output_only_on_state_change": true,
        "for": "50",
        "forType": "num",
        "forUnits": "seconds",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 230,
        "y": 1700,
        "wires": [
            [
                "af1017d8f0817bec"
            ],
            []
        ]
    },
    {
        "id": "de691be683f352ac",
        "type": "set-shared-state",
        "z": "d7a3510d.e93d98",
        "state": "156ccde543ba4845",
        "name": "Guest Asleep",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 640,
        "y": 1700,
        "wires": []
    },
    {
        "id": "21aa277aaf073eb4",
        "type": "trigger",
        "z": "d7a3510d.e93d98",
        "name": "If stays true for 20 seconds",
        "op1": "",
        "op2": "false",
        "op1type": "nul",
        "op2type": "bool",
        "duration": "20",
        "extend": false,
        "overrideDelay": false,
        "units": "s",
        "reset": "false",
        "bytopic": "all",
        "topic": "topic",
        "outputs": 1,
        "x": 480,
        "y": 1640,
        "wires": [
            [
                "940899f761329f39"
            ]
        ]
    },
    {
        "id": "e308dfc1c82afa45",
        "type": "trigger",
        "z": "d7a3510d.e93d98",
        "name": "If stays true for 20 seconds",
        "op1": "",
        "op2": "false",
        "op1type": "nul",
        "op2type": "bool",
        "duration": "20",
        "extend": false,
        "overrideDelay": false,
        "units": "s",
        "reset": "false",
        "bytopic": "all",
        "topic": "topic",
        "outputs": 1,
        "x": 480,
        "y": 1580,
        "wires": [
            [
                "206aa2d74e27096a"
            ]
        ]
    },
    {
        "id": "af1017d8f0817bec",
        "type": "change",
        "z": "d7a3510d.e93d98",
        "name": "Set to False",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "false",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 470,
        "y": 1700,
        "wires": [
            [
                "de691be683f352ac"
            ]
        ]
    },
    {
        "id": "24dfbaf0a5f808fa",
        "type": "get-shared-state",
        "z": "d7a3510d.e93d98",
        "state": "b69e9a96.7fc43",
        "name": "Master Asleep",
        "triggerOnInit": true,
        "x": 830,
        "y": 880,
        "wires": [
            [
                "0e3907f2e4812720"
            ]
        ]
    },
    {
        "id": "e0fd4f80910687d8",
        "type": "function",
        "z": "d7a3510d.e93d98",
        "name": "Applicability Checks",
        "func": "// Check if anyone is home\nif(global.get(\"state\").isAnyoneHome.value == false) {\n    return null\n}\n// Check if guests currently considered asleep\nif(global.get(\"state\").isMasterAsleep.value) {\n    // They are, nothing to change here\n    return null\n}\n// Didn't disqualify this, it's what we were waiting for\nreturn msg",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 500,
        "y": 1460,
        "wires": [
            [
                "8d97a2e3e664cd5b"
            ]
        ]
    },
    {
        "id": "bef7d2e0ab4b73d9",
        "type": "set-shared-state",
        "z": "d7a3510d.e93d98",
        "state": "b69e9a96.7fc43",
        "name": "Master Asleep",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 860,
        "y": 1460,
        "wires": []
    },
    {
        "id": "b6021d4b501820ac",
        "type": "server-state-changed",
        "z": "d7a3510d.e93d98",
        "name": "Master Bedroom Lights Off for 1 minute",
        "server": "3ec50562615a9f50",
        "version": 4,
        "exposeToHomeAssistant": false,
        "haConfig": [
            {
                "property": "name",
                "value": ""
            },
            {
                "property": "icon",
                "value": ""
            }
        ],
        "entityidfilter": "light.master_bedroom",
        "entityidfiltertype": "exact",
        "outputinitially": false,
        "state_type": "str",
        "haltifstate": "off",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "outputs": 2,
        "output_only_on_state_change": true,
        "for": "1",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 230,
        "y": 1460,
        "wires": [
            [
                "e0fd4f80910687d8"
            ],
            []
        ]
    },
    {
        "id": "8d97a2e3e664cd5b",
        "type": "change",
        "z": "d7a3510d.e93d98",
        "name": "Set to True",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "true",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 690,
        "y": 1460,
        "wires": [
            [
                "bef7d2e0ab4b73d9"
            ]
        ]
    },
    {
        "id": "05dba22067da7be4",
        "type": "get-shared-state",
        "z": "d7a3510d.e93d98",
        "state": "156ccde543ba4845",
        "name": "Guest Asleep",
        "triggerOnInit": true,
        "x": 830,
        "y": 940,
        "wires": [
            [
                "0e3907f2e4812720"
            ]
        ]
    },
    {
        "id": "4db9c19db8e3a4e7",
        "type": "set-shared-state",
        "z": "d7a3510d.e93d98",
        "state": "26ccc92b36b23b99",
        "name": "Anyone Asleep",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 600,
        "y": 920,
        "wires": []
    },
    {
        "id": "f0278e0c734507b0",
        "type": "get-shared-state",
        "z": "d7a3510d.e93d98",
        "state": "b69e9a96.7fc43",
        "name": "Master Asleep",
        "triggerOnInit": true,
        "x": 150,
        "y": 900,
        "wires": [
            [
                "acdaab9da7d03657"
            ]
        ]
    },
    {
        "id": "76d76502f760e0ad",
        "type": "get-shared-state",
        "z": "d7a3510d.e93d98",
        "state": "156ccde543ba4845",
        "name": "Guest Asleep",
        "triggerOnInit": true,
        "x": 150,
        "y": 960,
        "wires": [
            [
                "acdaab9da7d03657"
            ]
        ]
    },
    {
        "id": "acdaab9da7d03657",
        "type": "function",
        "z": "d7a3510d.e93d98",
        "name": "Is anyone asleep?",
        "func": "// If anyone is asleep true otherwise false\nmsg.payload = global.get(\"state\").isMasterAsleep.value || global.get(\"state\").isGuestAsleep.value\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 370,
        "y": 920,
        "wires": [
            [
                "4db9c19db8e3a4e7"
            ]
        ]
    },
    {
        "id": "f98f511841b27c8c",
        "type": "comment",
        "z": "634c78c80eb9f37e",
        "name": "Configurations",
        "info": "",
        "x": 120,
        "y": 40,
        "wires": []
    },
    {
        "id": "f991b8b5b5f73fde",
        "type": "exec",
        "z": "634c78c80eb9f37e",
        "command": "cd /data/projects/node-red/ && GIT_SSH_COMMAND='ssh -i ../.sshkeys/__default_NickBorgersOnLowSecurityNode -o IdentitiesOnly=yes' git pull",
        "addpay": "",
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "winHide": false,
        "oldrc": false,
        "name": "Pull latest config",
        "x": 340,
        "y": 100,
        "wires": [
            [
                "a78b91dcc37bee92",
                "8409a48850c82e37",
                "03d49e6e6a6a882d",
                "c0e040aaba90066e"
            ],
            [],
            []
        ]
    },
    {
        "id": "a78b91dcc37bee92",
        "type": "file in",
        "z": "634c78c80eb9f37e",
        "name": "Read music config file",
        "filename": "/data/projects/node-red/configs/music_config.yaml",
        "format": "utf8",
        "chunk": false,
        "sendError": false,
        "encoding": "utf8",
        "allProps": false,
        "x": 620,
        "y": 100,
        "wires": [
            [
                "1e97b7b783f670f6"
            ]
        ]
    },
    {
        "id": "1e97b7b783f670f6",
        "type": "yaml",
        "z": "634c78c80eb9f37e",
        "property": "payload",
        "name": "Convert to JSON",
        "x": 870,
        "y": 100,
        "wires": [
            [
                "ca1cb228dbf5cd0e"
            ]
        ]
    },
    {
        "id": "6b334e0185781b32",
        "type": "inject",
        "z": "634c78c80eb9f37e",
        "name": "Force refresh",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 350,
        "y": 40,
        "wires": [
            [
                "f991b8b5b5f73fde",
                "03d49e6e6a6a882d"
            ]
        ]
    },
    {
        "id": "ca1cb228dbf5cd0e",
        "type": "set-shared-state",
        "z": "634c78c80eb9f37e",
        "state": "e4f5bf03444063a0",
        "name": "Music Config",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 1070,
        "y": 100,
        "wires": []
    },
    {
        "id": "8409a48850c82e37",
        "type": "file in",
        "z": "634c78c80eb9f37e",
        "name": "Read Hue config file",
        "filename": "/data/projects/node-red/configs/hue_config.yaml",
        "format": "utf8",
        "chunk": false,
        "sendError": false,
        "encoding": "utf8",
        "allProps": false,
        "x": 180,
        "y": 220,
        "wires": [
            [
                "08d6acf51e6f0e15"
            ]
        ]
    },
    {
        "id": "08d6acf51e6f0e15",
        "type": "yaml",
        "z": "634c78c80eb9f37e",
        "property": "payload",
        "name": "Convert to JSON",
        "x": 430,
        "y": 220,
        "wires": [
            [
                "3073aace89faf61f"
            ]
        ]
    },
    {
        "id": "3073aace89faf61f",
        "type": "set-shared-state",
        "z": "634c78c80eb9f37e",
        "state": "86b433f8beadaac5",
        "name": "Hue Config",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 630,
        "y": 220,
        "wires": []
    },
    {
        "id": "09657a19ee07783e",
        "type": "set-shared-state",
        "z": "634c78c80eb9f37e",
        "state": "174c278f.609ec8",
        "name": "Sun Event",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 1370,
        "y": 340,
        "wires": []
    },
    {
        "id": "7939e475c30ab6f5",
        "type": "inject",
        "z": "634c78c80eb9f37e",
        "name": "Manually set to Night",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "night",
        "payloadType": "str",
        "x": 1200,
        "y": 400,
        "wires": [
            [
                "09657a19ee07783e"
            ]
        ]
    },
    {
        "id": "4f14558e96091d5d",
        "type": "inject",
        "z": "634c78c80eb9f37e",
        "name": "Manually set to Dusk",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "dusk",
        "payloadType": "str",
        "x": 940,
        "y": 400,
        "wires": [
            [
                "09657a19ee07783e"
            ]
        ]
    },
    {
        "id": "271909a69a880cd1",
        "type": "inject",
        "z": "634c78c80eb9f37e",
        "name": "Manually set to Sunset",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "sunset",
        "payloadType": "str",
        "x": 680,
        "y": 400,
        "wires": [
            [
                "09657a19ee07783e"
            ]
        ]
    },
    {
        "id": "f826979d9173e4f6",
        "type": "function",
        "z": "634c78c80eb9f37e",
        "name": "Sun State Summarizer",
        "func": "// If sunset\nif (\n    msg.payload.sunevent == \"goldenHour\" ||\n    msg.payload.sunevent == \"sunsetStart\" ||\n    msg.payload.sunevent == \"sunset\"\n  ) {\n    // output true\n    msg.payload = \"sunset\"\n}\n// If dusk\nelse if (\n    msg.payload.sunevent == \"dusk\" ||\n    msg.payload.sunevent == \"nauticalDusk\"\n  ) {\n    // output true\n    msg.payload = \"dusk\"\n}\n// If night\nelse if (\n    msg.payload.sunevent == \"night\" ||\n    msg.payload.sunevent == \"nightEnd\" ||\n    msg.payload.sunevent == \"nauticalDawn\" ||\n    msg.payload.sunevent == \"dawn\" ||\n    msg.payload.sunevent == \"nadir\"\n  ) {\n    // output true\n    msg.payload = \"night\"\n}\n// If morning\nelse if (\n    msg.payload.sunevent == \"sunrise\" ||\n    msg.payload.sunevent == \"sunriseEnd\" ||\n    msg.payload.sunevent == \"goldenHourEnd\"\n  ) {\n    // output true\n    msg.payload = \"morning\"\n}\n// If it's not morning, sunset, dusk, or night; assume it's day\nelse {\n    msg.payload = \"day\"\n}\n\n// Check if this is new, if it is send it\nif (global.get(\"state\").sunevent.value != msg.payload) {\n    return msg\n}\nreturn null",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 700,
        "y": 340,
        "wires": [
            [
                "09657a19ee07783e"
            ]
        ]
    },
    {
        "id": "cc1b28fa3ee72e9b",
        "type": "inject",
        "z": "634c78c80eb9f37e",
        "name": "Manually set to Day",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "day",
        "payloadType": "str",
        "x": 430,
        "y": 400,
        "wires": [
            [
                "09657a19ee07783e"
            ]
        ]
    },
    {
        "id": "60f3d3f665e7ea46",
        "type": "sun events",
        "z": "634c78c80eb9f37e",
        "testmode": false,
        "verbose": "N",
        "topic": "",
        "name": "Sun State Reporter",
        "x": 470,
        "y": 340,
        "wires": [
            [
                "f826979d9173e4f6"
            ]
        ]
    },
    {
        "id": "a230628c753abd65",
        "type": "inject",
        "z": "634c78c80eb9f37e",
        "name": "Manually set to Morn",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "morning",
        "payloadType": "str",
        "x": 160,
        "y": 400,
        "wires": [
            [
                "09657a19ee07783e"
            ]
        ]
    },
    {
        "id": "38a0f923f2d7e97e",
        "type": "inject",
        "z": "634c78c80eb9f37e",
        "name": "Inject Coordinates for Sun Events",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "21600",
        "crontab": "",
        "once": true,
        "onceDelay": "0.0",
        "topic": "",
        "payload": "{\"latitude\": 40.76, \"longitude\": -80}",
        "payloadType": "json",
        "x": 200,
        "y": 340,
        "wires": [
            [
                "60f3d3f665e7ea46"
            ]
        ]
    },
    {
        "id": "7001439deafa5a47",
        "type": "comment",
        "z": "634c78c80eb9f37e",
        "name": "Sun Event Tracking to set Scenes",
        "info": "",
        "x": 170,
        "y": 300,
        "wires": [],
        "icon": "font-awesome/fa-question-circle"
    },
    {
        "id": "37cb22aac1fa4a99",
        "type": "inject",
        "z": "634c78c80eb9f37e",
        "name": "",
        "props": [],
        "repeat": "7200",
        "crontab": "",
        "once": false,
        "onceDelay": "900",
        "topic": "",
        "x": 140,
        "y": 100,
        "wires": [
            [
                "f991b8b5b5f73fde"
            ]
        ]
    },
    {
        "id": "5c380b83edfd85d6",
        "type": "comment",
        "z": "634c78c80eb9f37e",
        "name": "Reset mechanism available through Homekit",
        "info": "",
        "x": 210,
        "y": 640,
        "wires": []
    },
    {
        "id": "1b9873d4c1d781ca",
        "type": "homekit-service",
        "z": "634c78c80eb9f37e",
        "isParent": true,
        "hostType": "0",
        "bridge": "b2cc5799.eea9d",
        "accessoryId": "",
        "parentService": "",
        "name": "Reset",
        "serviceName": "Switch",
        "topic": "",
        "filter": false,
        "manufacturer": "NRCHKB",
        "model": "1.4.3",
        "serialNo": "Default Serial Number",
        "firmwareRev": "1.4.3",
        "hardwareRev": "1.4.3",
        "softwareRev": "1.4.3",
        "cameraConfigVideoProcessor": "ffmpeg",
        "cameraConfigSource": "",
        "cameraConfigStillImageSource": "",
        "cameraConfigMaxStreams": 2,
        "cameraConfigMaxWidth": 1280,
        "cameraConfigMaxHeight": 720,
        "cameraConfigMaxFPS": 10,
        "cameraConfigMaxBitrate": 300,
        "cameraConfigVideoCodec": "libx264",
        "cameraConfigAudioCodec": "libfdk_aac",
        "cameraConfigAudio": false,
        "cameraConfigPacketSize": 1316,
        "cameraConfigVerticalFlip": false,
        "cameraConfigHorizontalFlip": false,
        "cameraConfigMapVideo": "0:0",
        "cameraConfigMapAudio": "0:1",
        "cameraConfigVideoFilter": "scale=1280:720",
        "cameraConfigAdditionalCommandLine": "-tune zerolatency",
        "cameraConfigDebug": false,
        "cameraConfigSnapshotOutput": "disabled",
        "cameraConfigInterfaceName": "",
        "characteristicProperties": "{}",
        "waitForSetupMsg": false,
        "outputs": 2,
        "x": 130,
        "y": 680,
        "wires": [
            [
                "45230be763c062ae"
            ],
            []
        ]
    },
    {
        "id": "aa9dca0548480ae1",
        "type": "set-shared-state",
        "z": "634c78c80eb9f37e",
        "state": "3d96ef25996d1dd1",
        "name": "Reset",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 850,
        "y": 680,
        "wires": []
    },
    {
        "id": "45230be763c062ae",
        "type": "change",
        "z": "634c78c80eb9f37e",
        "name": "Move on to value",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "",
                "tot": "date"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 310,
        "y": 680,
        "wires": [
            [
                "fc6d53171a0a2eef"
            ]
        ]
    },
    {
        "id": "392367f1059edf8f",
        "type": "change",
        "z": "634c78c80eb9f37e",
        "name": "Turn off",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            },
            {
                "t": "set",
                "p": "payload.On",
                "pt": "msg",
                "to": "false",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 300,
        "y": 740,
        "wires": [
            [
                "1b9873d4c1d781ca"
            ]
        ]
    },
    {
        "id": "05dc4cb847d1d054",
        "type": "delay",
        "z": "634c78c80eb9f37e",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "minute",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": false,
        "outputs": 1,
        "x": 680,
        "y": 680,
        "wires": [
            [
                "aa9dca0548480ae1"
            ]
        ]
    },
    {
        "id": "3c5040df487f58af",
        "type": "inject",
        "z": "634c78c80eb9f37e",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 140,
        "y": 740,
        "wires": [
            [
                "392367f1059edf8f"
            ]
        ]
    },
    {
        "id": "a727f6fa4e037102",
        "type": "comment",
        "z": "634c78c80eb9f37e",
        "name": "Home day phase, largely based on sun event",
        "info": "",
        "x": 210,
        "y": 480,
        "wires": [],
        "icon": "font-awesome/fa-question-circle"
    },
    {
        "id": "b681b75836dbf49a",
        "type": "get-shared-state",
        "z": "634c78c80eb9f37e",
        "state": "174c278f.609ec8",
        "name": "Sun Event",
        "triggerOnInit": true,
        "x": 100,
        "y": 520,
        "wires": [
            [
                "6acc06089b237d56"
            ]
        ]
    },
    {
        "id": "14c93c9256bae5c4",
        "type": "inject",
        "z": "634c78c80eb9f37e",
        "name": "Check during evening",
        "props": [],
        "repeat": "",
        "crontab": "*/30 4-23 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 170,
        "y": 580,
        "wires": [
            [
                "6acc06089b237d56"
            ]
        ]
    },
    {
        "id": "6acc06089b237d56",
        "type": "function",
        "z": "634c78c80eb9f37e",
        "name": "Phase Decider",
        "func": "sun_event = global.get(\"state\").sunevent.value\n\nmsg = {}\n\n// Get current time\nnow = new Date()\n// Get the hour\nthis_hour = now.getHours()\n// Get the minute\nthis_minute = now.getMinutes()\n\n// Get override times\ndusk_time = new Date(global.get(\"state\").schedule.value.dusk)\nwinddown_time = new Date(global.get(\"state\").schedule.value.winddown)\nnight_time = new Date(global.get(\"state\").schedule.value.night)\n\n// No override of morning, just go with the sun event\nif (sun_event == \"morning\")\n    // Override if after noon\n    if (this_hour >= 12) {\n        msg.payload = \"day\"\n    } else {\n        msg.payload = \"morning\"\n    }\n// No override of day, just go with the sun event\nif (sun_event == \"day\")\n    msg.payload = \"day\"\n// No override of sunset, just go with the sun event\nif (sun_event == \"sunset\")\n    msg.payload = \"sunset\"\n// If it's dusk we're going to override\nif (sun_event == \"dusk\") {\n    // If it's after the dusk override time go with dusk\n    if (now > dusk_time) {\n        msg.payload = \"dusk\"\n    // Otherwise, freeze us at sunset\n    } else {\n        msg.payload = \"sunset\"\n    }\n}\n// If it's night we're going to override\nif (sun_event == \"night\") {\n    // If it's after night time\n    if (now > night_time) {\n        msg.payload = \"night\"\n    // If it's after winddown time\n    } else if (now > winddown_time) {\n        msg.payload = \"winddown\"\n    // If it's after dusk time\n    } else if (now > dusk_time) {\n        msg.payload = \"dusk\"\n    } else {\n    // If it's not dusk time yet, just stick with sunset\n        msg.payload = \"sunset\"\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 520,
        "wires": [
            [
                "cec5fcf493bb58c1"
            ]
        ]
    },
    {
        "id": "cec5fcf493bb58c1",
        "type": "set-shared-state",
        "z": "634c78c80eb9f37e",
        "state": "efc87f0de00a2d36",
        "name": "Day Phase",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 610,
        "y": 520,
        "wires": []
    },
    {
        "id": "fc6d53171a0a2eef",
        "type": "delay",
        "z": "634c78c80eb9f37e",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "minute",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": false,
        "outputs": 1,
        "x": 500,
        "y": 680,
        "wires": [
            [
                "05dc4cb847d1d054",
                "392367f1059edf8f"
            ]
        ]
    },
    {
        "id": "03d49e6e6a6a882d",
        "type": "file in",
        "z": "634c78c80eb9f37e",
        "name": "Read Schedule config file",
        "filename": "/data/projects/node-red/configs/schedule_config.yaml",
        "format": "utf8",
        "chunk": false,
        "sendError": false,
        "encoding": "utf8",
        "allProps": false,
        "x": 630,
        "y": 40,
        "wires": [
            [
                "db2ed0e33cc5550d"
            ]
        ]
    },
    {
        "id": "db2ed0e33cc5550d",
        "type": "yaml",
        "z": "634c78c80eb9f37e",
        "property": "payload",
        "name": "Convert to JSON",
        "x": 870,
        "y": 40,
        "wires": [
            [
                "e9dd15aabc896de3"
            ]
        ]
    },
    {
        "id": "91bfd1cbe0c7c95b",
        "type": "set-shared-state",
        "z": "634c78c80eb9f37e",
        "state": "f4fbefedb919c3c1",
        "name": "Schedule",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 1260,
        "y": 40,
        "wires": []
    },
    {
        "id": "e9dd15aabc896de3",
        "type": "function",
        "z": "634c78c80eb9f37e",
        "name": "Parse schedule times",
        "func": "var today = new Date();\nvar day_of_week = today.getDay();\nvar dd = String(today.getDate()).padStart(2, '0');\nvar mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!\nvar yyyy = today.getFullYear();\n\ntoday = yyyy + '-' + mm + '-' + dd;\n\nschedule = {}\n\nfunction get_time_from_string (string_time) {\n    return Date.parse(today+'T'+string_time+\":00\")\n}\n\n// Get the schedule for today's day of the week\ntoday_schedule = msg.payload.schedule[day_of_week]\n\nschedule.begin_wake = get_time_from_string(today_schedule.begin_wake)\nschedule.wake = get_time_from_string(today_schedule.wake)\nschedule.dusk = get_time_from_string(today_schedule.dusk)\nschedule.winddown = get_time_from_string(today_schedule.winddown)\nschedule.stop_screens = get_time_from_string(today_schedule.stop_screens)\nschedule.go_to_bed = get_time_from_string(today_schedule.go_to_bed)\nschedule.night = get_time_from_string(today_schedule.night)\n\nmsg.payload = schedule\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1080,
        "y": 40,
        "wires": [
            [
                "91bfd1cbe0c7c95b"
            ]
        ]
    },
    {
        "id": "c0e040aaba90066e",
        "type": "file in",
        "z": "634c78c80eb9f37e",
        "name": "Read climate config file",
        "filename": "/data/projects/node-red/configs/climate_config.yaml",
        "format": "utf8",
        "chunk": false,
        "sendError": false,
        "encoding": "utf8",
        "allProps": false,
        "x": 630,
        "y": 160,
        "wires": [
            [
                "950b27ce0e1df41e"
            ]
        ]
    },
    {
        "id": "950b27ce0e1df41e",
        "type": "yaml",
        "z": "634c78c80eb9f37e",
        "property": "payload",
        "name": "Convert to JSON",
        "x": 860,
        "y": 160,
        "wires": [
            [
                "742f79ea2723fc83"
            ]
        ]
    },
    {
        "id": "742f79ea2723fc83",
        "type": "set-shared-state",
        "z": "634c78c80eb9f37e",
        "state": "611761b9dd5c9c4c",
        "name": "Climate Config",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 1050,
        "y": 160,
        "wires": []
    },
    {
        "id": "f16bcb4bfea89461",
        "type": "api-current-state",
        "z": "499c53680d148fb0",
        "name": "Get Nick Work Calendar",
        "server": "3ec50562615a9f50",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "calendar.nborgers_pinterest_com",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1290,
        "y": 140,
        "wires": [
            [
                "ef40c5c9c328117a"
            ]
        ]
    },
    {
        "id": "eeb048faac509fb7",
        "type": "api-current-state",
        "z": "499c53680d148fb0",
        "name": "Get Nick Personal Calendar",
        "server": "3ec50562615a9f50",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "calendar.nickborgers_gmail_com",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1300,
        "y": 80,
        "wires": [
            [
                "7ea81c237d1bc6b9"
            ]
        ]
    },
    {
        "id": "e20f60c78f9d70c3",
        "type": "function",
        "z": "499c53680d148fb0",
        "name": "Parse Start Timestamp",
        "func": "next_event_start = Date.parse(msg.data.attributes.start_time)\n\n\nnew_msg = {}\n\nnew_msg.person = msg.person\nnew_msg.calendar = msg.calendar\nnew_msg.next_event_start = next_event_start\n\nreturn new_msg",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 440,
        "y": 340,
        "wires": [
            [
                "ef3a03f27ccc5aac"
            ]
        ]
    },
    {
        "id": "ef3a03f27ccc5aac",
        "type": "function",
        "z": "499c53680d148fb0",
        "name": "Check if event starts tomorrow morning",
        "func": "const today = new Date()\nconst tomorrow = new Date(today)\ntomorrow.setDate(tomorrow.getDate() + 1)\n\nstartOfTomorrowMorning = new Date(tomorrow);\nstartOfTomorrowMorning.setHours(4);\nstartOfTomorrowMorning.setMinutes(0);\nstartOfTomorrowMorning.setSeconds(0);\n\nendOfTomorrowMorning = new Date(tomorrow);\nendOfTomorrowMorning.setHours(10);\nendOfTomorrowMorning.setMinutes(0);\nendOfTomorrowMorning.setSeconds(0);\n\nif (startOfTomorrowMorning < msg.next_event_start &&\n    endOfTomorrowMorning > msg.next_event_start) {\n        return msg;\n}\n\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 720,
        "y": 340,
        "wires": [
            [
                "8c780ce574114c79"
            ]
        ]
    },
    {
        "id": "78b97767ec7322f1",
        "type": "api-current-state",
        "z": "499c53680d148fb0",
        "name": "Get Caroline Personal Calendar",
        "server": "3ec50562615a9f50",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "calendar.cpersonius216_gmail_com",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1310,
        "y": 200,
        "wires": [
            [
                "54dc994524561093"
            ]
        ]
    },
    {
        "id": "27cc38fa63122801",
        "type": "inject",
        "z": "499c53680d148fb0",
        "name": "Check during evening",
        "props": [],
        "repeat": "",
        "crontab": "*/15 20-23 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 170,
        "y": 100,
        "wires": [
            [
                "e05c1b0b11607600"
            ]
        ]
    },
    {
        "id": "4692feeb7bad273d",
        "type": "change",
        "z": "499c53680d148fb0",
        "name": "Set Attr For Nick",
        "rules": [
            {
                "t": "set",
                "p": "person",
                "pt": "msg",
                "to": "Nick",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 470,
        "y": 120,
        "wires": [
            [
                "d307702ed23e98f3"
            ]
        ]
    },
    {
        "id": "2ae4546130f6a88d",
        "type": "change",
        "z": "499c53680d148fb0",
        "name": "Set Attr For Caroline",
        "rules": [
            {
                "t": "set",
                "p": "person",
                "pt": "msg",
                "to": "Caroline",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 460,
        "y": 220,
        "wires": [
            [
                "704229286b8d3587"
            ]
        ]
    },
    {
        "id": "788db9362b2ed4ab",
        "type": "change",
        "z": "499c53680d148fb0",
        "name": "Set Attr For Work",
        "rules": [
            {
                "t": "set",
                "p": "calendar",
                "pt": "msg",
                "to": "Work",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1030,
        "y": 140,
        "wires": [
            [
                "f16bcb4bfea89461"
            ]
        ]
    },
    {
        "id": "90885fafa2c4dd63",
        "type": "change",
        "z": "499c53680d148fb0",
        "name": "Set Attr For Personal",
        "rules": [
            {
                "t": "set",
                "p": "calendar",
                "pt": "msg",
                "to": "Personal",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1040,
        "y": 80,
        "wires": [
            [
                "eeb048faac509fb7"
            ]
        ]
    },
    {
        "id": "6dc231aa8e595417",
        "type": "change",
        "z": "499c53680d148fb0",
        "name": "Set Attr For Personal",
        "rules": [
            {
                "t": "set",
                "p": "calendar",
                "pt": "msg",
                "to": "Personal",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1040,
        "y": 200,
        "wires": [
            [
                "78b97767ec7322f1"
            ]
        ]
    },
    {
        "id": "a3678204f8f05362",
        "type": "ttsultimate",
        "z": "499c53680d148fb0",
        "name": "",
        "voice": "en-GB",
        "ssml": false,
        "sonosipaddress": "10.212.100.226",
        "sonosvolume": "20",
        "sonoshailing": "Hailing_Hailing.mp3",
        "config": "89337ebbba16965d",
        "property": "payload",
        "propertyType": {},
        "rules": [],
        "playertype": "sonos",
        "speakingrate": "1",
        "speakingpitch": "0",
        "unmuteIfMuted": true,
        "x": 870,
        "y": 400,
        "wires": [
            [],
            []
        ]
    },
    {
        "id": "8c780ce574114c79",
        "type": "function",
        "z": "499c53680d148fb0",
        "name": "Generate Notification Message",
        "func": "event_start = new Date(parseInt(msg.next_event_start))\n\nhour = event_start.getHours();\nminute = event_start.getMinutes();\n\nnotification_message = msg.person + \", you have an event on your \" + msg.calendar + \" calendar which starts at \"\n\nif (minute == 0) {\n    notification_message = notification_message + hour + \" am\"\n} else {\n    notification_message = notification_message + hour + \" \" + minute + \" am\"\n}\n\nnotification_message = notification_message + \" tomorrow morning.\"\n\nmsg.payload = notification_message\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 470,
        "y": 400,
        "wires": [
            [
                "691e49e8493599d4"
            ]
        ]
    },
    {
        "id": "0ed88bf8056f6919",
        "type": "link call",
        "z": "499c53680d148fb0",
        "name": "Reset Music",
        "links": [
            "b1f2b5145a191585"
        ],
        "timeout": "30",
        "x": 1050,
        "y": 460,
        "wires": [
            []
        ]
    },
    {
        "id": "f8f16db190a9bbf1",
        "type": "catch",
        "z": "499c53680d148fb0",
        "name": "Catch TTS Error",
        "scope": [
            "a3678204f8f05362"
        ],
        "uncaught": false,
        "x": 880,
        "y": 460,
        "wires": [
            [
                "0ed88bf8056f6919"
            ]
        ]
    },
    {
        "id": "e05c1b0b11607600",
        "type": "function",
        "z": "499c53680d148fb0",
        "name": "Only Proceed if we are awake",
        "func": "if (global.get(\"state\").isMasterAsleep.value == false) {\n    return msg\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 190,
        "y": 160,
        "wires": [
            [
                "4692feeb7bad273d",
                "2ae4546130f6a88d"
            ]
        ]
    },
    {
        "id": "d307702ed23e98f3",
        "type": "function",
        "z": "499c53680d148fb0",
        "name": "Only Proceed if Nick is Home",
        "func": "if (global.get(\"state\").isNickHome.value) {\n    return msg\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 720,
        "y": 120,
        "wires": [
            [
                "788db9362b2ed4ab",
                "90885fafa2c4dd63"
            ]
        ]
    },
    {
        "id": "704229286b8d3587",
        "type": "function",
        "z": "499c53680d148fb0",
        "name": "Only Proceed if Caroline is Home",
        "func": "if (global.get(\"state\").isCarolineHome.value) {\n    return msg\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 740,
        "y": 220,
        "wires": [
            [
                "6dc231aa8e595417",
                "06f4e5c7d9a46571"
            ]
        ]
    },
    {
        "id": "06f4e5c7d9a46571",
        "type": "change",
        "z": "499c53680d148fb0",
        "name": "Set Attr For Work",
        "rules": [
            {
                "t": "set",
                "p": "calendar",
                "pt": "msg",
                "to": "Work",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1030,
        "y": 260,
        "wires": [
            [
                "21abaeffc63334c7"
            ]
        ]
    },
    {
        "id": "21abaeffc63334c7",
        "type": "api-current-state",
        "z": "499c53680d148fb0",
        "name": "Get Caroline Work Calendar",
        "server": "3ec50562615a9f50",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "calendar.carolinep_remitly_com",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1300,
        "y": 260,
        "wires": [
            [
                "7801e88d316cb498"
            ]
        ]
    },
    {
        "id": "7ea81c237d1bc6b9",
        "type": "delay",
        "z": "499c53680d148fb0",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "19",
        "rateUnits": "hour",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": false,
        "outputs": 1,
        "x": 1540,
        "y": 80,
        "wires": [
            [
                "e20f60c78f9d70c3"
            ]
        ]
    },
    {
        "id": "ef40c5c9c328117a",
        "type": "delay",
        "z": "499c53680d148fb0",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "19",
        "rateUnits": "hour",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": false,
        "outputs": 1,
        "x": 1540,
        "y": 140,
        "wires": [
            [
                "e20f60c78f9d70c3"
            ]
        ]
    },
    {
        "id": "54dc994524561093",
        "type": "delay",
        "z": "499c53680d148fb0",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "19",
        "rateUnits": "hour",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": false,
        "outputs": 1,
        "x": 1540,
        "y": 200,
        "wires": [
            [
                "e20f60c78f9d70c3"
            ]
        ]
    },
    {
        "id": "7801e88d316cb498",
        "type": "delay",
        "z": "499c53680d148fb0",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "19",
        "rateUnits": "hour",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": false,
        "outputs": 1,
        "x": 1540,
        "y": 260,
        "wires": [
            [
                "e20f60c78f9d70c3"
            ]
        ]
    },
    {
        "id": "691e49e8493599d4",
        "type": "delay",
        "z": "499c53680d148fb0",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "30",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 700,
        "y": 400,
        "wires": [
            [
                "a3678204f8f05362"
            ]
        ]
    },
    {
        "id": "5eafd94846b1351d",
        "type": "comment",
        "z": "499c53680d148fb0",
        "name": "Ugly check trigger",
        "info": "",
        "x": 130,
        "y": 60,
        "wires": []
    },
    {
        "id": "28ae008b535bbdc3",
        "type": "comment",
        "z": "499c53680d148fb0",
        "name": "Only notify once per day",
        "info": "",
        "x": 1570,
        "y": 40,
        "wires": []
    },
    {
        "id": "5908acc6f289a226",
        "type": "comment",
        "z": "499c53680d148fb0",
        "name": "Read calendar",
        "info": "",
        "x": 1260,
        "y": 40,
        "wires": []
    },
    {
        "id": "9212dea7c3727082",
        "type": "comment",
        "z": "16cd74edb3f2c03d",
        "name": "Sun Event-based scene settings for all rooms",
        "info": "",
        "x": 190,
        "y": 40,
        "wires": []
    },
    {
        "id": "109af65d.29420a",
        "type": "get-shared-state",
        "z": "16cd74edb3f2c03d",
        "state": "1dd96a4a.9d6316",
        "name": "Anyone Home",
        "triggerOnInit": false,
        "x": 130,
        "y": 220,
        "wires": [
            [
                "d2a0c7cb.1bd518"
            ]
        ]
    },
    {
        "id": "d2a0c7cb.1bd518",
        "type": "function",
        "z": "16cd74edb3f2c03d",
        "name": "Check if anyone home and not everyone asleep",
        "func": "if (global.get(\"state\").isAnyoneHome.value == false) {\n    return null\n}\nif (global.get(\"state\").isEveryoneAsleep.value == true) {\n    return null\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 700,
        "y": 220,
        "wires": [
            [
                "1ee8dd5329aad550",
                "f9cd25793f40ac96"
            ]
        ]
    },
    {
        "id": "2b5771db.5cc26e",
        "type": "get-shared-state",
        "z": "16cd74edb3f2c03d",
        "state": "efc87f0de00a2d36",
        "name": "Day Phase",
        "triggerOnInit": false,
        "x": 120,
        "y": 160,
        "wires": [
            [
                "d2a0c7cb.1bd518"
            ]
        ]
    },
    {
        "id": "95a066e2.436e7",
        "type": "get-shared-state",
        "z": "16cd74edb3f2c03d",
        "state": "b69e9a96.7fc43",
        "name": "Master Asleep",
        "triggerOnInit": false,
        "x": 130,
        "y": 340,
        "wires": [
            [
                "3e279bdd0682936e"
            ]
        ]
    },
    {
        "id": "6563d5d5.1f5c5c",
        "type": "comment",
        "z": "16cd74edb3f2c03d",
        "name": "Turn everything off if needed",
        "info": "",
        "x": 140,
        "y": 540,
        "wires": []
    },
    {
        "id": "19b38e68.bd9cea",
        "type": "get-shared-state",
        "z": "16cd74edb3f2c03d",
        "state": "1dd96a4a.9d6316",
        "name": "Anyone Home",
        "triggerOnInit": false,
        "x": 110,
        "y": 580,
        "wires": [
            [
                "a14179adc764d592"
            ]
        ]
    },
    {
        "id": "1b30c854f439ed7f",
        "type": "inject",
        "z": "16cd74edb3f2c03d",
        "name": "Manually set lights",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 150,
        "y": 100,
        "wires": [
            [
                "d2a0c7cb.1bd518",
                "792164089d62de52"
            ]
        ]
    },
    {
        "id": "cd060db8315b8a7e",
        "type": "get-shared-state",
        "z": "16cd74edb3f2c03d",
        "state": "156ccde543ba4845",
        "name": "Guest Asleep",
        "triggerOnInit": false,
        "x": 130,
        "y": 400,
        "wires": [
            [
                "3e279bdd0682936e"
            ]
        ]
    },
    {
        "id": "4f29df791c0e22eb",
        "type": "get-shared-state",
        "z": "16cd74edb3f2c03d",
        "state": "60c1725bc2519ee0",
        "name": "Everyone Asleep",
        "triggerOnInit": false,
        "x": 140,
        "y": 280,
        "wires": [
            [
                "3e279bdd0682936e"
            ]
        ]
    },
    {
        "id": "889c7da1d6d64229",
        "type": "get-shared-state",
        "z": "16cd74edb3f2c03d",
        "state": "3d96ef25996d1dd1",
        "name": "Reset",
        "triggerOnInit": false,
        "x": 110,
        "y": 460,
        "wires": [
            [
                "3e279bdd0682936e"
            ]
        ]
    },
    {
        "id": "7935909ef8708c2f",
        "type": "api-call-service",
        "z": "16cd74edb3f2c03d",
        "name": "Activate Dynamic Scene",
        "server": "3ec50562615a9f50",
        "version": 5,
        "debugenabled": false,
        "domain": "hue",
        "service": "hue_activate_scene",
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "data": "msg.payload",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "x": 1730,
        "y": 220,
        "wires": [
            []
        ]
    },
    {
        "id": "c81034bf2843ebc6",
        "type": "function",
        "z": "16cd74edb3f2c03d",
        "name": "Pick which rooms to apply scenes to",
        "func": "hueConfig = global.get(\"state\").hueConfig.value\n\ndayPhase = global.get(\"state\").dayPhase.value\n\nhueConfig.rooms.forEach(function(thisRoomToActivate) {\n    // Does this participant even have this attribute?\n    if (\"off_if_true\" in thisRoomToActivate) {\n        // If so, is it true?\n        if (global.get(\"state\")[thisRoomToActivate.off_if_true].value) {\n            return null\n        }\n    }\n    \n    msg.payload = {}\n    msg.payload.group_name = thisRoomToActivate.hue_group\n    msg.payload.scene_name = dayPhase\n    msg.payload.dynamic = true\n    // The nook doesn't do well with dynamics b/c of its lights\n    if (thisRoomToActivate.hue_group == \"Nook\") {\n        msg.payload.dynamic = false\n    }\n    node.send(msg)\n});",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1290,
        "y": 220,
        "wires": [
            [
                "1e0d8022cef2ed62"
            ]
        ]
    },
    {
        "id": "1e0d8022cef2ed62",
        "type": "delay",
        "z": "16cd74edb3f2c03d",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 1530,
        "y": 220,
        "wires": [
            [
                "7935909ef8708c2f"
            ]
        ]
    },
    {
        "id": "792164089d62de52",
        "type": "function",
        "z": "16cd74edb3f2c03d",
        "name": "Pick rooms whose variables are now true",
        "func": "hueConfig = global.get(\"state\").hueConfig.value\n\ndayPhase = global.get(\"state\").dayPhase.value\n\nhueConfig.rooms.forEach(function(thisRoomToTurnOff) {\n    // Does this participant even have this attribute?\n    if (\"off_if_true\" in thisRoomToTurnOff) {\n        // Is the variable change triggering us the special \"reset\" case, or is it the variable this room cares about?\n        if ((msg.topic == \"reset\" || msg.topic == thisRoomToTurnOff.off_if_true) \n        // Is the variable this room cares about true?\n        && global.get(\"state\")[thisRoomToTurnOff.off_if_true].value) {\n            msg.targetArea = thisRoomToTurnOff.hass_area_id\n            node.send(msg)\n        }\n    }\n});",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 680,
        "y": 300,
        "wires": [
            [
                "7ed258ec2fd76e0a"
            ]
        ]
    },
    {
        "id": "9d9ff9bfa287e582",
        "type": "comment",
        "z": "16cd74edb3f2c03d",
        "name": "Turn on lights path",
        "info": "",
        "x": 610,
        "y": 180,
        "wires": []
    },
    {
        "id": "b718416c12cdb464",
        "type": "comment",
        "z": "16cd74edb3f2c03d",
        "name": "Turn off lights path",
        "info": "",
        "x": 610,
        "y": 260,
        "wires": []
    },
    {
        "id": "3e279bdd0682936e",
        "type": "change",
        "z": "16cd74edb3f2c03d",
        "name": "Aggregate Triggers",
        "rules": [],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 350,
        "y": 400,
        "wires": [
            [
                "d2a0c7cb.1bd518",
                "792164089d62de52"
            ]
        ]
    },
    {
        "id": "d4e0576749b87d16",
        "type": "api-call-service",
        "z": "16cd74edb3f2c03d",
        "name": "Turn off lights in room",
        "server": "3ec50562615a9f50",
        "version": 5,
        "debugenabled": false,
        "domain": "light",
        "service": "turn_off",
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "data": "{\"area_id\": msg.targetArea}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "data"
            }
        ],
        "queue": "none",
        "x": 980,
        "y": 460,
        "wires": [
            []
        ]
    },
    {
        "id": "6e7492c93999c36c",
        "type": "function",
        "z": "16cd74edb3f2c03d",
        "name": "Pick every room",
        "func": "hueConfig = global.get(\"state\").hueConfig.value\n\nhueConfig.rooms.forEach(function(thisRoomToTurnOff) {\n    // Pick every single room\n    msg.targetArea = thisRoomToTurnOff.hass_area_id\n    node.send(msg)\n});",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 540,
        "y": 520,
        "wires": [
            [
                "7ed258ec2fd76e0a"
            ]
        ]
    },
    {
        "id": "7ed258ec2fd76e0a",
        "type": "delay",
        "z": "16cd74edb3f2c03d",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 770,
        "y": 460,
        "wires": [
            [
                "d4e0576749b87d16"
            ]
        ]
    },
    {
        "id": "de7d4b5c6bd29efc",
        "type": "comment",
        "z": "16cd74edb3f2c03d",
        "name": "Bright",
        "info": "",
        "x": 70,
        "y": 640,
        "wires": []
    },
    {
        "id": "3a18c616bed81b01",
        "type": "homekit-service",
        "z": "16cd74edb3f2c03d",
        "isParent": true,
        "hostType": "0",
        "bridge": "b2cc5799.eea9d",
        "accessoryId": "",
        "parentService": "",
        "name": "Bright",
        "serviceName": "Switch",
        "topic": "",
        "filter": false,
        "manufacturer": "NRCHKB",
        "model": "1.4.3",
        "serialNo": "Default Serial Number",
        "firmwareRev": "1.4.3",
        "hardwareRev": "1.4.3",
        "softwareRev": "1.4.3",
        "cameraConfigVideoProcessor": "ffmpeg",
        "cameraConfigSource": "",
        "cameraConfigStillImageSource": "",
        "cameraConfigMaxStreams": 2,
        "cameraConfigMaxWidth": 1280,
        "cameraConfigMaxHeight": 720,
        "cameraConfigMaxFPS": 10,
        "cameraConfigMaxBitrate": 300,
        "cameraConfigVideoCodec": "libx264",
        "cameraConfigAudioCodec": "libfdk_aac",
        "cameraConfigAudio": false,
        "cameraConfigPacketSize": 1316,
        "cameraConfigVerticalFlip": false,
        "cameraConfigHorizontalFlip": false,
        "cameraConfigMapVideo": "0:0",
        "cameraConfigMapAudio": "0:1",
        "cameraConfigVideoFilter": "scale=1280:720",
        "cameraConfigAdditionalCommandLine": "-tune zerolatency",
        "cameraConfigDebug": false,
        "cameraConfigSnapshotOutput": "disabled",
        "cameraConfigInterfaceName": "",
        "characteristicProperties": "{}",
        "waitForSetupMsg": false,
        "outputs": 2,
        "x": 110,
        "y": 680,
        "wires": [
            [
                "515bdc9718d62b40"
            ],
            []
        ]
    },
    {
        "id": "515bdc9718d62b40",
        "type": "change",
        "z": "16cd74edb3f2c03d",
        "name": "Move on to value",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "",
                "tot": "date"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 290,
        "y": 680,
        "wires": [
            [
                "117283bed69961e5"
            ]
        ]
    },
    {
        "id": "be1b0aef8b46b403",
        "type": "change",
        "z": "16cd74edb3f2c03d",
        "name": "Turn off",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            },
            {
                "t": "set",
                "p": "payload.On",
                "pt": "msg",
                "to": "false",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 280,
        "y": 740,
        "wires": [
            [
                "3a18c616bed81b01"
            ]
        ]
    },
    {
        "id": "1ef69f3a154c54fd",
        "type": "inject",
        "z": "16cd74edb3f2c03d",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 120,
        "y": 740,
        "wires": [
            [
                "be1b0aef8b46b403"
            ]
        ]
    },
    {
        "id": "b9f2817921074955",
        "type": "function",
        "z": "16cd74edb3f2c03d",
        "name": "Apply Bright to all rooms",
        "func": "hueConfig = global.get(\"state\").hueConfig.value\n\ndayPhase = global.get(\"state\").dayPhase.value\n\nhueConfig.rooms.forEach(function(thisRoomToActivate) {\n    // Does this participant even have this attribute?\n    if (\"off_if_true\" in thisRoomToActivate) {\n        // If so, is it true?\n        if (global.get(\"state\")[thisRoomToActivate.off_if_true].value) {\n            return null\n        }\n    }\n    \n    msg.payload = {}\n    msg.payload.group_name = thisRoomToActivate.hue_group\n    msg.payload.scene_name = \"Bright\"\n    msg.payload.dynamic = true\n    // The nook doesn't do well with dynamics b/c of its lights\n    if (thisRoomToActivate.hue_group == \"Nook\") {\n        msg.payload.dynamic = false\n    }\n    node.send(msg)\n});",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 870,
        "y": 680,
        "wires": [
            [
                "0793eb5edefcf142"
            ]
        ]
    },
    {
        "id": "fcfad92e25c72d66",
        "type": "delay",
        "z": "16cd74edb3f2c03d",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 650,
        "y": 680,
        "wires": [
            [
                "b9f2817921074955"
            ]
        ]
    },
    {
        "id": "0793eb5edefcf142",
        "type": "api-call-service",
        "z": "16cd74edb3f2c03d",
        "name": "Activate Bright Scene",
        "server": "3ec50562615a9f50",
        "version": 5,
        "debugenabled": false,
        "domain": "hue",
        "service": "hue_activate_scene",
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "data": "msg.payload",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "x": 1120,
        "y": 680,
        "wires": [
            []
        ]
    },
    {
        "id": "117283bed69961e5",
        "type": "delay",
        "z": "16cd74edb3f2c03d",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "minute",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": false,
        "outputs": 1,
        "x": 480,
        "y": 680,
        "wires": [
            [
                "be1b0aef8b46b403",
                "fcfad92e25c72d66"
            ]
        ]
    },
    {
        "id": "1ee8dd5329aad550",
        "type": "delay",
        "z": "16cd74edb3f2c03d",
        "name": "Only allow 1 per minute",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "minute",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": false,
        "outputs": 1,
        "x": 1010,
        "y": 220,
        "wires": [
            [
                "c81034bf2843ebc6"
            ]
        ]
    },
    {
        "id": "54078ecde99da032",
        "type": "api-call-service",
        "z": "16cd74edb3f2c03d",
        "name": "Turn off TV",
        "server": "3ec50562615a9f50",
        "version": 5,
        "debugenabled": false,
        "domain": "remote",
        "service": "turn_off",
        "areaId": [
            "living_room"
        ],
        "deviceId": [
            "4cb91db5c368ef79e9cd2fafb2e9ac3c"
        ],
        "entityId": [
            "remote.big_beautiful_oled"
        ],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "x": 530,
        "y": 580,
        "wires": [
            []
        ]
    },
    {
        "id": "0266ff67bd766f59",
        "type": "api-call-service",
        "z": "16cd74edb3f2c03d",
        "name": "Turn on Apple TV",
        "server": "3ec50562615a9f50",
        "version": 5,
        "debugenabled": false,
        "domain": "remote",
        "service": "send_command",
        "areaId": [
            "living_room"
        ],
        "deviceId": [
            "4cb91db5c368ef79e9cd2fafb2e9ac3c"
        ],
        "entityId": [
            "remote.big_beautiful_oled"
        ],
        "data": "{\"command\": \"home\"}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "x": 1070,
        "y": 360,
        "wires": [
            [
                "fa7a5706b010cfbf"
            ]
        ]
    },
    {
        "id": "8ba57550455da33b",
        "type": "api-call-service",
        "z": "16cd74edb3f2c03d",
        "name": "Go to home",
        "server": "3ec50562615a9f50",
        "version": 5,
        "debugenabled": false,
        "domain": "remote",
        "service": "send_command",
        "areaId": [
            "living_room"
        ],
        "deviceId": [
            "4cb91db5c368ef79e9cd2fafb2e9ac3c"
        ],
        "entityId": [
            "remote.big_beautiful_oled"
        ],
        "data": "{\"command\": \"home\"}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "x": 1390,
        "y": 360,
        "wires": [
            [
                "b0e02bbb3b81d398"
            ]
        ]
    },
    {
        "id": "fa7a5706b010cfbf",
        "type": "delay",
        "z": "16cd74edb3f2c03d",
        "name": "",
        "pauseType": "delay",
        "timeout": "8",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 1240,
        "y": 360,
        "wires": [
            [
                "8ba57550455da33b"
            ]
        ]
    },
    {
        "id": "b4bae27b40c93f10",
        "type": "comment",
        "z": "16cd74edb3f2c03d",
        "name": "Turn on TV and screensaver",
        "info": "",
        "x": 1040,
        "y": 320,
        "wires": []
    },
    {
        "id": "9d79d6cd3f994b75",
        "type": "link in",
        "z": "16cd74edb3f2c03d",
        "name": "Turn on Apple TV Screensaver",
        "links": [
            "b47a5d8324f29a71"
        ],
        "x": 935,
        "y": 360,
        "wires": [
            [
                "0266ff67bd766f59"
            ]
        ]
    },
    {
        "id": "a14179adc764d592",
        "type": "switch",
        "z": "16cd74edb3f2c03d",
        "name": "If noone home",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 340,
        "y": 580,
        "wires": [
            [
                "6e7492c93999c36c",
                "54078ecde99da032"
            ]
        ]
    },
    {
        "id": "f9cd25793f40ac96",
        "type": "function",
        "z": "16cd74edb3f2c03d",
        "name": "If morning",
        "func": "dayPhase = global.get(\"state\").dayPhase.value\n\nif (dayPhase == \"morning\") {\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 960,
        "y": 260,
        "wires": [
            [
                "b47a5d8324f29a71"
            ]
        ]
    },
    {
        "id": "b47a5d8324f29a71",
        "type": "link out",
        "z": "16cd74edb3f2c03d",
        "name": "",
        "mode": "link",
        "links": [
            "9d79d6cd3f994b75"
        ],
        "x": 1055,
        "y": 260,
        "wires": []
    },
    {
        "id": "f5f45b38a2831134",
        "type": "inject",
        "z": "16cd74edb3f2c03d",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 900,
        "y": 400,
        "wires": [
            [
                "0266ff67bd766f59"
            ]
        ]
    },
    {
        "id": "b0e02bbb3b81d398",
        "type": "delay",
        "z": "16cd74edb3f2c03d",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 1540,
        "y": 360,
        "wires": [
            [
                "59cbc6c8714c7cbf"
            ]
        ]
    },
    {
        "id": "59cbc6c8714c7cbf",
        "type": "api-call-service",
        "z": "16cd74edb3f2c03d",
        "name": "Go to menu",
        "server": "3ec50562615a9f50",
        "version": 5,
        "debugenabled": false,
        "domain": "remote",
        "service": "send_command",
        "areaId": [
            "living_room"
        ],
        "deviceId": [
            "4cb91db5c368ef79e9cd2fafb2e9ac3c"
        ],
        "entityId": [
            "remote.big_beautiful_oled"
        ],
        "data": "{\"command\": \"menu\"}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "x": 1690,
        "y": 360,
        "wires": [
            [
                "861a5f615a271150"
            ]
        ]
    },
    {
        "id": "861a5f615a271150",
        "type": "delay",
        "z": "16cd74edb3f2c03d",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 1240,
        "y": 420,
        "wires": [
            [
                "db8d99433da734d1"
            ]
        ]
    },
    {
        "id": "db8d99433da734d1",
        "type": "api-call-service",
        "z": "16cd74edb3f2c03d",
        "name": "Go to menu",
        "server": "3ec50562615a9f50",
        "version": 5,
        "debugenabled": false,
        "domain": "remote",
        "service": "send_command",
        "areaId": [
            "living_room"
        ],
        "deviceId": [
            "4cb91db5c368ef79e9cd2fafb2e9ac3c"
        ],
        "entityId": [
            "remote.big_beautiful_oled"
        ],
        "data": "{\"command\": \"menu\"}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "x": 1390,
        "y": 420,
        "wires": [
            [
                "b77fe937eefb09b3"
            ]
        ]
    },
    {
        "id": "b77fe937eefb09b3",
        "type": "delay",
        "z": "16cd74edb3f2c03d",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 1540,
        "y": 420,
        "wires": [
            [
                "0bc283719f5d6959"
            ]
        ]
    },
    {
        "id": "0bc283719f5d6959",
        "type": "api-call-service",
        "z": "16cd74edb3f2c03d",
        "name": "Go to menu",
        "server": "3ec50562615a9f50",
        "version": 5,
        "debugenabled": false,
        "domain": "remote",
        "service": "send_command",
        "areaId": [
            "living_room"
        ],
        "deviceId": [
            "4cb91db5c368ef79e9cd2fafb2e9ac3c"
        ],
        "entityId": [
            "remote.big_beautiful_oled"
        ],
        "data": "{\"command\": \"menu\"}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "x": 1690,
        "y": 420,
        "wires": [
            []
        ]
    },
    {
        "id": "f744b5b41bd0fbe0",
        "type": "sonos-universal",
        "z": "90f5fe8cb80ae6a7",
        "confignode": "eb483a028b06c90a",
        "command": "message",
        "state": "",
        "stateType": "str",
        "avoidCheckPlayerAvailability": false,
        "name": "Put provided URI into queue",
        "x": 1240,
        "y": 140,
        "wires": [
            [
                "4688688d8b43d7e8"
            ]
        ]
    },
    {
        "id": "1e65c8e512e5da5c",
        "type": "sonos-universal",
        "z": "90f5fe8cb80ae6a7",
        "confignode": "eb483a028b06c90a",
        "command": "group.play.queue",
        "state": "",
        "stateType": "str",
        "avoidCheckPlayerAvailability": false,
        "name": "Start Playing",
        "x": 1810,
        "y": 140,
        "wires": [
            [
                "440226e0e537344b"
            ]
        ]
    },
    {
        "id": "440226e0e537344b",
        "type": "sonos-universal",
        "z": "90f5fe8cb80ae6a7",
        "confignode": "eb483a028b06c90a",
        "command": "group.set.queuemode",
        "state": "REPEAT_ALL",
        "stateType": "str",
        "avoidCheckPlayerAvailability": false,
        "name": "Set to Repeat this playlist forever",
        "x": 1440,
        "y": 200,
        "wires": [
            [
                "cb549f365f52843c"
            ]
        ]
    },
    {
        "id": "ed9bddb805628e39",
        "type": "sonos-universal",
        "z": "90f5fe8cb80ae6a7",
        "confignode": "eb483a028b06c90a",
        "command": "group.clear.queue",
        "state": "",
        "stateType": "str",
        "avoidCheckPlayerAvailability": false,
        "name": "Clear existing Queue",
        "x": 1340,
        "y": 80,
        "wires": [
            [
                "b96e92eb32250a11"
            ]
        ]
    },
    {
        "id": "2af7ad02c544ef24",
        "type": "function",
        "z": "90f5fe8cb80ae6a7",
        "name": "Build master music message",
        "func": "// Music type is set by variable\nmusicType = global.get(\"state\").musicPlaybackType.value\n// We use an object variable or tracking which # playlist in the type\nif (typeof global.get(\"state\").musicPlaylistNumbers != \"undefined\") {\n    musicPlaylistNumbers = global.get(\"state\").musicPlaylistNumbers.value\n} else {\n    musicPlaylistNumbers = {}\n}\n// If this type has a number already, use it; otherwise create it as 0\nif (musicType in musicPlaylistNumbers) {\n    thisPlaylistNumber = musicPlaylistNumbers[musicType]\n} else {\n    thisPlaylistNumber = musicPlaylistNumbers[musicType] = 0\n}\n\n// Get full musicConfig\nmusicConfig = global.get(\"state\").musicConfig.value.music\n// Get the overall object for this type of music\nmusicTypeObject = musicConfig[musicType]\n// Get the specifics for this playback option of the music type\nmusicToPlay = musicTypeObject[\"playback_options\"][thisPlaylistNumber]\n// Generate a list of players to group for playback based on the config\nplayers = \"\"\n// Blanket copy the music type's definition of participants onto the individual playback option\nmusicToPlay[\"participants\"] = musicTypeObject[\"participants\"]\n// Iterate over all participants in this music playback type\nmusicTypeObject[\"participants\"].forEach(function(participant, index) {\n    // Take the name of this player participants and add it to the list of all participants\n    players = players + participant.player_name + \",\"\n    // The specific playback option's volume varies based on a multiplier\n    musicToPlay[\"participants\"].forEach(function(playbackParticipant) {\n        if (playbackParticipant.player_name == participant.player_name) {\n            // Determine appropriate volume for this participant using:\n            //  * default from playback type for this speaker\n            //  * multiplier for this playback option\n            playbackParticipant.volume = Math.round(participant.default_volume * musicToPlay.volume_multiplier)\n        }\n    });\n    // Mute all players being engaged in this group\n    muteMsg = {}\n    muteMsg.payload = \"on\"\n    muteMsg.playerName = participant.player_name\n    node.send([null, null, muteMsg, null])\n});\n// Strip last comma\nplayers = players.replace(/,$/, ''); \n\n// Get lead player\nleadPlayerName = musicToPlay.participants[0].player_name\n\n// Playback is initiated by building the group and providing instructions to lead player\nplayMsg = {}\nplayMsg.payload = players\nplayMsg.playerName = leadPlayerName\nplayMsg.command = musicToPlay.command \nplayMsg.uri = musicToPlay.uri\n\ncurrentlyPlayingMusic = {}\ncurrentlyPlayingMusic.payload = musicToPlay\ncurrentlyPlayingMusic.payload.leadPlayer = leadPlayerName\n\n// Need a new playlist numbers object\nincrementMsg = {}\n// If this playlist number for the given type of music would exceed the number of options, roll it over\nif ((musicPlaylistNumbers[musicType] + 1) >= musicConfig[musicType][\"playback_options\"].length) {\n    musicPlaylistNumbers[musicType] = 0\n} else {\n    // Otherwise increment it\n    musicPlaylistNumbers[musicType] = musicPlaylistNumbers[musicType] + 1\n}\nincrementMsg.payload = musicPlaylistNumbers\n\nreturn [ playMsg, currentlyPlayingMusic, null, incrementMsg ] ",
        "outputs": 4,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 680,
        "y": 100,
        "wires": [
            [
                "fa5a15fef36b436f"
            ],
            [
                "3399e992f8964d12"
            ],
            [
                "74c73e32cb11e451"
            ],
            [
                "e42d1eba960ea3cd"
            ]
        ]
    },
    {
        "id": "e42d1eba960ea3cd",
        "type": "set-shared-state",
        "z": "90f5fe8cb80ae6a7",
        "state": "659fd61043193a4d",
        "name": "Music Playlist Numbers",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 950,
        "y": 260,
        "wires": []
    },
    {
        "id": "1d4b9e7c11ac066c",
        "type": "comment",
        "z": "90f5fe8cb80ae6a7",
        "name": "Music Playback",
        "info": "",
        "x": 100,
        "y": 40,
        "wires": []
    },
    {
        "id": "fa5a15fef36b436f",
        "type": "sonos-universal",
        "z": "90f5fe8cb80ae6a7",
        "confignode": "eb483a028b06c90a",
        "command": "household.create.group",
        "state": "",
        "stateType": "str",
        "avoidCheckPlayerAvailability": false,
        "name": "Create playback group",
        "x": 960,
        "y": 80,
        "wires": [
            [
                "c6ad1e291fee6488"
            ]
        ]
    },
    {
        "id": "d6f678177a40f732",
        "type": "function",
        "z": "90f5fe8cb80ae6a7",
        "name": "Create participant-specific message",
        "func": "// By default, move to set volume and appropriately unmute all players in current playback\ntargets = global.get(\"state\").currentlyPlayingMusic.value.participants\n// If we were given a single specific target though, downscope\nif (\"target\" in msg) {\n    specificTarget = []\n    targets.forEach(function(participant) {\n        if (participant.player_name == msg.target) {\n            specificTarget = [participant]\n        }\n    });\n    if (specificTarget.length == 0) {\n        node.warn(\"Asked to reset volume and mute state of unrecognized player: \" + msg.target)\n        return null\n    }\n    targets = specificTarget\n}\n\n// Iterate over our targets and kick off setting their volume and mute state\ntargets.forEach(function(target) {\n    participantSpecificMsg = {}\n    participantSpecificMsg.playerName = target.player_name\n    participantSpecificMsg.payload = target.volume\n    if (\"leave_muted_if\" in target) {\n        participantSpecificMsg.leave_muted_if = target.leave_muted_if\n    }\n    node.send(participantSpecificMsg);\n});\n\nreturn null",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2230,
        "y": 280,
        "wires": [
            [
                "84f2d908221dfd98",
                "d9903f7751427a48"
            ]
        ]
    },
    {
        "id": "b14e74697315444e",
        "type": "set-shared-state",
        "z": "90f5fe8cb80ae6a7",
        "state": "8c211e55da1f4c7f",
        "name": "Music Playback Type",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 740,
        "y": 520,
        "wires": []
    },
    {
        "id": "a488c47d3889b063",
        "type": "inject",
        "z": "90f5fe8cb80ae6a7",
        "name": "Make Day Music Playback",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "day",
        "payloadType": "str",
        "x": 410,
        "y": 480,
        "wires": [
            [
                "b14e74697315444e"
            ]
        ]
    },
    {
        "id": "e7e0cc2eed3b11d7",
        "type": "inject",
        "z": "90f5fe8cb80ae6a7",
        "name": "Make Morning Music Playback",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "morning",
        "payloadType": "str",
        "x": 430,
        "y": 440,
        "wires": [
            [
                "b14e74697315444e"
            ]
        ]
    },
    {
        "id": "c576374c5d7f7d68",
        "type": "inject",
        "z": "90f5fe8cb80ae6a7",
        "name": "Manually reactivate music",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 170,
        "y": 280,
        "wires": [
            [
                "551ddc8702a7c82e"
            ]
        ]
    },
    {
        "id": "551ddc8702a7c82e",
        "type": "function",
        "z": "90f5fe8cb80ae6a7",
        "name": "Check if non-null mode",
        "func": "stopMsg = {}\nstopMsg.playerName = global.get(\"state\").currentlyPlayingMusic.value.leadPlayerName\n\nmusicPlaybackType = global.get(\"state\").musicPlaybackType.value\n\n// If it's something other than none/nothing\nif (musicPlaybackType) {\n    return [ msg, stopMsg ]\n}\n// Otherwise just stop current playback\nreturn [ null, stopMsg ]",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 190,
        "y": 160,
        "wires": [
            [
                "c1a50671a5ed2076"
            ],
            [
                "1d6d18eb04f69a2b"
            ]
        ]
    },
    {
        "id": "8b2c1a1d7bbcb289",
        "type": "change",
        "z": "90f5fe8cb80ae6a7",
        "name": "Apply command and URI",
        "rules": [
            {
                "t": "move",
                "p": "uri",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            },
            {
                "t": "move",
                "p": "command",
                "pt": "msg",
                "to": "topic",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1730,
        "y": 80,
        "wires": [
            [
                "f744b5b41bd0fbe0"
            ]
        ]
    },
    {
        "id": "f3ead1f64943f894",
        "type": "get-shared-state",
        "z": "90f5fe8cb80ae6a7",
        "state": "8c211e55da1f4c7f",
        "name": "Music Playback Type",
        "triggerOnInit": false,
        "x": 140,
        "y": 100,
        "wires": [
            [
                "551ddc8702a7c82e"
            ]
        ]
    },
    {
        "id": "a210c969fe06f2f8",
        "type": "comment",
        "z": "90f5fe8cb80ae6a7",
        "name": "Music Mode Management",
        "info": "",
        "x": 130,
        "y": 400,
        "wires": []
    },
    {
        "id": "51870943b81c7c06",
        "type": "get-shared-state",
        "z": "90f5fe8cb80ae6a7",
        "state": "efc87f0de00a2d36",
        "name": "Day Phase",
        "triggerOnInit": false,
        "x": 80,
        "y": 460,
        "wires": [
            [
                "e461ac8aeac7cb0c"
            ]
        ]
    },
    {
        "id": "df392259e60d18fd",
        "type": "inject",
        "z": "90f5fe8cb80ae6a7",
        "name": "No Music Playback",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "str",
        "x": 390,
        "y": 560,
        "wires": [
            [
                "b14e74697315444e"
            ]
        ]
    },
    {
        "id": "91e9e187adcc5b04",
        "type": "get-shared-state",
        "z": "90f5fe8cb80ae6a7",
        "state": "1dd96a4a.9d6316",
        "name": "Anyone Home",
        "triggerOnInit": false,
        "x": 90,
        "y": 520,
        "wires": [
            [
                "c1874bfaab1b2bb3"
            ]
        ]
    },
    {
        "id": "e461ac8aeac7cb0c",
        "type": "function",
        "z": "90f5fe8cb80ae6a7",
        "name": "Set music type based on conditions",
        "func": "// Only play music if someone is home\nif (global.get(\"state\").isAnyoneHome.value == false) {\n    msg.payload = \"\"\n    return msg\n}\n// If anyone is asleep, set to sleep\nif (global.get(\"state\").isAnyoneAsleep.value) {\n    msg.payload = \"sleep\"\n    return msg\n}\n\ndayPhase = global.get(\"state\").dayPhase.value\n\n// If it's day time\nif (dayPhase == \"day\" || dayPhase == \"morning\") {\n    // If what changed was the last person waking up, kick off some music\n    if (msg.topic == \"isAnyoneAsleep\" && msg.payload == false) {\n        // Sunday override\n        var date = new Date();\n        var daynum = date.getDay();\n        // If day is not Sunday\n        if (daynum != 0) {\n            msg.payload = \"morning\"\n            return msg\n        }\n    }\n    // If noone is asleep then day starts\n    if (global.get(\"state\").isAnyoneAsleep.value == false) {\n        msg.payload = \"day\"\n        return msg\n    }\n// If it's sunset\n} else if (dayPhase == \"sunset\"\n        || dayPhase == \"dusk\") {\n    msg.payload = \"evening\"\n    return msg\n} else if (dayPhase == \"winddown\"\n        || dayPhase == \"night\") {\n    // Override for when sleep sounds get started a little early\n    if (global.get(\"state\").musicPlaybackType.value == \"sleep\") {\n        return null\n    }\n    msg.payload = \"winddown\"\n    return msg\n}\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 430,
        "y": 520,
        "wires": [
            [
                "b14e74697315444e"
            ]
        ]
    },
    {
        "id": "199beb67d0b28dd3",
        "type": "get-shared-state",
        "z": "90f5fe8cb80ae6a7",
        "state": "1dd96a4a.9d6316",
        "name": "Anyone Home",
        "triggerOnInit": true,
        "x": 90,
        "y": 860,
        "wires": [
            [
                "ac0919edce9342cb"
            ]
        ]
    },
    {
        "id": "ca90831aed9ec6d3",
        "type": "comment",
        "z": "90f5fe8cb80ae6a7",
        "name": "Shut it all down when we leave",
        "info": "",
        "x": 150,
        "y": 760,
        "wires": []
    },
    {
        "id": "9af76eda23a1c810",
        "type": "function",
        "z": "90f5fe8cb80ae6a7",
        "name": "Break all groups and stop all playback",
        "func": "playerNames = new Set()\n\nmusicConfig = global.get(\"state\").musicConfig.value.music\n\nObject.values(musicConfig).forEach(function(musicType) {\n    musicType.participants.forEach(function(participant) {\n        playerNames.add(participant.player_name)\n    });\n});\n\nplayerNames.forEach(function(playerName) {\n    msg = {}\n    msg.playerName = playerName\n    node.send(msg);\n});",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 690,
        "y": 860,
        "wires": [
            [
                "50a24921684156f7"
            ]
        ]
    },
    {
        "id": "8be0e32634ffd63f",
        "type": "inject",
        "z": "90f5fe8cb80ae6a7",
        "name": "Shutdown all music",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 230,
        "y": 820,
        "wires": [
            [
                "84aa12b53063f146"
            ]
        ]
    },
    {
        "id": "50a24921684156f7",
        "type": "sonos-universal",
        "z": "90f5fe8cb80ae6a7",
        "confignode": "047dcd09c592e040",
        "command": "player.become.standalone",
        "state": "",
        "stateType": "str",
        "avoidCheckPlayerAvailability": false,
        "name": "Break group for player",
        "x": 980,
        "y": 860,
        "wires": [
            [
                "7026db35f0ed25c7"
            ]
        ]
    },
    {
        "id": "7026db35f0ed25c7",
        "type": "sonos-universal",
        "z": "90f5fe8cb80ae6a7",
        "confignode": "047dcd09c592e040",
        "command": "group.clear.queue",
        "state": "",
        "stateType": "str",
        "avoidCheckPlayerAvailability": false,
        "name": "Clear any queue for player",
        "x": 720,
        "y": 920,
        "wires": [
            [
                "a2a8508703720287"
            ]
        ]
    },
    {
        "id": "a2a8508703720287",
        "type": "sonos-universal",
        "z": "90f5fe8cb80ae6a7",
        "confignode": "047dcd09c592e040",
        "command": "group.stop",
        "state": "",
        "stateType": "str",
        "avoidCheckPlayerAvailability": false,
        "name": "Stop any playback for player",
        "x": 1000,
        "y": 920,
        "wires": [
            []
        ]
    },
    {
        "id": "2a368b2441b8e268",
        "type": "comment",
        "z": "90f5fe8cb80ae6a7",
        "name": "Button in guest bathroom for pooper to bump volume up",
        "info": "",
        "x": 230,
        "y": 960,
        "wires": []
    },
    {
        "id": "6ff0fe94ad20f2b0",
        "type": "inject",
        "z": "90f5fe8cb80ae6a7",
        "name": "Bump pooper volumes",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 140,
        "y": 1000,
        "wires": [
            [
                "a16d6614f34882e1"
            ]
        ]
    },
    {
        "id": "a16d6614f34882e1",
        "type": "sonos-universal",
        "z": "90f5fe8cb80ae6a7",
        "confignode": "047dcd09c592e040",
        "command": "group.get.members",
        "state": "",
        "stateType": "str",
        "avoidCheckPlayerAvailability": false,
        "name": "Get participants",
        "x": 620,
        "y": 1000,
        "wires": [
            [
                "1400bc1a11781043"
            ]
        ]
    },
    {
        "id": "222f41b3e4fc44cd",
        "type": "sonos-universal",
        "z": "90f5fe8cb80ae6a7",
        "confignode": "7cd072335f421810",
        "command": "player.get.volume",
        "state": "",
        "stateType": "str",
        "avoidCheckPlayerAvailability": false,
        "name": "Get Volume",
        "x": 1030,
        "y": 1000,
        "wires": [
            [
                "bb35db542533564d"
            ]
        ]
    },
    {
        "id": "1400bc1a11781043",
        "type": "function",
        "z": "90f5fe8cb80ae6a7",
        "name": "Iterate over players",
        "func": "msg.payload.forEach(function(participant) {\n    msg.payload = null\n    msg.playerName = participant.playerName\n    if ([ \"Living Room\", \"Guest Bathroom\", \"Guest Bedroom\" ].indexOf(msg.playerName) > -1) {\n        node.send(msg)\n    }\n});",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 830,
        "y": 1000,
        "wires": [
            [
                "222f41b3e4fc44cd"
            ]
        ]
    },
    {
        "id": "bb35db542533564d",
        "type": "function",
        "z": "90f5fe8cb80ae6a7",
        "name": "Create Adjusted Volume",
        "func": "msg.originalVolume = msg.payload\n\nnew_based_on_percentage = Math.floor(msg.payload * 1.3)\nnew_based_on_minimum = msg.payload + 7\n\nmsg.payload = Math.max(new_based_on_percentage, new_based_on_minimum)\nreturn msg",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 670,
        "y": 1080,
        "wires": [
            [
                "da8a13699f936fa8"
            ]
        ]
    },
    {
        "id": "da8a13699f936fa8",
        "type": "sonos-universal",
        "z": "90f5fe8cb80ae6a7",
        "confignode": "7cd072335f421810",
        "command": "player.set.volume",
        "state": "",
        "stateType": "str",
        "avoidCheckPlayerAvailability": false,
        "name": "Set Higher Volume",
        "x": 910,
        "y": 1080,
        "wires": [
            [
                "827e944640382a04"
            ]
        ]
    },
    {
        "id": "b5802a0f996c0d73",
        "type": "sonos-universal",
        "z": "90f5fe8cb80ae6a7",
        "confignode": "7cd072335f421810",
        "command": "player.set.volume",
        "state": "",
        "stateType": "str",
        "avoidCheckPlayerAvailability": false,
        "name": "Resume volume",
        "x": 940,
        "y": 1160,
        "wires": [
            [
                "4123044d0c15479d"
            ]
        ]
    },
    {
        "id": "1f57ca5d204495b8",
        "type": "change",
        "z": "90f5fe8cb80ae6a7",
        "name": "Bring back original volume",
        "rules": [
            {
                "t": "move",
                "p": "originalVolume",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 700,
        "y": 1160,
        "wires": [
            [
                "b5802a0f996c0d73"
            ]
        ]
    },
    {
        "id": "827e944640382a04",
        "type": "delay",
        "z": "90f5fe8cb80ae6a7",
        "name": "",
        "pauseType": "delay",
        "timeout": "10",
        "timeoutUnits": "minutes",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 1110,
        "y": 1080,
        "wires": [
            [
                "1f57ca5d204495b8"
            ]
        ]
    },
    {
        "id": "cb549f365f52843c",
        "type": "sonos-universal",
        "z": "90f5fe8cb80ae6a7",
        "confignode": "eb483a028b06c90a",
        "command": "group.set.queuemode",
        "state": "SHUFFLE",
        "stateType": "str",
        "avoidCheckPlayerAvailability": false,
        "name": "Set this playlist to shuffle",
        "x": 1710,
        "y": 200,
        "wires": [
            [
                "f4fa70e926f0951f"
            ]
        ]
    },
    {
        "id": "86a9877ef3877d1e",
        "type": "inject",
        "z": "90f5fe8cb80ae6a7",
        "name": "Pick Appropriate Music",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 140,
        "y": 700,
        "wires": [
            [
                "e461ac8aeac7cb0c"
            ]
        ]
    },
    {
        "id": "f60ed212caf6af2e",
        "type": "inject",
        "z": "90f5fe8cb80ae6a7",
        "name": "Make Evening Music Playback",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "evening",
        "payloadType": "str",
        "x": 430,
        "y": 600,
        "wires": [
            [
                "b14e74697315444e"
            ]
        ]
    },
    {
        "id": "f03b35b35db09355",
        "type": "sonos-universal",
        "z": "90f5fe8cb80ae6a7",
        "confignode": "047dcd09c592e040",
        "command": "player.set.mutestate",
        "state": "",
        "stateType": "str",
        "avoidCheckPlayerAvailability": false,
        "name": "Mute Participant",
        "x": 1180,
        "y": 200,
        "wires": [
            []
        ]
    },
    {
        "id": "f4fa70e926f0951f",
        "type": "sonos-universal",
        "z": "90f5fe8cb80ae6a7",
        "confignode": "eb483a028b06c90a",
        "command": "group.next.track",
        "state": "",
        "stateType": "str",
        "avoidCheckPlayerAvailability": false,
        "name": "Skip first track",
        "x": 1920,
        "y": 200,
        "wires": [
            [
                "d6f678177a40f732"
            ]
        ]
    },
    {
        "id": "05e5600da5d5942c",
        "type": "function",
        "z": "90f5fe8cb80ae6a7",
        "name": "Apply unmute criteria",
        "func": "// Does this participant even have this attribute?\nif (\"leave_muted_if\" in msg) {\n    // Iterate over all criteria\n    for (const criteria of msg.leave_muted_if) {\n        // Does the value of the variable match the criteria?\n        if (global.get(\"state\")[criteria.variable].value == criteria.value) {\n            // Mute this player\n            msg.payload = \"on\"\n            return msg\n        }\n    }\n}\n// Unmute this player\nmsg.payload = \"off\"\nreturn msg\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2720,
        "y": 380,
        "wires": [
            [
                "c8ff24ee16293f06"
            ]
        ]
    },
    {
        "id": "80c2cd4fe9e57682",
        "type": "comment",
        "z": "90f5fe8cb80ae6a7",
        "name": "Message here specifies playerName coordinator, but includes all as participants",
        "info": "",
        "x": 1140,
        "y": 40,
        "wires": []
    },
    {
        "id": "be044ab02324dd48",
        "type": "comment",
        "z": "90f5fe8cb80ae6a7",
        "name": "Set volumes and mute states",
        "info": "",
        "x": 2200,
        "y": 240,
        "wires": []
    },
    {
        "id": "32221838690fa0f1",
        "type": "sonos-universal",
        "z": "90f5fe8cb80ae6a7",
        "confignode": "047dcd09c592e040",
        "command": "player.set.mutestate",
        "state": "",
        "stateType": "str",
        "avoidCheckPlayerAvailability": false,
        "name": "Unmute appropriate participants",
        "x": 3130,
        "y": 380,
        "wires": [
            []
        ]
    },
    {
        "id": "4688688d8b43d7e8",
        "type": "change",
        "z": "90f5fe8cb80ae6a7",
        "name": "",
        "rules": [
            {
                "t": "delete",
                "p": "topic",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1470,
        "y": 140,
        "wires": [
            [
                "395f431b6a94ecc2"
            ]
        ]
    },
    {
        "id": "aff6f6e708f7023b",
        "type": "comment",
        "z": "90f5fe8cb80ae6a7",
        "name": "Mute/unmute if criteria changes",
        "info": "",
        "x": 1630,
        "y": 320,
        "wires": []
    },
    {
        "id": "b8aac178ae27949f",
        "type": "get-shared-state",
        "z": "90f5fe8cb80ae6a7",
        "state": "b69e9a96.7fc43",
        "name": "Master Asleep",
        "triggerOnInit": false,
        "x": 1570,
        "y": 380,
        "wires": [
            [
                "a78f9276bce4a401"
            ]
        ]
    },
    {
        "id": "5ccaf2971c6c55ad",
        "type": "get-shared-state",
        "z": "90f5fe8cb80ae6a7",
        "state": "156ccde543ba4845",
        "name": "Guest Asleep",
        "triggerOnInit": false,
        "x": 1570,
        "y": 440,
        "wires": [
            [
                "a78f9276bce4a401"
            ]
        ]
    },
    {
        "id": "d5f59723898a7298",
        "type": "change",
        "z": "90f5fe8cb80ae6a7",
        "name": "Set blank value",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 720,
        "y": 800,
        "wires": [
            [
                "f9f43e5b15149e43"
            ]
        ]
    },
    {
        "id": "f9f43e5b15149e43",
        "type": "set-shared-state",
        "z": "90f5fe8cb80ae6a7",
        "state": "8c211e55da1f4c7f",
        "name": "Music Playback Type",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 940,
        "y": 800,
        "wires": []
    },
    {
        "id": "519ba9e8deaad0cb",
        "type": "homekit-service",
        "z": "90f5fe8cb80ae6a7",
        "isParent": true,
        "hostType": "0",
        "bridge": "b2cc5799.eea9d",
        "accessoryId": "",
        "parentService": "",
        "name": "Pooper",
        "serviceName": "Switch",
        "topic": "",
        "filter": false,
        "manufacturer": "NRCHKB",
        "model": "1.4.3",
        "serialNo": "Default Serial Number",
        "firmwareRev": "1.4.3",
        "hardwareRev": "1.4.3",
        "softwareRev": "1.4.3",
        "cameraConfigVideoProcessor": "ffmpeg",
        "cameraConfigSource": "",
        "cameraConfigStillImageSource": "",
        "cameraConfigMaxStreams": 2,
        "cameraConfigMaxWidth": 1280,
        "cameraConfigMaxHeight": 720,
        "cameraConfigMaxFPS": 10,
        "cameraConfigMaxBitrate": 300,
        "cameraConfigVideoCodec": "libx264",
        "cameraConfigAudioCodec": "libfdk_aac",
        "cameraConfigAudio": false,
        "cameraConfigPacketSize": 1316,
        "cameraConfigVerticalFlip": false,
        "cameraConfigHorizontalFlip": false,
        "cameraConfigMapVideo": "0:0",
        "cameraConfigMapAudio": "0:1",
        "cameraConfigVideoFilter": "scale=1280:720",
        "cameraConfigAdditionalCommandLine": "-tune zerolatency",
        "cameraConfigDebug": false,
        "cameraConfigSnapshotOutput": "disabled",
        "cameraConfigInterfaceName": "",
        "characteristicProperties": "{}",
        "waitForSetupMsg": false,
        "outputs": 2,
        "x": 300,
        "y": 1160,
        "wires": [
            [
                "1147be5849344bdf"
            ],
            []
        ]
    },
    {
        "id": "4123044d0c15479d",
        "type": "change",
        "z": "90f5fe8cb80ae6a7",
        "name": "Turn off",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            },
            {
                "t": "set",
                "p": "payload.On",
                "pt": "msg",
                "to": "false",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1120,
        "y": 1160,
        "wires": [
            [
                "519ba9e8deaad0cb"
            ]
        ]
    },
    {
        "id": "1147be5849344bdf",
        "type": "switch",
        "z": "90f5fe8cb80ae6a7",
        "name": "If Turned On",
        "property": "payload.On",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 430,
        "y": 1080,
        "wires": [
            [
                "a16d6614f34882e1"
            ]
        ]
    },
    {
        "id": "3399e992f8964d12",
        "type": "set-shared-state",
        "z": "90f5fe8cb80ae6a7",
        "state": "b74697c734ad5557",
        "name": "Currently Playing Music",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 970,
        "y": 140,
        "wires": []
    },
    {
        "id": "c8ff24ee16293f06",
        "type": "delay",
        "z": "90f5fe8cb80ae6a7",
        "name": "",
        "pauseType": "rate",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 2910,
        "y": 380,
        "wires": [
            [
                "32221838690fa0f1"
            ]
        ]
    },
    {
        "id": "a78f9276bce4a401",
        "type": "function",
        "z": "90f5fe8cb80ae6a7",
        "name": "Determine if this variable is relevant",
        "func": "// Get the participants in the currently playing music, which are our active players\nactivePlayers = global.get(\"state\").currentlyPlayingMusic.value.participants\n\n// For each of the active players, check if the changed variable is the condition\nactivePlayers.forEach(function(participant) {\n    // Players may not even have a criteria\n    if (\"leave_muted_if\" in participant) {\n        // Iterate over all criteria\n        participant.leave_muted_if.forEach(function(criteria) {\n            // This criteria is the one that changed\n            if (msg.topic == criteria.variable) {\n                newMsg = {}\n                newMsg.target = participant.player_name\n                node.send(newMsg)\n            }\n        });\n    }\n});\n\nreturn null",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1820,
        "y": 380,
        "wires": [
            [
                "d6f678177a40f732"
            ]
        ]
    },
    {
        "id": "b0a4618460362b3d",
        "type": "inject",
        "z": "90f5fe8cb80ae6a7",
        "name": "Make Winddown Playback",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "winddown",
        "payloadType": "str",
        "x": 410,
        "y": 640,
        "wires": [
            [
                "b14e74697315444e"
            ]
        ]
    },
    {
        "id": "7e52276e5e6c0bf5",
        "type": "change",
        "z": "90f5fe8cb80ae6a7",
        "name": "Turn on",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            },
            {
                "t": "set",
                "p": "payload.On",
                "pt": "msg",
                "to": "true",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 100,
        "y": 1160,
        "wires": [
            [
                "519ba9e8deaad0cb"
            ]
        ]
    },
    {
        "id": "a657b9091453b569",
        "type": "inject",
        "z": "90f5fe8cb80ae6a7",
        "name": "Force volume reset",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 1890,
        "y": 320,
        "wires": [
            [
                "d6f678177a40f732"
            ]
        ]
    },
    {
        "id": "64c5ae2169f431b3",
        "type": "inject",
        "z": "90f5fe8cb80ae6a7",
        "name": "Make Sleep Playback",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "sleep",
        "payloadType": "str",
        "x": 400,
        "y": 680,
        "wires": [
            [
                "b14e74697315444e"
            ]
        ]
    },
    {
        "id": "e8cd723e91c84e9f",
        "type": "get-shared-state",
        "z": "90f5fe8cb80ae6a7",
        "state": "3d96ef25996d1dd1",
        "name": "Reset",
        "triggerOnInit": false,
        "x": 90,
        "y": 220,
        "wires": [
            [
                "551ddc8702a7c82e"
            ]
        ]
    },
    {
        "id": "0637e774c1000926",
        "type": "get-shared-state",
        "z": "90f5fe8cb80ae6a7",
        "state": "26ccc92b36b23b99",
        "name": "Anyone Asleep",
        "triggerOnInit": false,
        "x": 100,
        "y": 640,
        "wires": [
            [
                "e461ac8aeac7cb0c"
            ]
        ]
    },
    {
        "id": "cf4660e2535faee1",
        "type": "comment",
        "z": "90f5fe8cb80ae6a7",
        "name": "Monitor for whether TV is playing",
        "info": "",
        "x": 150,
        "y": 1240,
        "wires": []
    },
    {
        "id": "22a942ce5b9137fe",
        "type": "server-state-changed",
        "z": "90f5fe8cb80ae6a7",
        "name": "Sense if Apple TV is playing",
        "server": "3ec50562615a9f50",
        "version": 4,
        "exposeToHomeAssistant": false,
        "haConfig": [
            {
                "property": "name",
                "value": ""
            },
            {
                "property": "icon",
                "value": ""
            }
        ],
        "entityidfilter": "media_player.big_beautiful_oled",
        "entityidfiltertype": "exact",
        "outputinitially": false,
        "state_type": "str",
        "haltifstate": "playing",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "outputs": 2,
        "output_only_on_state_change": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "true",
                "valueType": "bool"
            }
        ],
        "x": 160,
        "y": 1280,
        "wires": [
            [
                "f6e3848f50908c06"
            ],
            []
        ]
    },
    {
        "id": "51c32d5740a1645d",
        "type": "server-state-changed",
        "z": "90f5fe8cb80ae6a7",
        "name": "Sense if Apple TV is not playing",
        "server": "3ec50562615a9f50",
        "version": 4,
        "exposeToHomeAssistant": false,
        "haConfig": [
            {
                "property": "name",
                "value": ""
            },
            {
                "property": "icon",
                "value": ""
            }
        ],
        "entityidfilter": "media_player.big_beautiful_oled",
        "entityidfiltertype": "exact",
        "outputinitially": false,
        "state_type": "str",
        "haltifstate": "playing",
        "halt_if_type": "str",
        "halt_if_compare": "is_not",
        "outputs": 2,
        "output_only_on_state_change": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "false",
                "valueType": "bool"
            }
        ],
        "x": 170,
        "y": 1340,
        "wires": [
            [
                "f6e3848f50908c06"
            ],
            []
        ]
    },
    {
        "id": "f6e3848f50908c06",
        "type": "set-shared-state",
        "z": "90f5fe8cb80ae6a7",
        "state": "e1e1553b9b6a27c9",
        "name": "Is Apple TV Playing?",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 440,
        "y": 1300,
        "wires": []
    },
    {
        "id": "99a3622344a19b92",
        "type": "get-shared-state",
        "z": "90f5fe8cb80ae6a7",
        "state": "d9abb6b3441e0c2a",
        "name": "Is TV Playing?",
        "triggerOnInit": false,
        "x": 1570,
        "y": 500,
        "wires": [
            [
                "a78f9276bce4a401"
            ]
        ]
    },
    {
        "id": "5a298bb857e474e1",
        "type": "inject",
        "z": "90f5fe8cb80ae6a7",
        "name": "Wipe playlist numbers",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{}",
        "payloadType": "json",
        "x": 680,
        "y": 260,
        "wires": [
            [
                "e42d1eba960ea3cd"
            ]
        ]
    },
    {
        "id": "54a9e604802ef8f4",
        "type": "server-events",
        "z": "90f5fe8cb80ae6a7",
        "name": "Sense if there's a Hue event",
        "server": "3ec50562615a9f50",
        "version": 2,
        "eventType": "hue_event",
        "exposeToHomeAssistant": false,
        "eventData": "",
        "haConfig": [
            {
                "property": "name",
                "value": ""
            },
            {
                "property": "icon",
                "value": ""
            }
        ],
        "waitForRunning": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "$outputData(\"eventData\").event_type",
                "valueType": "jsonata"
            }
        ],
        "event_type": "",
        "x": 160,
        "y": 1040,
        "wires": [
            [
                "8887203cd9731ca8"
            ]
        ]
    },
    {
        "id": "8887203cd9731ca8",
        "type": "function",
        "z": "90f5fe8cb80ae6a7",
        "name": "Check if pooper's button",
        "func": "// If this was anything BUT the pooper's button\nif(msg.payload.event.id != \"poopers_button_button\") {\n    // Do nothing\n    return null\n}\n// If this was anything BUT a short release\nif(msg.payload.event.type != \"short_release\") {\n    // Do nothing\n    return null\n}\n\n// Ok, it was a short release of the pooper's button\nreturn msg",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 150,
        "y": 1100,
        "wires": [
            [
                "7e52276e5e6c0bf5"
            ]
        ]
    },
    {
        "id": "c6ad1e291fee6488",
        "type": "delay",
        "z": "90f5fe8cb80ae6a7",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 1140,
        "y": 80,
        "wires": [
            [
                "ed9bddb805628e39"
            ]
        ]
    },
    {
        "id": "74c73e32cb11e451",
        "type": "delay",
        "z": "90f5fe8cb80ae6a7",
        "name": "Delay",
        "pauseType": "delay",
        "timeout": "100",
        "timeoutUnits": "milliseconds",
        "rate": "10",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 910,
        "y": 200,
        "wires": [
            [
                "f20a5ab810409235"
            ]
        ]
    },
    {
        "id": "b96e92eb32250a11",
        "type": "delay",
        "z": "90f5fe8cb80ae6a7",
        "name": "",
        "pauseType": "delay",
        "timeout": "100",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 1530,
        "y": 80,
        "wires": [
            [
                "8b2c1a1d7bbcb289"
            ]
        ]
    },
    {
        "id": "395f431b6a94ecc2",
        "type": "delay",
        "z": "90f5fe8cb80ae6a7",
        "name": "",
        "pauseType": "delay",
        "timeout": "750",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 1650,
        "y": 140,
        "wires": [
            [
                "1e65c8e512e5da5c"
            ]
        ]
    },
    {
        "id": "84f2d908221dfd98",
        "type": "delay",
        "z": "90f5fe8cb80ae6a7",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "2",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 2540,
        "y": 380,
        "wires": [
            [
                "05e5600da5d5942c"
            ]
        ]
    },
    {
        "id": "d9903f7751427a48",
        "type": "delay",
        "z": "90f5fe8cb80ae6a7",
        "name": "",
        "pauseType": "rate",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "2",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 2550,
        "y": 180,
        "wires": [
            [
                "ecc73635aa91485a"
            ]
        ]
    },
    {
        "id": "c1a50671a5ed2076",
        "type": "delay",
        "z": "90f5fe8cb80ae6a7",
        "name": "Limit",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "10",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": false,
        "outputs": 1,
        "x": 370,
        "y": 100,
        "wires": [
            [
                "15448e0eedc040e8"
            ]
        ]
    },
    {
        "id": "c1874bfaab1b2bb3",
        "type": "delay",
        "z": "90f5fe8cb80ae6a7",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "minutes",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 120,
        "y": 580,
        "wires": [
            [
                "e461ac8aeac7cb0c"
            ]
        ]
    },
    {
        "id": "35d2e1491d3ecc24",
        "type": "catch",
        "z": "90f5fe8cb80ae6a7",
        "name": "Catch Sonos Error",
        "scope": [
            "f744b5b41bd0fbe0",
            "fa5a15fef36b436f",
            "1e65c8e512e5da5c"
        ],
        "uncaught": false,
        "x": 130,
        "y": 320,
        "wires": [
            [
                "bf3a7ded5059b145"
            ]
        ]
    },
    {
        "id": "bf3a7ded5059b145",
        "type": "delay",
        "z": "90f5fe8cb80ae6a7",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "10",
        "rateUnits": "minute",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": false,
        "outputs": 1,
        "x": 320,
        "y": 320,
        "wires": [
            [
                "a09328f28a47fb2f"
            ]
        ]
    },
    {
        "id": "3b5eb7152ac47fa3",
        "type": "get-shared-state",
        "z": "90f5fe8cb80ae6a7",
        "state": "3e3052d11dc41010",
        "name": "Is Guest Bedroom Door Open?",
        "triggerOnInit": false,
        "x": 1630,
        "y": 560,
        "wires": [
            [
                "a78f9276bce4a401"
            ]
        ]
    },
    {
        "id": "a09328f28a47fb2f",
        "type": "delay",
        "z": "90f5fe8cb80ae6a7",
        "name": "",
        "pauseType": "delay",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 480,
        "y": 320,
        "wires": [
            [
                "551ddc8702a7c82e"
            ]
        ]
    },
    {
        "id": "b1f2b5145a191585",
        "type": "link in",
        "z": "90f5fe8cb80ae6a7",
        "name": "Reset Music",
        "links": [],
        "x": 205,
        "y": 220,
        "wires": [
            [
                "551ddc8702a7c82e"
            ]
        ]
    },
    {
        "id": "79018d6defd9929e",
        "type": "sonos-universal",
        "z": "90f5fe8cb80ae6a7",
        "confignode": "440f06b05d48d38b",
        "command": "player.become.standalone",
        "state": "",
        "stateType": "str",
        "avoidCheckPlayerAvailability": false,
        "name": "Remove guest bedroom from playback group",
        "x": 1200,
        "y": 380,
        "wires": [
            []
        ]
    },
    {
        "id": "823b2a56df8a8c2d",
        "type": "comment",
        "z": "90f5fe8cb80ae6a7",
        "name": "Aggressively protect guest from audio",
        "info": "",
        "x": 890,
        "y": 340,
        "wires": []
    },
    {
        "id": "b9e8dc1f3cc5bb45",
        "type": "get-shared-state",
        "z": "90f5fe8cb80ae6a7",
        "state": "156ccde543ba4845",
        "name": "Guest Asleep",
        "triggerOnInit": false,
        "x": 810,
        "y": 380,
        "wires": [
            [
                "bb8bbe7668b007b3"
            ]
        ]
    },
    {
        "id": "bb8bbe7668b007b3",
        "type": "switch",
        "z": "90f5fe8cb80ae6a7",
        "d": true,
        "name": "If True",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 950,
        "y": 380,
        "wires": [
            [
                "79018d6defd9929e"
            ]
        ]
    },
    {
        "id": "3abcf1a8523e994c",
        "type": "comment",
        "z": "90f5fe8cb80ae6a7",
        "name": "Set Volumes",
        "info": "",
        "x": 2550,
        "y": 140,
        "wires": []
    },
    {
        "id": "0b54c55fc3673dc2",
        "type": "comment",
        "z": "90f5fe8cb80ae6a7",
        "name": "Set mute states (after volumes and with blind sleep)",
        "info": "",
        "x": 2670,
        "y": 340,
        "wires": []
    },
    {
        "id": "274f237edf2f1bd7",
        "type": "comment",
        "z": "90f5fe8cb80ae6a7",
        "name": "Monitor for whether TV is on",
        "info": "",
        "x": 700,
        "y": 1240,
        "wires": []
    },
    {
        "id": "54b3e77834091de8",
        "type": "server-state-changed",
        "z": "90f5fe8cb80ae6a7",
        "name": "Sense if TV is on",
        "server": "3ec50562615a9f50",
        "version": 4,
        "exposeToHomeAssistant": false,
        "haConfig": [
            {
                "property": "name",
                "value": ""
            },
            {
                "property": "icon",
                "value": ""
            }
        ],
        "entityidfilter": "remote.sony_xr_65a80k",
        "entityidfiltertype": "exact",
        "outputinitially": false,
        "state_type": "str",
        "haltifstate": "on",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "outputs": 2,
        "output_only_on_state_change": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "true",
                "valueType": "bool"
            }
        ],
        "x": 680,
        "y": 1280,
        "wires": [
            [
                "5e0f976532de47d8",
                "86d4e21e11d6bf10"
            ],
            []
        ]
    },
    {
        "id": "5e0f976532de47d8",
        "type": "set-shared-state",
        "z": "90f5fe8cb80ae6a7",
        "state": "9784d6c488d7a77e",
        "name": "Is TV On?",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 920,
        "y": 1300,
        "wires": []
    },
    {
        "id": "577710b513289538",
        "type": "server-state-changed",
        "z": "90f5fe8cb80ae6a7",
        "name": "Sense if TV is off",
        "server": "3ec50562615a9f50",
        "version": 4,
        "exposeToHomeAssistant": false,
        "haConfig": [
            {
                "property": "name",
                "value": ""
            },
            {
                "property": "icon",
                "value": ""
            }
        ],
        "entityidfilter": "remote.sony_xr_65a80k",
        "entityidfiltertype": "exact",
        "outputinitially": false,
        "state_type": "str",
        "haltifstate": "off",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "outputs": 2,
        "output_only_on_state_change": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "false",
                "valueType": "bool"
            }
        ],
        "x": 680,
        "y": 1340,
        "wires": [
            [
                "5e0f976532de47d8"
            ],
            []
        ]
    },
    {
        "id": "304eb5d8976b8c42",
        "type": "comment",
        "z": "90f5fe8cb80ae6a7",
        "name": "Force TV to use soundbar b/c TV is dumb and picks the wrong one every time",
        "info": "",
        "x": 290,
        "y": 1420,
        "wires": []
    },
    {
        "id": "34bd02b0a6ce0a3f",
        "type": "link in",
        "z": "90f5fe8cb80ae6a7",
        "name": "Set Volumes and Mute",
        "links": [
            "9cf90b7812a7ab73",
            "4a3bdf6826669285"
        ],
        "x": 1965,
        "y": 260,
        "wires": [
            [
                "d6f678177a40f732"
            ]
        ]
    },
    {
        "id": "22f2d17d21e14f6e",
        "type": "sonos-universal",
        "z": "90f5fe8cb80ae6a7",
        "confignode": "80cf2bfc253ff8c2",
        "command": "player.get.volume",
        "state": "",
        "stateType": "str",
        "avoidCheckPlayerAvailability": false,
        "name": "Get a volume",
        "x": 2930,
        "y": 180,
        "wires": [
            [
                "06b5888b90359103"
            ]
        ]
    },
    {
        "id": "ecc73635aa91485a",
        "type": "change",
        "z": "90f5fe8cb80ae6a7",
        "name": "Save desired volume",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "desired_volume",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2740,
        "y": 180,
        "wires": [
            [
                "22f2d17d21e14f6e"
            ]
        ]
    },
    {
        "id": "06b5888b90359103",
        "type": "function",
        "z": "90f5fe8cb80ae6a7",
        "name": "Branch out volume turn ups",
        "func": "current_volume = msg.payload\n\ndesired_volume = msg.desired_volume\n\nif (current_volume < desired_volume) {\n    current_volume++\n    msg.payload = current_volume\n    msg.last_volume_set = current_volume\n    node.send([msg, msg])\n} else {\n    msg.payload = desired_volume\n    node.send([msg, null])\n}",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 3140,
        "y": 180,
        "wires": [
            [
                "fbef539b9c81e0e4"
            ],
            [
                "478c37ee53f595cf"
            ]
        ]
    },
    {
        "id": "e53ccbfadb71b977",
        "type": "sonos-universal",
        "z": "90f5fe8cb80ae6a7",
        "confignode": "80cf2bfc253ff8c2",
        "command": "player.set.volume",
        "state": "",
        "stateType": "str",
        "avoidCheckPlayerAvailability": false,
        "name": "Set a volume",
        "x": 3310,
        "y": 280,
        "wires": [
            []
        ]
    },
    {
        "id": "fbef539b9c81e0e4",
        "type": "delay",
        "z": "90f5fe8cb80ae6a7",
        "name": "",
        "pauseType": "rate",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "2",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 3150,
        "y": 280,
        "wires": [
            [
                "e53ccbfadb71b977"
            ]
        ]
    },
    {
        "id": "478c37ee53f595cf",
        "type": "delay",
        "z": "90f5fe8cb80ae6a7",
        "name": "Delay",
        "pauseType": "delayv",
        "timeout": "20",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 2530,
        "y": 280,
        "wires": [
            [
                "64fb15a8a7187bb5"
            ]
        ]
    },
    {
        "id": "9637e0e343385196",
        "type": "function",
        "z": "90f5fe8cb80ae6a7",
        "name": "Repeat turn ups until done",
        "func": "// What is the volume currently?\ncurrent_volume = msg.payload\n\n// Check for someone fighting the system\nif (current_volume < msg.last_volume_set) {\n    // If the volume is less than what was last set, assume someone\n    // is fighting the system trying to turn down the volume\n    return null\n}\n\n// What is the volume supposed to be?\ndesired_volume = msg.desired_volume\n\n// If we haven't gotten up to the desired volume\nif (current_volume < desired_volume) {\n    // The new set volume is current + 1\n    new_volume = current_volume + 1\n    // This new volume is the payload\n    msg.payload = new_volume\n    // Separately save off the value we're setting\n    msg.last_volume_set = new_volume\n    // Set the delay for the next turn up to be greater if volume is lower\n    msg.delay = (100 - current_volume) * 1000\n    // Send the change\n    node.send(msg)\n}\n\n// We're done, everything is as it should be",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2880,
        "y": 280,
        "wires": [
            [
                "478c37ee53f595cf",
                "fbef539b9c81e0e4"
            ]
        ]
    },
    {
        "id": "2ac64818b1503ff5",
        "type": "comment",
        "z": "90f5fe8cb80ae6a7",
        "name": "If volume decrease, it's immediate",
        "info": "",
        "x": 3220,
        "y": 240,
        "wires": []
    },
    {
        "id": "18aa5fb312ee3408",
        "type": "comment",
        "z": "90f5fe8cb80ae6a7",
        "name": "Break out volume increase and do slowly",
        "info": "",
        "x": 3100,
        "y": 140,
        "wires": []
    },
    {
        "id": "f6379d3ea7c03bbf",
        "type": "comment",
        "z": "90f5fe8cb80ae6a7",
        "name": "Allow calling from other flows",
        "info": "",
        "x": 1820,
        "y": 260,
        "wires": []
    },
    {
        "id": "b1b296e25475539b",
        "type": "comment",
        "z": "90f5fe8cb80ae6a7",
        "name": "If volume increase, do in one unit steps",
        "info": "",
        "x": 2630,
        "y": 240,
        "wires": []
    },
    {
        "id": "53d4e4efdc24769d",
        "type": "get-shared-state",
        "z": "90f5fe8cb80ae6a7",
        "state": "8c211e55da1f4c7f",
        "name": "Music Playback Type",
        "triggerOnInit": false,
        "x": 840,
        "y": 680,
        "wires": [
            [
                "1f2c2279830e6f01"
            ]
        ]
    },
    {
        "id": "547ddda64a1b6148",
        "type": "comment",
        "z": "90f5fe8cb80ae6a7",
        "name": "Set all speaker volumes to 0 when sleep starts",
        "info": "",
        "x": 910,
        "y": 640,
        "wires": []
    },
    {
        "id": "1f2c2279830e6f01",
        "type": "switch",
        "z": "90f5fe8cb80ae6a7",
        "name": "if sleep",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "sleep",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1020,
        "y": 680,
        "wires": [
            [
                "04d8ead9f50cc124"
            ]
        ]
    },
    {
        "id": "04d8ead9f50cc124",
        "type": "function",
        "z": "90f5fe8cb80ae6a7",
        "name": "For all speakers generate volume 0 msg",
        "func": "playerNames = new Set()\n\nmusicConfig = global.get(\"state\").musicConfig.value\n\nObject.values(musicConfig).forEach(function(musicType) {\n    musicType.participants.forEach(function(participant) {\n        playerNames.add(participant.player_name)\n    });\n});\n\nplayerNames.forEach(function(playerName) {\n    msg = {}\n    msg.playerName = playerName\n    msg.payload = 0\n    node.send(msg);\n});",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1260,
        "y": 680,
        "wires": [
            [
                "dfd5eadfaffa3982"
            ]
        ]
    },
    {
        "id": "dfd5eadfaffa3982",
        "type": "sonos-universal",
        "z": "90f5fe8cb80ae6a7",
        "confignode": "80cf2bfc253ff8c2",
        "command": "player.set.volume",
        "state": "",
        "stateType": "str",
        "avoidCheckPlayerAvailability": false,
        "name": "Set a volume",
        "x": 1510,
        "y": 680,
        "wires": [
            []
        ]
    },
    {
        "id": "f20a5ab810409235",
        "type": "delay",
        "z": "90f5fe8cb80ae6a7",
        "name": "Limit",
        "pauseType": "rate",
        "timeout": "100",
        "timeoutUnits": "milliseconds",
        "rate": "2",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 1030,
        "y": 200,
        "wires": [
            [
                "f03b35b35db09355"
            ]
        ]
    },
    {
        "id": "ac0919edce9342cb",
        "type": "switch",
        "z": "90f5fe8cb80ae6a7",
        "name": "If noone home",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 260,
        "y": 860,
        "wires": [
            [
                "84aa12b53063f146"
            ]
        ]
    },
    {
        "id": "8a79fe3b400b6c66",
        "type": "link in",
        "z": "90f5fe8cb80ae6a7",
        "name": "Stop all Music Playback",
        "links": [
            "37f338bf292f6dfb",
            "1d6d18eb04f69a2b"
        ],
        "x": 435,
        "y": 860,
        "wires": [
            [
                "9af76eda23a1c810"
            ]
        ]
    },
    {
        "id": "1d6d18eb04f69a2b",
        "type": "link out",
        "z": "90f5fe8cb80ae6a7",
        "name": "Stop all Music Playback",
        "mode": "link",
        "links": [
            "8a79fe3b400b6c66"
        ],
        "x": 355,
        "y": 180,
        "wires": []
    },
    {
        "id": "15448e0eedc040e8",
        "type": "delay",
        "z": "90f5fe8cb80ae6a7",
        "name": "Delay",
        "pauseType": "delay",
        "timeout": "10",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "10",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": false,
        "outputs": 1,
        "x": 490,
        "y": 100,
        "wires": [
            [
                "2af7ad02c544ef24"
            ]
        ]
    },
    {
        "id": "84aa12b53063f146",
        "type": "change",
        "z": "90f5fe8cb80ae6a7",
        "name": "Aggregate",
        "rules": [],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 450,
        "y": 800,
        "wires": [
            [
                "9af76eda23a1c810",
                "d5f59723898a7298"
            ]
        ]
    },
    {
        "id": "64fb15a8a7187bb5",
        "type": "sonos-universal",
        "z": "90f5fe8cb80ae6a7",
        "confignode": "80cf2bfc253ff8c2",
        "command": "player.get.volume",
        "state": "",
        "stateType": "str",
        "avoidCheckPlayerAvailability": false,
        "name": "Get a volume",
        "x": 2670,
        "y": 280,
        "wires": [
            [
                "9637e0e343385196"
            ]
        ]
    },
    {
        "id": "cde489975cb390df",
        "type": "api-current-state",
        "z": "90f5fe8cb80ae6a7",
        "name": "",
        "server": "3ec50562615a9f50",
        "version": 3,
        "outputs": 2,
        "halt_if": "on",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "media_player.sony_xr_65a80k",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "$entity().attributes.media_content_id",
                "valueType": "jsonata"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "seconds",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 430,
        "y": 1660,
        "wires": [
            [
                "aa51ad0395e3d10c"
            ],
            []
        ]
    },
    {
        "id": "fc52884908f8d65e",
        "type": "inject",
        "z": "90f5fe8cb80ae6a7",
        "name": "Constantly re-check",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "5",
        "crontab": "",
        "once": true,
        "onceDelay": "5",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 140,
        "y": 1660,
        "wires": [
            [
                "cde489975cb390df"
            ]
        ]
    },
    {
        "id": "aa51ad0395e3d10c",
        "type": "switch",
        "z": "90f5fe8cb80ae6a7",
        "name": "If Apple TV is selected",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "cont",
                "v": "port=4",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 740,
        "y": 1660,
        "wires": [
            [
                "e846ec9142631cad"
            ],
            [
                "5a57e4e428d0e3a5"
            ]
        ]
    },
    {
        "id": "e846ec9142631cad",
        "type": "function",
        "z": "90f5fe8cb80ae6a7",
        "name": "Is AppleTV Playing?",
        "func": "isAppleTVPlaying = global.get(\"state\").isAppleTVPlaying.value\n\nmsg.payload = isAppleTVPlaying\n\nreturn msg",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 980,
        "y": 1620,
        "wires": [
            [
                "3a2abf13674ba857"
            ]
        ]
    },
    {
        "id": "3a2abf13674ba857",
        "type": "set-shared-state",
        "z": "90f5fe8cb80ae6a7",
        "state": "d9abb6b3441e0c2a",
        "name": "Is TV Playing?",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 1300,
        "y": 1640,
        "wires": []
    },
    {
        "id": "5a57e4e428d0e3a5",
        "type": "change",
        "z": "90f5fe8cb80ae6a7",
        "name": "Not Apple TV, so assume playing",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "true",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1020,
        "y": 1680,
        "wires": [
            [
                "3a2abf13674ba857"
            ]
        ]
    },
    {
        "id": "702ba39cf7ca783e",
        "type": "get-shared-state",
        "z": "90f5fe8cb80ae6a7",
        "state": "9784d6c488d7a77e",
        "name": "Is TV On?",
        "triggerOnInit": true,
        "x": 660,
        "y": 1460,
        "wires": [
            [
                "fa984448bec53a54"
            ]
        ]
    },
    {
        "id": "fa984448bec53a54",
        "type": "switch",
        "z": "90f5fe8cb80ae6a7",
        "name": "If TV is Off",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 810,
        "y": 1460,
        "wires": [
            [
                "f505bd0ac65893f2"
            ]
        ]
    },
    {
        "id": "f505bd0ac65893f2",
        "type": "set-shared-state",
        "z": "90f5fe8cb80ae6a7",
        "state": "d9abb6b3441e0c2a",
        "name": "Is TV Playing?",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 980,
        "y": 1460,
        "wires": []
    },
    {
        "id": "be9313d0ce6bbba5",
        "type": "comment",
        "z": "90f5fe8cb80ae6a7",
        "name": "If the TV is off it's not playing",
        "info": "",
        "x": 720,
        "y": 1420,
        "wires": []
    },
    {
        "id": "c9408fc7ae227079",
        "type": "comment",
        "z": "90f5fe8cb80ae6a7",
        "name": "Decide if TV is being used",
        "info": "",
        "x": 130,
        "y": 1600,
        "wires": []
    },
    {
        "id": "5dbf67f588125af7",
        "type": "get-shared-state",
        "z": "90f5fe8cb80ae6a7",
        "state": "d9abb6b3441e0c2a",
        "name": "Is TV Playing?",
        "triggerOnInit": false,
        "x": 90,
        "y": 1460,
        "wires": [
            [
                "451dbae691313c19"
            ]
        ]
    },
    {
        "id": "451dbae691313c19",
        "type": "switch",
        "z": "90f5fe8cb80ae6a7",
        "name": "If TV Playing",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 250,
        "y": 1460,
        "wires": [
            [
                "645726f28db704e6"
            ]
        ]
    },
    {
        "id": "645726f28db704e6",
        "type": "api-call-service",
        "z": "90f5fe8cb80ae6a7",
        "name": "Use Soundbar",
        "server": "3ec50562615a9f50",
        "version": 5,
        "debugenabled": false,
        "domain": "remote",
        "service": "send_command",
        "areaId": [
            "living_room"
        ],
        "deviceId": [
            "ef759f6d3bb61617024ceacfc5e14c12"
        ],
        "entityId": [],
        "data": "{\"command\":\"AudioOutput_AudioSystem\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "payload",
                "valueType": "msg"
            }
        ],
        "queue": "none",
        "x": 420,
        "y": 1460,
        "wires": [
            []
        ]
    },
    {
        "id": "4b461b04a68e6f6e",
        "type": "catch",
        "z": "90f5fe8cb80ae6a7",
        "name": "Ignore errors from HASS Soundbar call",
        "scope": [
            "645726f28db704e6"
        ],
        "uncaught": false,
        "x": 350,
        "y": 1520,
        "wires": [
            []
        ]
    },
    {
        "id": "86d4e21e11d6bf10",
        "type": "ha-api",
        "z": "90f5fe8cb80ae6a7",
        "name": "Restart Apple TV Integration",
        "server": "3ec50562615a9f50",
        "version": 1,
        "debugenabled": false,
        "protocol": "http",
        "method": "post",
        "path": "config/config_entries/entry/5ee23acf922d850d37cf4eea4b95297b/reload",
        "data": "{}",
        "dataType": "json",
        "responseType": "json",
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "results"
            }
        ],
        "x": 1060,
        "y": 1380,
        "wires": [
            []
        ]
    },
    {
        "id": "e394e3d7d2d0f765",
        "type": "inject",
        "z": "90f5fe8cb80ae6a7",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 840,
        "y": 1380,
        "wires": [
            [
                "86d4e21e11d6bf10"
            ]
        ]
    },
    {
        "id": "d389488a08d98ed3",
        "type": "miio-roborock-command",
        "z": "45c21b8b98ae2f01",
        "name": "Start Vacuuming",
        "server": "b63f730b24581cdc",
        "command_name": "► Start",
        "command": "app_start",
        "commandType": "vacuum_cmd",
        "payload": "payload",
        "payloadType": "msg",
        "coordinates": "",
        "fan_speed": 100,
        "voice_pack": null,
        "homekit_stop_to_dock": false,
        "x": 780,
        "y": 280,
        "wires": [
            [
                "a153aee19cd0e1dd"
            ]
        ]
    },
    {
        "id": "66648323963fb7f3",
        "type": "get-shared-state",
        "z": "45c21b8b98ae2f01",
        "state": "1dd96a4a.9d6316",
        "name": "Anyone Home",
        "triggerOnInit": false,
        "x": 110,
        "y": 320,
        "wires": [
            [
                "808803961811f725",
                "64757357a5ad8757"
            ]
        ]
    },
    {
        "id": "808803961811f725",
        "type": "function",
        "z": "45c21b8b98ae2f01",
        "name": "If noone home",
        "func": "if (global.get(\"state\").isAnyoneHome.value == false) {\n    return msg\n}\n// Somebody is home, do nothing\nreturn null",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 300,
        "y": 280,
        "wires": [
            [
                "943c5232d392ac86"
            ]
        ]
    },
    {
        "id": "a153aee19cd0e1dd",
        "type": "function",
        "z": "45c21b8b98ae2f01",
        "name": "Set last vacuuming timestamp",
        "func": "msg = {}\nmsg.payload = Date.now()\nreturn msg",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1010,
        "y": 280,
        "wires": [
            [
                "3ddae2dbb6c714dd"
            ]
        ]
    },
    {
        "id": "3ddae2dbb6c714dd",
        "type": "set-shared-state",
        "z": "45c21b8b98ae2f01",
        "state": "e498a23d75394b05",
        "name": "Last Vaccuming Timestamp",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 1280,
        "y": 280,
        "wires": []
    },
    {
        "id": "943c5232d392ac86",
        "type": "function",
        "z": "45c21b8b98ae2f01",
        "name": "Run vaccuum if it's been a while",
        "func": "lastVaccuumRunTimestamp = global.get(\"state\").lastVacuumingTimestamp.value\n\ntimeSinceLastRun = Date.now() - lastVaccuumRunTimestamp\n\n// Check against constant threshold in seconds\n// 39600000 == 11 hours\nif (timeSinceLastRun > 39600000) {\n    // It's been too long\n    return msg\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 550,
        "y": 280,
        "wires": [
            [
                "d389488a08d98ed3"
            ]
        ]
    },
    {
        "id": "64757357a5ad8757",
        "type": "function",
        "z": "45c21b8b98ae2f01",
        "name": "If someone just came home",
        "func": "if (global.get(\"state\").isAnyoneHome.value == true) {\n    return msg\n}\n// Somebody is home, do nothing\nreturn null",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 360,
        "wires": [
            [
                "1aa5da490ac08911"
            ]
        ]
    },
    {
        "id": "1aa5da490ac08911",
        "type": "miio-roborock-command",
        "z": "45c21b8b98ae2f01",
        "name": "Stop Vacuuming",
        "server": "b63f730b24581cdc",
        "command_name": "◼ Stop",
        "command": "app_stop",
        "commandType": "vacuum_cmd",
        "payload": "payload",
        "payloadType": "msg",
        "coordinates": "",
        "fan_speed": 100,
        "voice_pack": null,
        "homekit_stop_to_dock": false,
        "x": 580,
        "y": 380,
        "wires": [
            [
                "3d7ba466a8638421"
            ]
        ]
    },
    {
        "id": "b691222a701921cf",
        "type": "inject",
        "z": "45c21b8b98ae2f01",
        "name": "Check late at night",
        "props": [],
        "repeat": "",
        "crontab": "*/20 0-4 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 140,
        "y": 160,
        "wires": [
            [
                "3a29bf394c945c90"
            ]
        ]
    },
    {
        "id": "23498fc68def572a",
        "type": "inject",
        "z": "45c21b8b98ae2f01",
        "name": "Trigger Vaccuming",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 590,
        "y": 240,
        "wires": [
            [
                "d389488a08d98ed3"
            ]
        ]
    },
    {
        "id": "c2505b49fc1c31fb",
        "type": "inject",
        "z": "45c21b8b98ae2f01",
        "name": "Trigger Stop Vaccuming",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 360,
        "y": 320,
        "wires": [
            [
                "1aa5da490ac08911"
            ]
        ]
    },
    {
        "id": "2192d9c1b6dec6df",
        "type": "function",
        "z": "45c21b8b98ae2f01",
        "name": "Check for appropriateness",
        "func": "// If nobody's home just go for it\nif (global.get(\"state\").isAnyoneHome.value == false) {\n    return msg\n}\n\n// If we have guests, bail out\nif (global.get(\"state\").isHaveGuests.value == true) {\n    return null;\n}\n\n// If we have master is not asleep, bail out\nif (global.get(\"state\").isMasterAsleep.value == false) {\n    return null;\n}\n\n// Either nobody's here, or if they are it's just master and NO guests\n\nreturn msg",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 180,
        "y": 240,
        "wires": [
            [
                "943c5232d392ac86"
            ]
        ]
    },
    {
        "id": "8fd8e8bc26facf1d",
        "type": "get-shared-state",
        "z": "45c21b8b98ae2f01",
        "state": "60c1725bc2519ee0",
        "name": "Everyone Asleep",
        "triggerOnInit": false,
        "x": 100,
        "y": 420,
        "wires": [
            [
                "2c632d54825906f3"
            ]
        ]
    },
    {
        "id": "2c632d54825906f3",
        "type": "function",
        "z": "45c21b8b98ae2f01",
        "name": "If someone woke up",
        "func": "if (global.get(\"state\").isEveryoneAsleep.value == false) {\n    return msg\n}\n// Somebody is home, do nothing\nreturn null",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 420,
        "wires": [
            [
                "1aa5da490ac08911"
            ]
        ]
    },
    {
        "id": "6fe06cb1caf05123",
        "type": "inject",
        "z": "45c21b8b98ae2f01",
        "name": "Reset Clean State",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "0",
        "payloadType": "num",
        "x": 1050,
        "y": 340,
        "wires": [
            [
                "3ddae2dbb6c714dd"
            ]
        ]
    },
    {
        "id": "0fda931bf6487d0e",
        "type": "miio-roborock-command",
        "z": "45c21b8b98ae2f01",
        "name": "Dock",
        "server": "b63f730b24581cdc",
        "command_name": "Dock",
        "command": "app_charge",
        "commandType": "vacuum_cmd",
        "payload": "payload",
        "payloadType": "msg",
        "coordinates": "",
        "fan_speed": 100,
        "voice_pack": null,
        "homekit_stop_to_dock": false,
        "x": 870,
        "y": 380,
        "wires": [
            []
        ]
    },
    {
        "id": "3d7ba466a8638421",
        "type": "delay",
        "z": "45c21b8b98ae2f01",
        "name": "",
        "pauseType": "delay",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 740,
        "y": 380,
        "wires": [
            [
                "0fda931bf6487d0e"
            ]
        ]
    },
    {
        "id": "92ec058fd4c3696a",
        "type": "miio-roborock-command",
        "z": "45c21b8b98ae2f01",
        "name": "Clean Kitchen",
        "server": "b63f730b24581cdc",
        "command_name": "► Start room cleaning",
        "command": "app_segment_clean",
        "commandType": "vacuum_cmd",
        "payload": "20",
        "payloadType": "num",
        "coordinates": "",
        "fan_speed": 100,
        "voice_pack": null,
        "homekit_stop_to_dock": false,
        "x": 660,
        "y": 680,
        "wires": [
            []
        ]
    },
    {
        "id": "757c35142723d92d",
        "type": "comment",
        "z": "45c21b8b98ae2f01",
        "name": "Clean Kitchen",
        "info": "",
        "x": 90,
        "y": 640,
        "wires": []
    },
    {
        "id": "14fafc9f6d18a633",
        "type": "change",
        "z": "45c21b8b98ae2f01",
        "name": "Turn off",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            },
            {
                "t": "set",
                "p": "payload.On",
                "pt": "msg",
                "to": "false",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 290,
        "y": 740,
        "wires": [
            [
                "e565d65f50e1abb3"
            ]
        ]
    },
    {
        "id": "dff04e040e879291",
        "type": "delay",
        "z": "45c21b8b98ae2f01",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "minute",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": false,
        "outputs": 1,
        "x": 340,
        "y": 680,
        "wires": [
            [
                "14d24c31ae2299d8"
            ]
        ]
    },
    {
        "id": "30c8dc510f76a88c",
        "type": "inject",
        "z": "45c21b8b98ae2f01",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 130,
        "y": 740,
        "wires": [
            [
                "14fafc9f6d18a633"
            ]
        ]
    },
    {
        "id": "e565d65f50e1abb3",
        "type": "homekit-service",
        "z": "45c21b8b98ae2f01",
        "isParent": true,
        "hostType": "0",
        "bridge": "b2cc5799.eea9d",
        "accessoryId": "",
        "parentService": "",
        "name": "Clean Kitchen",
        "serviceName": "Switch",
        "topic": "",
        "filter": false,
        "manufacturer": "NRCHKB",
        "model": "1.4.3",
        "serialNo": "Default Serial Number",
        "firmwareRev": "1.4.3",
        "hardwareRev": "1.4.3",
        "softwareRev": "1.4.3",
        "cameraConfigVideoProcessor": "ffmpeg",
        "cameraConfigSource": "",
        "cameraConfigStillImageSource": "",
        "cameraConfigMaxStreams": 2,
        "cameraConfigMaxWidth": 1280,
        "cameraConfigMaxHeight": 720,
        "cameraConfigMaxFPS": 10,
        "cameraConfigMaxBitrate": 300,
        "cameraConfigVideoCodec": "libx264",
        "cameraConfigAudioCodec": "libfdk_aac",
        "cameraConfigAudio": false,
        "cameraConfigPacketSize": 1316,
        "cameraConfigVerticalFlip": false,
        "cameraConfigHorizontalFlip": false,
        "cameraConfigMapVideo": "0:0",
        "cameraConfigMapAudio": "0:1",
        "cameraConfigVideoFilter": "scale=1280:720",
        "cameraConfigAdditionalCommandLine": "-tune zerolatency",
        "cameraConfigDebug": false,
        "cameraConfigSnapshotOutput": "disabled",
        "cameraConfigInterfaceName": "",
        "characteristicProperties": "{}",
        "waitForSetupMsg": false,
        "outputs": 2,
        "x": 140,
        "y": 680,
        "wires": [
            [
                "dff04e040e879291"
            ],
            []
        ]
    },
    {
        "id": "14d24c31ae2299d8",
        "type": "switch",
        "z": "45c21b8b98ae2f01",
        "name": "",
        "property": "payload.On",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 490,
        "y": 680,
        "wires": [
            [
                "92ec058fd4c3696a",
                "14fafc9f6d18a633"
            ]
        ]
    },
    {
        "id": "0abf6234b7590992",
        "type": "comment",
        "z": "45c21b8b98ae2f01",
        "name": "Clean All Floors",
        "info": "",
        "x": 640,
        "y": 60,
        "wires": []
    },
    {
        "id": "1cc2997adf18efd4",
        "type": "change",
        "z": "45c21b8b98ae2f01",
        "name": "Turn off",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            },
            {
                "t": "set",
                "p": "payload.On",
                "pt": "msg",
                "to": "false",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 830,
        "y": 160,
        "wires": [
            [
                "411bfdf502c42f26"
            ]
        ]
    },
    {
        "id": "242cdb71b5e628a8",
        "type": "delay",
        "z": "45c21b8b98ae2f01",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "minute",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": false,
        "outputs": 1,
        "x": 880,
        "y": 100,
        "wires": [
            [
                "9d3b5f7cafc6afdd"
            ]
        ]
    },
    {
        "id": "3c7015679afdb09a",
        "type": "inject",
        "z": "45c21b8b98ae2f01",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 670,
        "y": 160,
        "wires": [
            [
                "1cc2997adf18efd4"
            ]
        ]
    },
    {
        "id": "411bfdf502c42f26",
        "type": "homekit-service",
        "z": "45c21b8b98ae2f01",
        "isParent": true,
        "hostType": "0",
        "bridge": "b2cc5799.eea9d",
        "accessoryId": "",
        "parentService": "",
        "name": "Clean Floors",
        "serviceName": "Switch",
        "topic": "",
        "filter": false,
        "manufacturer": "NRCHKB",
        "model": "1.4.3",
        "serialNo": "Default Serial Number",
        "firmwareRev": "1.4.3",
        "hardwareRev": "1.4.3",
        "softwareRev": "1.4.3",
        "cameraConfigVideoProcessor": "ffmpeg",
        "cameraConfigSource": "",
        "cameraConfigStillImageSource": "",
        "cameraConfigMaxStreams": 2,
        "cameraConfigMaxWidth": 1280,
        "cameraConfigMaxHeight": 720,
        "cameraConfigMaxFPS": 10,
        "cameraConfigMaxBitrate": 300,
        "cameraConfigVideoCodec": "libx264",
        "cameraConfigAudioCodec": "libfdk_aac",
        "cameraConfigAudio": false,
        "cameraConfigPacketSize": 1316,
        "cameraConfigVerticalFlip": false,
        "cameraConfigHorizontalFlip": false,
        "cameraConfigMapVideo": "0:0",
        "cameraConfigMapAudio": "0:1",
        "cameraConfigVideoFilter": "scale=1280:720",
        "cameraConfigAdditionalCommandLine": "-tune zerolatency",
        "cameraConfigDebug": false,
        "cameraConfigSnapshotOutput": "disabled",
        "cameraConfigInterfaceName": "",
        "characteristicProperties": "{}",
        "waitForSetupMsg": false,
        "outputs": 2,
        "x": 670,
        "y": 100,
        "wires": [
            [
                "242cdb71b5e628a8"
            ],
            []
        ]
    },
    {
        "id": "9d3b5f7cafc6afdd",
        "type": "switch",
        "z": "45c21b8b98ae2f01",
        "name": "",
        "property": "payload.On",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1030,
        "y": 100,
        "wires": [
            [
                "1cc2997adf18efd4",
                "d389488a08d98ed3"
            ]
        ]
    },
    {
        "id": "f38ee7a3c51b0389",
        "type": "miio-roborock-command",
        "z": "45c21b8b98ae2f01",
        "name": "Clean Entryway",
        "server": "b63f730b24581cdc",
        "command_name": "► Start room cleaning",
        "command": "app_segment_clean",
        "commandType": "vacuum_cmd",
        "payload": "17",
        "payloadType": "num",
        "coordinates": "",
        "fan_speed": 100,
        "voice_pack": null,
        "homekit_stop_to_dock": false,
        "x": 660,
        "y": 840,
        "wires": [
            []
        ]
    },
    {
        "id": "30476d80162c5584",
        "type": "comment",
        "z": "45c21b8b98ae2f01",
        "name": "Clean Entryway",
        "info": "",
        "x": 100,
        "y": 800,
        "wires": []
    },
    {
        "id": "70dd2750ef69c883",
        "type": "change",
        "z": "45c21b8b98ae2f01",
        "name": "Turn off",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            },
            {
                "t": "set",
                "p": "payload.On",
                "pt": "msg",
                "to": "false",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 290,
        "y": 900,
        "wires": [
            [
                "bbbe4b1d331694d3"
            ]
        ]
    },
    {
        "id": "bcdb42a387ca65b0",
        "type": "delay",
        "z": "45c21b8b98ae2f01",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "minute",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": false,
        "outputs": 1,
        "x": 340,
        "y": 840,
        "wires": [
            [
                "b576eb6dde1e8c0d"
            ]
        ]
    },
    {
        "id": "9c6e10d8714bd13f",
        "type": "inject",
        "z": "45c21b8b98ae2f01",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 130,
        "y": 900,
        "wires": [
            [
                "70dd2750ef69c883"
            ]
        ]
    },
    {
        "id": "bbbe4b1d331694d3",
        "type": "homekit-service",
        "z": "45c21b8b98ae2f01",
        "isParent": true,
        "hostType": "0",
        "bridge": "b2cc5799.eea9d",
        "accessoryId": "",
        "parentService": "",
        "name": "Clean Entryway",
        "serviceName": "Switch",
        "topic": "",
        "filter": false,
        "manufacturer": "NRCHKB",
        "model": "1.4.3",
        "serialNo": "Default Serial Number",
        "firmwareRev": "1.4.3",
        "hardwareRev": "1.4.3",
        "softwareRev": "1.4.3",
        "cameraConfigVideoProcessor": "ffmpeg",
        "cameraConfigSource": "",
        "cameraConfigStillImageSource": "",
        "cameraConfigMaxStreams": 2,
        "cameraConfigMaxWidth": 1280,
        "cameraConfigMaxHeight": 720,
        "cameraConfigMaxFPS": 10,
        "cameraConfigMaxBitrate": 300,
        "cameraConfigVideoCodec": "libx264",
        "cameraConfigAudioCodec": "libfdk_aac",
        "cameraConfigAudio": false,
        "cameraConfigPacketSize": 1316,
        "cameraConfigVerticalFlip": false,
        "cameraConfigHorizontalFlip": false,
        "cameraConfigMapVideo": "0:0",
        "cameraConfigMapAudio": "0:1",
        "cameraConfigVideoFilter": "scale=1280:720",
        "cameraConfigAdditionalCommandLine": "-tune zerolatency",
        "cameraConfigDebug": false,
        "cameraConfigSnapshotOutput": "disabled",
        "cameraConfigInterfaceName": "",
        "characteristicProperties": "{}",
        "waitForSetupMsg": false,
        "outputs": 2,
        "x": 140,
        "y": 840,
        "wires": [
            [
                "bcdb42a387ca65b0"
            ],
            []
        ]
    },
    {
        "id": "b576eb6dde1e8c0d",
        "type": "switch",
        "z": "45c21b8b98ae2f01",
        "name": "",
        "property": "payload.On",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 490,
        "y": 840,
        "wires": [
            [
                "f38ee7a3c51b0389",
                "70dd2750ef69c883"
            ]
        ]
    },
    {
        "id": "02edb1b65217113e",
        "type": "miio-roborock-command",
        "z": "45c21b8b98ae2f01",
        "name": "Clean Master Bath",
        "server": "b63f730b24581cdc",
        "command_name": "► Start room cleaning",
        "command": "app_segment_clean",
        "commandType": "vacuum_cmd",
        "payload": "23",
        "payloadType": "num",
        "coordinates": "",
        "fan_speed": 100,
        "voice_pack": null,
        "homekit_stop_to_dock": false,
        "x": 670,
        "y": 1000,
        "wires": [
            []
        ]
    },
    {
        "id": "5e574e77415853b6",
        "type": "comment",
        "z": "45c21b8b98ae2f01",
        "name": "Clean Master Bath",
        "info": "",
        "x": 110,
        "y": 960,
        "wires": []
    },
    {
        "id": "e6178b09c2ead93b",
        "type": "change",
        "z": "45c21b8b98ae2f01",
        "name": "Turn off",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            },
            {
                "t": "set",
                "p": "payload.On",
                "pt": "msg",
                "to": "false",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 290,
        "y": 1060,
        "wires": [
            [
                "bb68bf3e759f5cdf"
            ]
        ]
    },
    {
        "id": "11176f46fc615053",
        "type": "delay",
        "z": "45c21b8b98ae2f01",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "minute",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": false,
        "outputs": 1,
        "x": 340,
        "y": 1000,
        "wires": [
            [
                "034aca5c9ead9aaf"
            ]
        ]
    },
    {
        "id": "6a72915831b6a28c",
        "type": "inject",
        "z": "45c21b8b98ae2f01",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 120,
        "y": 1060,
        "wires": [
            [
                "e6178b09c2ead93b"
            ]
        ]
    },
    {
        "id": "bb68bf3e759f5cdf",
        "type": "homekit-service",
        "z": "45c21b8b98ae2f01",
        "isParent": true,
        "hostType": "0",
        "bridge": "b2cc5799.eea9d",
        "accessoryId": "",
        "parentService": "",
        "name": "Clean Master Bath",
        "serviceName": "Switch",
        "topic": "",
        "filter": false,
        "manufacturer": "NRCHKB",
        "model": "1.4.3",
        "serialNo": "Default Serial Number",
        "firmwareRev": "1.4.3",
        "hardwareRev": "1.4.3",
        "softwareRev": "1.4.3",
        "cameraConfigVideoProcessor": "ffmpeg",
        "cameraConfigSource": "",
        "cameraConfigStillImageSource": "",
        "cameraConfigMaxStreams": 2,
        "cameraConfigMaxWidth": 1280,
        "cameraConfigMaxHeight": 720,
        "cameraConfigMaxFPS": 10,
        "cameraConfigMaxBitrate": 300,
        "cameraConfigVideoCodec": "libx264",
        "cameraConfigAudioCodec": "libfdk_aac",
        "cameraConfigAudio": false,
        "cameraConfigPacketSize": 1316,
        "cameraConfigVerticalFlip": false,
        "cameraConfigHorizontalFlip": false,
        "cameraConfigMapVideo": "0:0",
        "cameraConfigMapAudio": "0:1",
        "cameraConfigVideoFilter": "scale=1280:720",
        "cameraConfigAdditionalCommandLine": "-tune zerolatency",
        "cameraConfigDebug": false,
        "cameraConfigSnapshotOutput": "disabled",
        "cameraConfigInterfaceName": "",
        "characteristicProperties": "{}",
        "waitForSetupMsg": false,
        "outputs": 2,
        "x": 150,
        "y": 1000,
        "wires": [
            [
                "11176f46fc615053"
            ],
            []
        ]
    },
    {
        "id": "034aca5c9ead9aaf",
        "type": "switch",
        "z": "45c21b8b98ae2f01",
        "name": "",
        "property": "payload.On",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 490,
        "y": 1000,
        "wires": [
            [
                "02edb1b65217113e",
                "e6178b09c2ead93b"
            ]
        ]
    },
    {
        "id": "3a29bf394c945c90",
        "type": "delay",
        "z": "45c21b8b98ae2f01",
        "name": "",
        "pauseType": "delay",
        "timeout": "30",
        "timeoutUnits": "minutes",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 130,
        "y": 200,
        "wires": [
            [
                "2192d9c1b6dec6df"
            ]
        ]
    },
    {
        "id": "072e9b000d766ec4",
        "type": "get-shared-state",
        "z": "45c21b8b98ae2f01",
        "state": "b69e9a96.7fc43",
        "name": "Master Asleep",
        "triggerOnInit": false,
        "x": 890,
        "y": 680,
        "wires": [
            [
                "72772b7050cd06e4"
            ]
        ]
    },
    {
        "id": "71799f916b7138fb",
        "type": "get-shared-state",
        "z": "45c21b8b98ae2f01",
        "state": "156ccde543ba4845",
        "name": "Guest Asleep",
        "triggerOnInit": false,
        "x": 890,
        "y": 740,
        "wires": [
            [
                "623978305b080b3c"
            ]
        ]
    },
    {
        "id": "7fbb873572485075",
        "type": "get-shared-state",
        "z": "45c21b8b98ae2f01",
        "state": "3e3052d11dc41010",
        "name": "Is Guest Bedroom Door Open?",
        "triggerOnInit": false,
        "x": 950,
        "y": 800,
        "wires": [
            [
                "e2707d9bae30501b"
            ]
        ]
    },
    {
        "id": "9e2abf81ab49f842",
        "type": "function",
        "z": "45c21b8b98ae2f01",
        "name": "If everyone is awake and bedroom door closed",
        "func": "if (global.get(\"state\").isMasterAsleep.value == true) {\n    return null\n}\nif (global.get(\"state\").isGuestAsleep.value == true) {\n    return null\n}\nif (global.get(\"state\").isGuestBedroomDoorOpen.value == true) {\n    return null\n}\n\n// don't run this if we have guests b/c the signal will be less reliable\nif (global.get(\"state\").isHaveGuests.value == true) {\n    return null\n}\n// Only run this during the day\nif (global.get(\"state\").dayPhase.value != \"day\") {\n    return null\n}\n// Onl run this if Nick is gone\nif (global.get(\"state\").isNickHome.value == true) {\n    return null\n}\n\nmsg.payload = {\"On\": true}\n\nreturn msg",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1620,
        "y": 740,
        "wires": [
            [
                "d467158e33f7a72c"
            ]
        ]
    },
    {
        "id": "72772b7050cd06e4",
        "type": "trigger",
        "z": "45c21b8b98ae2f01",
        "name": "If stays false for 10 minutes",
        "op1": "",
        "op2": "0",
        "op1type": "nul",
        "op2type": "str",
        "duration": "10",
        "extend": false,
        "overrideDelay": false,
        "units": "min",
        "reset": "true",
        "bytopic": "all",
        "topic": "topic",
        "outputs": 1,
        "x": 1240,
        "y": 680,
        "wires": [
            [
                "9e2abf81ab49f842"
            ]
        ]
    },
    {
        "id": "623978305b080b3c",
        "type": "trigger",
        "z": "45c21b8b98ae2f01",
        "name": "If stays false for 10 minutes",
        "op1": "",
        "op2": "0",
        "op1type": "nul",
        "op2type": "str",
        "duration": "10",
        "extend": false,
        "overrideDelay": false,
        "units": "min",
        "reset": "true",
        "bytopic": "all",
        "topic": "topic",
        "outputs": 1,
        "x": 1240,
        "y": 740,
        "wires": [
            [
                "9e2abf81ab49f842"
            ]
        ]
    },
    {
        "id": "e2707d9bae30501b",
        "type": "trigger",
        "z": "45c21b8b98ae2f01",
        "name": "If stays false for 20 minutes",
        "op1": "",
        "op2": "0",
        "op1type": "nul",
        "op2type": "str",
        "duration": "20",
        "extend": false,
        "overrideDelay": false,
        "units": "min",
        "reset": "true",
        "bytopic": "all",
        "topic": "topic",
        "outputs": 1,
        "x": 1240,
        "y": 800,
        "wires": [
            [
                "9e2abf81ab49f842"
            ]
        ]
    },
    {
        "id": "d6f6f57a09be0655",
        "type": "link in",
        "z": "45c21b8b98ae2f01",
        "name": "Turn on Master Bath Vacuum",
        "links": [
            "514f8a014a8b5060"
        ],
        "x": 25,
        "y": 1000,
        "wires": [
            [
                "bb68bf3e759f5cdf"
            ]
        ]
    },
    {
        "id": "514f8a014a8b5060",
        "type": "link out",
        "z": "45c21b8b98ae2f01",
        "name": "Turn on Master Bath Vacuum",
        "mode": "link",
        "links": [
            "d6f6f57a09be0655"
        ],
        "x": 2015,
        "y": 740,
        "wires": []
    },
    {
        "id": "fe257a60613c0601",
        "type": "comment",
        "z": "45c21b8b98ae2f01",
        "name": "Automatically clean master bath after Caroline starts work",
        "info": "",
        "x": 1030,
        "y": 640,
        "wires": []
    },
    {
        "id": "d467158e33f7a72c",
        "type": "delay",
        "z": "45c21b8b98ae2f01",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "20",
        "rateUnits": "hour",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": false,
        "outputs": 1,
        "x": 1900,
        "y": 740,
        "wires": [
            [
                "514f8a014a8b5060"
            ]
        ]
    },
    {
        "id": "434e4fafc2d5e542",
        "type": "get-shared-state",
        "z": "45c21b8b98ae2f01",
        "state": "efc87f0de00a2d36",
        "name": "Day Phase",
        "triggerOnInit": false,
        "x": 1300,
        "y": 860,
        "wires": [
            [
                "9e2abf81ab49f842"
            ]
        ]
    },
    {
        "id": "6d6e6c06f83da0ce",
        "type": "comment",
        "z": "95cf961539320dd3",
        "name": "Fade Out Sleep Sounds",
        "info": "",
        "x": 140,
        "y": 40,
        "wires": []
    },
    {
        "id": "928a0a31ac991089",
        "type": "function",
        "z": "95cf961539320dd3",
        "name": "Ensure master is home and asleep",
        "func": "if (global.get(\"state\").isAnyoneHome.value == false) {\n    return null\n}\nif (global.get(\"state\").isMasterAsleep.value == false) {\n    return null\n}\nif (global.get(\"state\").musicPlaybackType.value != \"sleep\") {\n    return null\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 220,
        "y": 100,
        "wires": [
            [
                "ca6d0e931ce891e2"
            ]
        ]
    },
    {
        "id": "c725c25378348402",
        "type": "inject",
        "z": "95cf961539320dd3",
        "name": "Check every minute",
        "props": [],
        "repeat": "60",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 160,
        "y": 480,
        "wires": [
            [
                "3275d4dbed0798c1"
            ]
        ]
    },
    {
        "id": "3275d4dbed0798c1",
        "type": "function",
        "z": "95cf961539320dd3",
        "name": "Identify which time triggers are satisfied",
        "func": "begin_wake_time = new Date(global.get(\"state\").schedule.value.begin_wake)\nwake_time = new Date(global.get(\"state\").schedule.value.wake)\nstop_screens_time = new Date(global.get(\"state\").schedule.value.stop_screens)\ngo_to_bed_time = new Date(global.get(\"state\").schedule.value.go_to_bed)\n\nnow = new Date()\n\nvar ONE_HOUR = 60 * 60 * 1000; /* ms */\n\nif (now > begin_wake_time) {\n    // Only act if it's been true for less than one hour\n    if ((now - begin_wake_time) < ONE_HOUR) {\n        msg.topic = \"begin_wake\"\n        node.send(msg)\n    }\n}\n\nif (now > wake_time) {\n    // Only act if it's been true for less than one hour\n    if ((now - wake_time) < ONE_HOUR) {\n        msg.topic = \"wake\"\n        node.send(msg)\n    }\n}\n\nif (now > stop_screens_time) {\n    // Only act if it's been true for less than one hour\n    if ((now - stop_screens_time) < ONE_HOUR) {\n        msg.topic = \"stop_screens\"\n        node.send(msg)\n    }\n}\n\nif (now > go_to_bed_time) {\n    // Only act if it's been true for less than one hour\n    if ((now - go_to_bed_time) < ONE_HOUR) {\n        msg.topic = \"go_to_bed\"\n        node.send(msg)\n    }\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 440,
        "y": 480,
        "wires": [
            [
                "db4ccb257569707c"
            ]
        ]
    },
    {
        "id": "db4ccb257569707c",
        "type": "switch",
        "z": "95cf961539320dd3",
        "name": "Route Messages",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "begin_wake",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "wake",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "stop_screens",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "go_to_bed",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 4,
        "x": 710,
        "y": 480,
        "wires": [
            [
                "1436fedcf61d1e78"
            ],
            [
                "3b11d8f644b1a4bf"
            ],
            [
                "ae68485605384501"
            ],
            [
                "3a134624a0af51fb"
            ]
        ]
    },
    {
        "id": "1436fedcf61d1e78",
        "type": "delay",
        "z": "95cf961539320dd3",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "2",
        "rateUnits": "hour",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": false,
        "outputs": 1,
        "x": 920,
        "y": 380,
        "wires": [
            [
                "abd63eda68fd8674",
                "933b06632a61b4c2"
            ]
        ]
    },
    {
        "id": "3b11d8f644b1a4bf",
        "type": "delay",
        "z": "95cf961539320dd3",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "2",
        "rateUnits": "hour",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": false,
        "outputs": 1,
        "x": 920,
        "y": 460,
        "wires": [
            [
                "fa146de078cdbe8d"
            ]
        ]
    },
    {
        "id": "ae68485605384501",
        "type": "delay",
        "z": "95cf961539320dd3",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "2",
        "rateUnits": "hour",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": false,
        "outputs": 1,
        "x": 920,
        "y": 540,
        "wires": [
            [
                "1085fc2a0db788a3"
            ]
        ]
    },
    {
        "id": "3a134624a0af51fb",
        "type": "delay",
        "z": "95cf961539320dd3",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "2",
        "rateUnits": "hour",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": false,
        "outputs": 1,
        "x": 920,
        "y": 620,
        "wires": [
            [
                "1085fc2a0db788a3",
                "a2593542cdd2ef2f"
            ]
        ]
    },
    {
        "id": "abd63eda68fd8674",
        "type": "link out",
        "z": "95cf961539320dd3",
        "name": "Before Wakeup",
        "mode": "link",
        "links": [
            "da54c4772dbeeaaf"
        ],
        "x": 1075,
        "y": 340,
        "wires": []
    },
    {
        "id": "da54c4772dbeeaaf",
        "type": "link in",
        "z": "95cf961539320dd3",
        "name": "Fade out sleep sounds",
        "links": [
            "abd63eda68fd8674"
        ],
        "x": 55,
        "y": 100,
        "wires": [
            [
                "928a0a31ac991089"
            ]
        ]
    },
    {
        "id": "ac0d047163dd056f",
        "type": "set-shared-state",
        "z": "95cf961539320dd3",
        "state": "b69e9a96.7fc43",
        "name": "Master Asleep",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 1400,
        "y": 460,
        "wires": []
    },
    {
        "id": "fa146de078cdbe8d",
        "type": "function",
        "z": "95cf961539320dd3",
        "d": true,
        "name": "Ensure master is home and asleep",
        "func": "if (global.get(\"state\").isAnyoneHome.value == false) {\n    return null\n}\nif (global.get(\"state\").isMasterAsleep.value == false) {\n    return null\n}\n\nmsg.payload = false\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1160,
        "y": 460,
        "wires": [
            [
                "ac0d047163dd056f"
            ]
        ]
    },
    {
        "id": "598754ddfd55071d",
        "type": "api-call-service",
        "z": "95cf961539320dd3",
        "name": "Turn on Master Bedroom Lights Slowly",
        "server": "3ec50562615a9f50",
        "version": 5,
        "debugenabled": false,
        "domain": "light",
        "service": "turn_on",
        "areaId": [
            "master_bedroom"
        ],
        "deviceId": [],
        "entityId": [],
        "data": "{\"transition\": 1800, \"color_temp\": 290, \"brightness_pct\": 100}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "x": 1510,
        "y": 380,
        "wires": [
            []
        ]
    },
    {
        "id": "013b7017f85ad5c9",
        "type": "comment",
        "z": "95cf961539320dd3",
        "name": "Before Wakeup time",
        "info": "",
        "x": 930,
        "y": 340,
        "wires": []
    },
    {
        "id": "db0aed47fddfc328",
        "type": "comment",
        "z": "95cf961539320dd3",
        "name": "At Wakeup time",
        "info": "",
        "x": 920,
        "y": 420,
        "wires": []
    },
    {
        "id": "83673f02cf1c7866",
        "type": "api-call-service",
        "z": "95cf961539320dd3",
        "name": "Flash Lights",
        "server": "3ec50562615a9f50",
        "version": 5,
        "debugenabled": false,
        "domain": "light",
        "service": "turn_on",
        "areaId": [
            "living_room",
            "nook"
        ],
        "deviceId": [],
        "entityId": [],
        "data": "{\"flash\": \"short\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "x": 1530,
        "y": 620,
        "wires": [
            [
                "7ed38cdcf25b1c70"
            ]
        ]
    },
    {
        "id": "2ef6b47ca1cf0854",
        "type": "api-call-service",
        "z": "95cf961539320dd3",
        "name": "Flash Lights",
        "server": "3ec50562615a9f50",
        "version": 5,
        "debugenabled": false,
        "domain": "light",
        "service": "turn_on",
        "areaId": [
            "living_room",
            "nook"
        ],
        "deviceId": [],
        "entityId": [],
        "data": "{\"flash\": \"short\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "x": 1830,
        "y": 620,
        "wires": [
            []
        ]
    },
    {
        "id": "7ed38cdcf25b1c70",
        "type": "delay",
        "z": "95cf961539320dd3",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 1680,
        "y": 620,
        "wires": [
            [
                "2ef6b47ca1cf0854"
            ]
        ]
    },
    {
        "id": "468e855f71924dbe",
        "type": "comment",
        "z": "95cf961539320dd3",
        "name": "Flash lights in common areas",
        "info": "",
        "x": 1580,
        "y": 580,
        "wires": []
    },
    {
        "id": "1085fc2a0db788a3",
        "type": "function",
        "z": "95cf961539320dd3",
        "name": "Check if anyone home and not everyone asleep",
        "func": "if (global.get(\"state\").isAnyoneHome.value == false) {\n    return null\n}\nif (global.get(\"state\").isEveryoneAsleep.value == true) {\n    return null\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1260,
        "y": 620,
        "wires": [
            [
                "83673f02cf1c7866"
            ]
        ]
    },
    {
        "id": "732b6e52425b9427",
        "type": "comment",
        "z": "95cf961539320dd3",
        "name": "When time to stop using screens",
        "info": "",
        "x": 970,
        "y": 500,
        "wires": []
    },
    {
        "id": "96afb3a9d2a7d841",
        "type": "comment",
        "z": "95cf961539320dd3",
        "name": "When time to go to bed",
        "info": "",
        "x": 940,
        "y": 580,
        "wires": []
    },
    {
        "id": "933b06632a61b4c2",
        "type": "function",
        "z": "95cf961539320dd3",
        "name": "Ensure master is home and asleep",
        "func": "if (global.get(\"state\").isAnyoneHome.value == false) {\n    return null\n}\nif (global.get(\"state\").isMasterAsleep.value == false) {\n    return null\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1200,
        "y": 380,
        "wires": [
            [
                "598754ddfd55071d"
            ]
        ]
    },
    {
        "id": "7096f06620fde73c",
        "type": "comment",
        "z": "95cf961539320dd3",
        "name": "Fade Up Bedroom Lights",
        "info": "",
        "x": 1470,
        "y": 340,
        "wires": []
    },
    {
        "id": "1a40e8a8fe20fc43",
        "type": "comment",
        "z": "95cf961539320dd3",
        "name": "Auto Wakeup",
        "info": "",
        "x": 1390,
        "y": 420,
        "wires": []
    },
    {
        "id": "e05bccce05e34da2",
        "type": "comment",
        "z": "95cf961539320dd3",
        "name": "Apply schedule config and trigger as appropriate",
        "info": "",
        "x": 220,
        "y": 340,
        "wires": []
    },
    {
        "id": "a2593542cdd2ef2f",
        "type": "change",
        "z": "95cf961539320dd3",
        "name": "Set Sleep",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "sleep",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1140,
        "y": 680,
        "wires": [
            [
                "4090cc7bb7d087d2"
            ]
        ]
    },
    {
        "id": "4090cc7bb7d087d2",
        "type": "set-shared-state",
        "z": "95cf961539320dd3",
        "state": "8c211e55da1f4c7f",
        "name": "Music Playback Type",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 1320,
        "y": 680,
        "wires": []
    },
    {
        "id": "ca6d0e931ce891e2",
        "type": "function",
        "z": "95cf961539320dd3",
        "name": "Create participant-specific message",
        "func": "// By default, move to set volume and appropriately unmute all players in current playback\nspeakers = global.get(\"state\").currentlyPlayingMusic.value.participants\n// Iterate over our targets and kick off setting their volume and mute state\nspeakers.forEach(function(target) {\n    participantSpecificMsg = {}\n    // If this player is in Master suite\n    if (target.player_name.indexOf(\"Master\") > -1) {\n        participantSpecificMsg.playerName = target.player_name\n        node.send(participantSpecificMsg);\n    }\n});\n\nreturn null",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 550,
        "y": 100,
        "wires": [
            [
                "7e90140297338312"
            ]
        ]
    },
    {
        "id": "7e90140297338312",
        "type": "sonos-universal",
        "z": "95cf961539320dd3",
        "confignode": "80cf2bfc253ff8c2",
        "command": "player.get.volume",
        "state": "",
        "stateType": "str",
        "avoidCheckPlayerAvailability": false,
        "name": "Get a volume",
        "x": 790,
        "y": 100,
        "wires": [
            [
                "560e9e7e53edf40e"
            ]
        ]
    },
    {
        "id": "21072dd8887381eb",
        "type": "function",
        "z": "95cf961539320dd3",
        "name": "Update known state with the actual current volumes",
        "func": "observed_volume = msg.payload\nmsg.last_volume_set = observed_volume\n\ncurrentKnownPlayingMusic = global.get(\"state\").currentlyPlayingMusic.value\n\ncurrentKnownPlayingMusic.participants.forEach(function(participant) {\n    if (participant.player_name == msg.playerName) {\n        participant.volume = observed_volume\n    }\n});\n\nupdateCurrentlyPlayingMusicMsg = {}\nupdateCurrentlyPlayingMusicMsg.payload = currentKnownPlayingMusic\n\nreturn [updateCurrentlyPlayingMusicMsg, msg];",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 260,
        "y": 160,
        "wires": [
            [
                "6de7fcb07c82a9ce"
            ],
            [
                "b2ce538e032e4961"
            ]
        ]
    },
    {
        "id": "6de7fcb07c82a9ce",
        "type": "set-shared-state",
        "z": "95cf961539320dd3",
        "state": "b74697c734ad5557",
        "name": "Currently Playing Music",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 950,
        "y": 160,
        "wires": []
    },
    {
        "id": "560e9e7e53edf40e",
        "type": "delay",
        "z": "95cf961539320dd3",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "2",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 960,
        "y": 100,
        "wires": [
            [
                "21072dd8887381eb"
            ]
        ]
    },
    {
        "id": "3da544b5240dcbf7",
        "type": "function",
        "z": "95cf961539320dd3",
        "name": "Repeat turn downs until 0",
        "func": "// What is the volume currently?\ncurrent_volume = msg.payload\n\n// Check for someone fighting the system\nif (current_volume > msg.last_volume_set) {\n    // If the volume is greater than what was last set, assume someone\n    // is fighting the system trying to keep the volume up\n    currentlyPlayingMusic = global.get(\"state\").currentlyPlayingMusic.value\n    \n    currentlyPlayingMusic.participants.forEach(function(participant) {\n        // If it's this flow's speaker\n        if (participant.player_name == msg.playerName) {\n            participant.volume = current_volume\n        }\n    });\n    msg.payload = currentlyPlayingMusic\n    \n    return [msg, null]\n}\n\n// What is the volume supposed to be?\ndesired_volume = 0\n\n// If we haven't gotten down to the desired volume\nif (current_volume > desired_volume) {\n    currentlyPlayingMusic = global.get(\"state\").currentlyPlayingMusic.value\n    \n    currentlyPlayingMusic.participants.forEach(function(participant) {\n        // If it's this flow's speaker\n        if (participant.player_name == msg.playerName) {\n            participant.volume = current_volume\n            // Reduce its volume by 1\n            participant.volume--;\n            msg.last_volume_set = participant.volume\n        }\n    });\n    msg.payload = currentlyPlayingMusic\n    \n    // Set the delay for the next turn down to be greater if volume is lower\n    msg.delay = (60 - current_volume) * 1000\n    return [msg, msg]\n}\n\n// We're done, everything is as it should be",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 650,
        "y": 220,
        "wires": [
            [
                "4a3bdf6826669285",
                "6de7fcb07c82a9ce"
            ],
            [
                "b2ce538e032e4961"
            ]
        ]
    },
    {
        "id": "a05a696cfafb0ca6",
        "type": "sonos-universal",
        "z": "95cf961539320dd3",
        "confignode": "80cf2bfc253ff8c2",
        "command": "player.get.volume",
        "state": "",
        "stateType": "str",
        "avoidCheckPlayerAvailability": false,
        "name": "Get a volume",
        "x": 450,
        "y": 220,
        "wires": [
            [
                "3da544b5240dcbf7"
            ]
        ]
    },
    {
        "id": "b2ce538e032e4961",
        "type": "delay",
        "z": "95cf961539320dd3",
        "name": "Delay",
        "pauseType": "delayv",
        "timeout": "20",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 130,
        "y": 220,
        "wires": [
            [
                "e6f8d0150f8d5cca"
            ]
        ]
    },
    {
        "id": "4a3bdf6826669285",
        "type": "link out",
        "z": "95cf961539320dd3",
        "name": "Set Volumes and Mute",
        "mode": "link",
        "links": [
            "34bd02b0a6ce0a3f"
        ],
        "x": 855,
        "y": 220,
        "wires": []
    },
    {
        "id": "54ff6f652649f649",
        "type": "comment",
        "z": "95cf961539320dd3",
        "name": "Use normal volume set to apply",
        "info": "",
        "x": 1010,
        "y": 220,
        "wires": []
    },
    {
        "id": "5bc361a44ae4f4fe",
        "type": "inject",
        "z": "95cf961539320dd3",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 340,
        "y": 40,
        "wires": [
            [
                "ca6d0e931ce891e2"
            ]
        ]
    },
    {
        "id": "e6f8d0150f8d5cca",
        "type": "delay",
        "z": "95cf961539320dd3",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "2",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 280,
        "y": 220,
        "wires": [
            [
                "a05a696cfafb0ca6"
            ]
        ]
    },
    {
        "id": "a99efe1134ae512d",
        "type": "log-elk",
        "z": "9e0490d1fc323107",
        "name": "Log",
        "logger": "e98cb8b7d7a02f27",
        "complete": "payload",
        "loglevel": "info",
        "x": 790,
        "y": 500,
        "wires": []
    },
    {
        "id": "397f1108a960601f",
        "type": "get-shared-state",
        "z": "9e0490d1fc323107",
        "state": "99455ccf.2c8498",
        "name": "Caroline Home",
        "triggerOnInit": false,
        "x": 160,
        "y": 80,
        "wires": [
            [
                "d302fd95b8fbd25a"
            ]
        ]
    },
    {
        "id": "a2c6403a03dfe142",
        "type": "get-shared-state",
        "z": "9e0490d1fc323107",
        "state": "b74697c734ad5557",
        "name": "Currently Playing Music",
        "triggerOnInit": false,
        "x": 180,
        "y": 160,
        "wires": [
            [
                "d302fd95b8fbd25a"
            ]
        ]
    },
    {
        "id": "e814263e57b76d82",
        "type": "get-shared-state",
        "z": "9e0490d1fc323107",
        "state": "60c1725bc2519ee0",
        "name": "Everyone Asleep",
        "triggerOnInit": false,
        "x": 160,
        "y": 240,
        "wires": [
            [
                "d302fd95b8fbd25a"
            ]
        ]
    },
    {
        "id": "6c3515ab36ce9cbc",
        "type": "get-shared-state",
        "z": "9e0490d1fc323107",
        "state": "156ccde543ba4845",
        "name": "Guest Asleep",
        "triggerOnInit": false,
        "x": 150,
        "y": 280,
        "wires": [
            [
                "d302fd95b8fbd25a"
            ]
        ]
    },
    {
        "id": "1acc23f7c21becd6",
        "type": "get-shared-state",
        "z": "9e0490d1fc323107",
        "state": "a5ea3d0a7df352b2",
        "name": "Have Guests?",
        "triggerOnInit": false,
        "x": 150,
        "y": 320,
        "wires": [
            [
                "d302fd95b8fbd25a"
            ]
        ]
    },
    {
        "id": "2aa7698b4364880c",
        "type": "get-shared-state",
        "z": "9e0490d1fc323107",
        "state": "86b433f8beadaac5",
        "name": "Hue Config",
        "triggerOnInit": false,
        "x": 150,
        "y": 360,
        "wires": [
            [
                "d302fd95b8fbd25a"
            ]
        ]
    },
    {
        "id": "ba6acb2cd13275c6",
        "type": "get-shared-state",
        "z": "9e0490d1fc323107",
        "state": "3e3052d11dc41010",
        "name": "Is Guest Bedroom Door Open?",
        "triggerOnInit": false,
        "x": 210,
        "y": 400,
        "wires": [
            [
                "d302fd95b8fbd25a"
            ]
        ]
    },
    {
        "id": "99e192fa7b4ef8b6",
        "type": "get-shared-state",
        "z": "9e0490d1fc323107",
        "state": "8c8dbb69a0c4c67f",
        "name": "Is Master Bedroom Door Open?",
        "triggerOnInit": false,
        "x": 210,
        "y": 440,
        "wires": [
            [
                "d302fd95b8fbd25a"
            ]
        ]
    },
    {
        "id": "a51249a224ea8dbb",
        "type": "get-shared-state",
        "z": "9e0490d1fc323107",
        "state": "efc87f0de00a2d36",
        "name": "Day Phase",
        "triggerOnInit": false,
        "x": 140,
        "y": 200,
        "wires": [
            [
                "d302fd95b8fbd25a"
            ]
        ]
    },
    {
        "id": "224e1c91419b027f",
        "type": "get-shared-state",
        "z": "9e0490d1fc323107",
        "state": "9784d6c488d7a77e",
        "name": "Is TV On?",
        "triggerOnInit": false,
        "x": 140,
        "y": 480,
        "wires": [
            [
                "d302fd95b8fbd25a"
            ]
        ]
    },
    {
        "id": "946ab51969f69a22",
        "type": "get-shared-state",
        "z": "9e0490d1fc323107",
        "state": "d9abb6b3441e0c2a",
        "name": "Is TV Playing?",
        "triggerOnInit": false,
        "x": 150,
        "y": 520,
        "wires": [
            [
                "d302fd95b8fbd25a"
            ]
        ]
    },
    {
        "id": "d302fd95b8fbd25a",
        "type": "function",
        "z": "9e0490d1fc323107",
        "name": "If object move to such an attribute",
        "func": "value = msg.payload\n\nmsg.payload = {}\n\nmsg.payload.variable = msg.topic\n\nif (typeof value == \"object\") {\n    msg.payload.object = value\n    msg.payload.type = \"object\"\n    msg.payload.object_string = JSON.stringify(msg.payload.object);\n} else if (typeof value == \"string\") {\n    msg.payload.string = value\n    msg.payload.type = \"string\"\n} else if (typeof value == \"number\") {\n    msg.payload.number = value\n    msg.payload.type = \"number\"\n} else if (typeof value == \"boolean\") {\n    msg.payload.boolean = value\n    msg.payload.type = \"boolean\"\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 580,
        "y": 500,
        "wires": [
            [
                "a99efe1134ae512d"
            ]
        ]
    },
    {
        "id": "f2d07297affa0f44",
        "type": "get-shared-state",
        "z": "9e0490d1fc323107",
        "state": "e498a23d75394b05",
        "name": "Last Vaccuming Timestamp",
        "triggerOnInit": false,
        "x": 200,
        "y": 560,
        "wires": [
            [
                "d302fd95b8fbd25a"
            ]
        ]
    },
    {
        "id": "428ef2c98f36c39f",
        "type": "get-shared-state",
        "z": "9e0490d1fc323107",
        "state": "b69e9a96.7fc43",
        "name": "Master Asleep",
        "triggerOnInit": false,
        "x": 150,
        "y": 600,
        "wires": [
            [
                "d302fd95b8fbd25a"
            ]
        ]
    },
    {
        "id": "aaaec1687e570cc8",
        "type": "get-shared-state",
        "z": "9e0490d1fc323107",
        "state": "e4f5bf03444063a0",
        "name": "Music Config",
        "triggerOnInit": false,
        "x": 150,
        "y": 640,
        "wires": [
            [
                "d302fd95b8fbd25a"
            ]
        ]
    },
    {
        "id": "892a1fa97788998f",
        "type": "get-shared-state",
        "z": "9e0490d1fc323107",
        "state": "8c211e55da1f4c7f",
        "name": "Music Playback Type",
        "triggerOnInit": false,
        "x": 180,
        "y": 680,
        "wires": [
            [
                "d302fd95b8fbd25a"
            ]
        ]
    },
    {
        "id": "8f0e34f261117ab2",
        "type": "get-shared-state",
        "z": "9e0490d1fc323107",
        "state": "659fd61043193a4d",
        "name": "Music Playlist Numbers",
        "triggerOnInit": false,
        "x": 180,
        "y": 720,
        "wires": [
            [
                "d302fd95b8fbd25a"
            ]
        ]
    },
    {
        "id": "a932511e3452f810",
        "type": "get-shared-state",
        "z": "9e0490d1fc323107",
        "state": "e3cb7570.0dbb48",
        "name": "Nick Home",
        "triggerOnInit": false,
        "x": 140,
        "y": 760,
        "wires": [
            [
                "d302fd95b8fbd25a"
            ]
        ]
    },
    {
        "id": "e5b05347dbf080c9",
        "type": "get-shared-state",
        "z": "9e0490d1fc323107",
        "state": "3d96ef25996d1dd1",
        "name": "Reset",
        "triggerOnInit": false,
        "x": 130,
        "y": 800,
        "wires": [
            [
                "d302fd95b8fbd25a"
            ]
        ]
    },
    {
        "id": "d6f35e4b01de6c88",
        "type": "get-shared-state",
        "z": "9e0490d1fc323107",
        "state": "f4fbefedb919c3c1",
        "name": "Schedule",
        "triggerOnInit": false,
        "x": 140,
        "y": 840,
        "wires": [
            [
                "d302fd95b8fbd25a"
            ]
        ]
    },
    {
        "id": "b65bf0d89d2df038",
        "type": "get-shared-state",
        "z": "9e0490d1fc323107",
        "state": "174c278f.609ec8",
        "name": "Sun Event",
        "triggerOnInit": false,
        "x": 140,
        "y": 880,
        "wires": [
            [
                "d302fd95b8fbd25a"
            ]
        ]
    },
    {
        "id": "1720b539ad30b259",
        "type": "get-shared-state",
        "z": "9e0490d1fc323107",
        "state": "611761b9dd5c9c4c",
        "name": "Climate Config",
        "triggerOnInit": false,
        "x": 160,
        "y": 120,
        "wires": [
            [
                "d302fd95b8fbd25a"
            ]
        ]
    },
    {
        "id": "25ce20e84e6765a8",
        "type": "get-shared-state",
        "z": "9e0490d1fc323107",
        "state": "1ce72a9fb27d8577",
        "name": "Is Humdifier On?",
        "triggerOnInit": false,
        "x": 380,
        "y": 80,
        "wires": [
            [
                "d302fd95b8fbd25a"
            ]
        ]
    },
    {
        "id": "d5bf6da70ddd047d",
        "type": "get-shared-state",
        "z": "9e0490d1fc323107",
        "state": "26ccc92b36b23b99",
        "name": "Anyone Asleep",
        "triggerOnInit": false,
        "x": 380,
        "y": 120,
        "wires": [
            [
                "d302fd95b8fbd25a"
            ]
        ]
    },
    {
        "id": "f52083fdd7491f1b",
        "type": "get-shared-state",
        "z": "6a064f420a191bf8",
        "state": "8c211e55da1f4c7f",
        "name": "Music Playback Type",
        "triggerOnInit": true,
        "x": 120,
        "y": 80,
        "wires": [
            [
                "b8f64fef44da2ad4"
            ]
        ]
    },
    {
        "id": "b8f64fef44da2ad4",
        "type": "function",
        "z": "6a064f420a191bf8",
        "name": "Humidifiy or not to humidifiy?",
        "func": "musicPlaybackType = global.get(\"state\").musicPlaybackType.value\n\n// If it's day or evening there's no point in humidifying\nif (musicPlaybackType == \"morning\" ||\n    musicPlaybackType == \"day\" ||\n    musicPlaybackType == \"evening\"\n    ) {\n    return [msg, null]\n}\n// If it's winddown or sleep definitely humidify\nif (musicPlaybackType == \"winddown\" ||\n    musicPlaybackType == \"sleep\"\n    ) {\n    return [null, msg]\n}\n// Otherwise, not so clear so do nothing\nreturn [null, null]",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 470,
        "y": 80,
        "wires": [
            [
                "f9d66d0649e9bd11"
            ],
            [
                "c2ad03f07cca0d64",
                "2262ccb67c3b1114"
            ]
        ]
    },
    {
        "id": "c02601d37dfb8fc1",
        "type": "api-call-service",
        "z": "6a064f420a191bf8",
        "name": "Turn on humidification",
        "server": "3ec50562615a9f50",
        "version": 5,
        "debugenabled": false,
        "domain": "humidifier",
        "service": "turn_on",
        "areaId": [
            "master_bedroom"
        ],
        "deviceId": [
            "3a7bab5f23e10f98bb210ea2e7ca54a0"
        ],
        "entityId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "x": 1060,
        "y": 100,
        "wires": [
            [
                "8a6956eba86703b9"
            ]
        ]
    },
    {
        "id": "b4138b425944434b",
        "type": "api-call-service",
        "z": "6a064f420a191bf8",
        "name": "Turn off humidification",
        "server": "3ec50562615a9f50",
        "version": 5,
        "debugenabled": false,
        "domain": "humidifier",
        "service": "turn_off",
        "areaId": [
            "master_bedroom"
        ],
        "deviceId": [
            "3a7bab5f23e10f98bb210ea2e7ca54a0"
        ],
        "entityId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "x": 1060,
        "y": 40,
        "wires": [
            [
                "fefbf7c03885030f"
            ]
        ]
    },
    {
        "id": "20102ed2a3a10d6b",
        "type": "get-shared-state",
        "z": "6a064f420a191bf8",
        "state": "99455ccf.2c8498",
        "name": "Caroline Home",
        "triggerOnInit": true,
        "x": 100,
        "y": 300,
        "wires": [
            [
                "0a1bdf274467562a"
            ]
        ]
    },
    {
        "id": "0a1bdf274467562a",
        "type": "switch",
        "z": "6a064f420a191bf8",
        "name": "Not Home",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 270,
        "y": 300,
        "wires": [
            [
                "2d3889f3b872a383"
            ]
        ]
    },
    {
        "id": "a30febd4f0f1f98a",
        "type": "comment",
        "z": "6a064f420a191bf8",
        "name": "Run master bedroom humidifier at night",
        "info": "",
        "x": 170,
        "y": 40,
        "wires": []
    },
    {
        "id": "c2ad03f07cca0d64",
        "type": "delay",
        "z": "6a064f420a191bf8",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "12",
        "rateUnits": "hour",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": false,
        "outputs": 1,
        "x": 720,
        "y": 200,
        "wires": [
            [
                "9d4699704c3e41b4"
            ]
        ]
    },
    {
        "id": "0b4db01d2701a613",
        "type": "delay",
        "z": "6a064f420a191bf8",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "hours",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 1060,
        "y": 200,
        "wires": [
            [
                "e6de6db28626e551"
            ]
        ]
    },
    {
        "id": "9d4699704c3e41b4",
        "type": "api-call-service",
        "z": "6a064f420a191bf8",
        "name": "Max fan speed",
        "server": "3ec50562615a9f50",
        "version": 5,
        "debugenabled": false,
        "domain": "fan",
        "service": "set_percentage",
        "areaId": [
            "master_bedroom"
        ],
        "deviceId": [
            "3a7bab5f23e10f98bb210ea2e7ca54a0"
        ],
        "entityId": [
            "fan.master_bedroom"
        ],
        "data": "{\"percentage\": 100}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "x": 900,
        "y": 200,
        "wires": [
            [
                "0b4db01d2701a613"
            ]
        ]
    },
    {
        "id": "bfeccf01f3dd1801",
        "type": "comment",
        "z": "6a064f420a191bf8",
        "name": "Run hard for a little while",
        "info": "",
        "x": 750,
        "y": 160,
        "wires": []
    },
    {
        "id": "d712f79e9cfd991a",
        "type": "comment",
        "z": "6a064f420a191bf8",
        "name": "Reset Oscillation when Caroline Leaves or Sleeps",
        "info": "",
        "x": 200,
        "y": 260,
        "wires": []
    },
    {
        "id": "2d3889f3b872a383",
        "type": "api-call-service",
        "z": "6a064f420a191bf8",
        "name": "Turn on oscillation",
        "server": "3ec50562615a9f50",
        "version": 5,
        "debugenabled": false,
        "domain": "fan",
        "service": "oscillate",
        "areaId": [
            "guest_suite",
            "living_room_2",
            "master_bedroom"
        ],
        "deviceId": [],
        "entityId": [],
        "data": "{\"oscillating\": \"on\"}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "x": 510,
        "y": 280,
        "wires": [
            []
        ]
    },
    {
        "id": "5c736f9253fa9ba2",
        "type": "get-shared-state",
        "z": "6a064f420a191bf8",
        "state": "b7959b8b695cb2e3",
        "name": "Current Climate",
        "triggerOnInit": true,
        "x": 100,
        "y": 460,
        "wires": [
            [
                "23755656ed766d1e"
            ]
        ]
    },
    {
        "id": "a96e02e59ea320ab",
        "type": "get-shared-state",
        "z": "6a064f420a191bf8",
        "state": "1dd96a4a.9d6316",
        "name": "Anyone Home",
        "triggerOnInit": false,
        "x": 90,
        "y": 520,
        "wires": [
            [
                "9ca03041089b6a9d",
                "23755656ed766d1e"
            ]
        ]
    },
    {
        "id": "23755656ed766d1e",
        "type": "function",
        "z": "6a064f420a191bf8",
        "name": "Should we change fan speed?",
        "func": "// If nobody's home, slow the fans down to very low\nif (global.get(\"state\").isAnyoneHome.value == false) {\n    return [msg, null]\n} else {\n    return [null, msg]\n}",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 460,
        "wires": [
            [
                "4925b947985b2af7"
            ],
            [
                "d6780dc3d1f346a0"
            ]
        ]
    },
    {
        "id": "9ca03041089b6a9d",
        "type": "switch",
        "z": "6a064f420a191bf8",
        "name": "Just got home",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 280,
        "y": 520,
        "wires": [
            [
                "81b04d253cd97b0f"
            ]
        ]
    },
    {
        "id": "8bcd7836afc9a713",
        "type": "inject",
        "z": "6a064f420a191bf8",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 280,
        "y": 620,
        "wires": [
            [
                "81b04d253cd97b0f"
            ]
        ]
    },
    {
        "id": "81b04d253cd97b0f",
        "type": "delay",
        "z": "6a064f420a191bf8",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "2",
        "rateUnits": "hour",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": false,
        "outputs": 1,
        "x": 500,
        "y": 620,
        "wires": [
            [
                "e98856f0458e6d20"
            ]
        ]
    },
    {
        "id": "494cb5fc939fcbee",
        "type": "delay",
        "z": "6a064f420a191bf8",
        "name": "",
        "pauseType": "delay",
        "timeout": "5",
        "timeoutUnits": "minutes",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 840,
        "y": 620,
        "wires": [
            [
                "d6780dc3d1f346a0"
            ]
        ]
    },
    {
        "id": "e98856f0458e6d20",
        "type": "api-call-service",
        "z": "6a064f420a191bf8",
        "name": "Max fan speed",
        "server": "3ec50562615a9f50",
        "version": 5,
        "debugenabled": false,
        "domain": "fan",
        "service": "set_percentage",
        "areaId": [
            "guest_suite",
            "living_room_2",
            "master_bedroom"
        ],
        "deviceId": [],
        "entityId": [],
        "data": "{\"percentage\": 100}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "x": 680,
        "y": 620,
        "wires": [
            [
                "494cb5fc939fcbee"
            ]
        ]
    },
    {
        "id": "402a3618544d57e1",
        "type": "comment",
        "z": "6a064f420a191bf8",
        "name": "Run hard for a little while",
        "info": "",
        "x": 530,
        "y": 580,
        "wires": []
    },
    {
        "id": "4925b947985b2af7",
        "type": "api-call-service",
        "z": "6a064f420a191bf8",
        "name": "Low fan speed everywhere",
        "server": "3ec50562615a9f50",
        "version": 5,
        "debugenabled": false,
        "domain": "fan",
        "service": "set_percentage",
        "areaId": [
            "guest_suite",
            "living_room_2",
            "master_bedroom"
        ],
        "deviceId": [],
        "entityId": [],
        "data": "{\"percentage\": 10}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "x": 600,
        "y": 440,
        "wires": [
            []
        ]
    },
    {
        "id": "d6780dc3d1f346a0",
        "type": "function",
        "z": "6a064f420a191bf8",
        "name": "Send fan speed messages",
        "func": "// Get climate data\ncurrentClimate = global.get(\"state\").currentClimate.value\n\n// Handle Master Suite\ndesiredFanSpeed = currentClimate[\"Master Bedroom\"][\"fan speed\"]\nmsg.payload = {\"percentage\": desiredFanSpeed}\nnode.send([msg, null, null])\n\n// Handle Living Room\ndesiredFanSpeed = currentClimate[\"Living Room Center\"][\"fan speed\"]\nmsg.payload = {\"percentage\": desiredFanSpeed}\nnode.send([null, msg, null])\n\n// Handle Guest Suite\ndesiredFanSpeed = currentClimate[\"Bedroom\"][\"fan speed\"]\nmsg.payload = {\"percentage\": desiredFanSpeed}\nnode.send([null, null, msg])\n",
        "outputs": 3,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 600,
        "y": 500,
        "wires": [
            [
                "a78adf1024effbae"
            ],
            [
                "8677bb871d025c89"
            ],
            [
                "0e7095f3697a1233"
            ]
        ]
    },
    {
        "id": "a78adf1024effbae",
        "type": "api-call-service",
        "z": "6a064f420a191bf8",
        "name": "Master Suite Fan Speed",
        "server": "3ec50562615a9f50",
        "version": 5,
        "debugenabled": false,
        "domain": "fan",
        "service": "set_percentage",
        "areaId": [
            "master_bedroom"
        ],
        "deviceId": [],
        "entityId": [],
        "data": "msg.payload",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "x": 1030,
        "y": 460,
        "wires": [
            []
        ]
    },
    {
        "id": "b460a2f7c87f3795",
        "type": "api-call-service",
        "z": "6a064f420a191bf8",
        "name": "Living Room Fan Speed",
        "server": "3ec50562615a9f50",
        "version": 5,
        "debugenabled": false,
        "domain": "fan",
        "service": "set_percentage",
        "areaId": [
            "living_room_2"
        ],
        "deviceId": [],
        "entityId": [],
        "data": "msg.payload",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "x": 1030,
        "y": 500,
        "wires": [
            []
        ]
    },
    {
        "id": "8292bb8f30d17629",
        "type": "api-call-service",
        "z": "6a064f420a191bf8",
        "name": "Guest Suite Fan Speed",
        "server": "3ec50562615a9f50",
        "version": 5,
        "debugenabled": false,
        "domain": "fan",
        "service": "set_percentage",
        "areaId": [
            "guest_suite"
        ],
        "deviceId": [],
        "entityId": [],
        "data": "msg.payload",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "x": 1030,
        "y": 540,
        "wires": [
            []
        ]
    },
    {
        "id": "eda51c7dc115d229",
        "type": "get-shared-state",
        "z": "6a064f420a191bf8",
        "state": "60c1725bc2519ee0",
        "name": "Everyone Asleep",
        "triggerOnInit": false,
        "x": 100,
        "y": 360,
        "wires": [
            [
                "830e383c6a6cf5f5"
            ]
        ]
    },
    {
        "id": "db1966bfa72a10da",
        "type": "comment",
        "z": "6a064f420a191bf8",
        "name": "Set fan speeds based on presence and climate",
        "info": "",
        "x": 200,
        "y": 420,
        "wires": []
    },
    {
        "id": "830e383c6a6cf5f5",
        "type": "switch",
        "z": "6a064f420a191bf8",
        "name": "Yes asleep",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 270,
        "y": 360,
        "wires": [
            [
                "2d3889f3b872a383"
            ]
        ]
    },
    {
        "id": "b463d3c960f6c8f3",
        "type": "inject",
        "z": "6a064f420a191bf8",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 480,
        "y": 380,
        "wires": [
            [
                "d6780dc3d1f346a0",
                "2d3889f3b872a383"
            ]
        ]
    },
    {
        "id": "e6de6db28626e551",
        "type": "link out",
        "z": "6a064f420a191bf8",
        "name": "",
        "mode": "link",
        "links": [
            "caa6aa12e7dda2e1"
        ],
        "x": 1155,
        "y": 200,
        "wires": []
    },
    {
        "id": "caa6aa12e7dda2e1",
        "type": "link in",
        "z": "6a064f420a191bf8",
        "name": "Reset Fan Speeds",
        "links": [
            "e6de6db28626e551",
            "adc754d173d18011"
        ],
        "x": 405,
        "y": 500,
        "wires": [
            [
                "d6780dc3d1f346a0"
            ]
        ]
    },
    {
        "id": "225f857752659a36",
        "type": "comment",
        "z": "6a064f420a191bf8",
        "name": "Collect Temperature and Humidity Data",
        "info": "",
        "x": 170,
        "y": 680,
        "wires": []
    },
    {
        "id": "156f16e0c85e2816",
        "type": "api-current-state",
        "z": "6a064f420a191bf8",
        "name": "",
        "server": "3ec50562615a9f50",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "num",
        "halt_if_compare": "is",
        "entity_id": "sensor.master_bedroom_humidity",
        "state_type": "num",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 580,
        "y": 720,
        "wires": [
            [
                "06780408ced82219"
            ]
        ]
    },
    {
        "id": "975576f9dbe21947",
        "type": "inject",
        "z": "6a064f420a191bf8",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "300",
        "crontab": "",
        "once": true,
        "onceDelay": "1",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 110,
        "y": 940,
        "wires": [
            [
                "9c377bc17a4aa03a",
                "414b598fd90ee4de",
                "9a39ae1dd8b22980",
                "9fe8377df9dba651",
                "d0a15d3cd2962152",
                "ccf4342cd237b4fe",
                "1e71b32d69eb7fe6",
                "bbaee6b986a4ee5a",
                "a8b85510e85625a1",
                "8938a2be3cfaf03a",
                "2dafe3bdd3ee5d2b"
            ]
        ]
    },
    {
        "id": "75cb9283e2cb7aba",
        "type": "api-current-state",
        "z": "6a064f420a191bf8",
        "name": "",
        "server": "3ec50562615a9f50",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "num",
        "halt_if_compare": "is",
        "entity_id": "sensor.living_room_humidity",
        "state_type": "num",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 570,
        "y": 780,
        "wires": [
            [
                "eb26439b8c2472f8"
            ]
        ]
    },
    {
        "id": "2ec3a969aa01e5c2",
        "type": "api-current-state",
        "z": "6a064f420a191bf8",
        "name": "",
        "server": "3ec50562615a9f50",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "num",
        "halt_if_compare": "is",
        "entity_id": "sensor.living_room_humidity_2",
        "state_type": "num",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 570,
        "y": 840,
        "wires": [
            [
                "c463febc133f46b6"
            ]
        ]
    },
    {
        "id": "b3fd89c4de936d7c",
        "type": "api-current-state",
        "z": "6a064f420a191bf8",
        "name": "",
        "server": "3ec50562615a9f50",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "num",
        "halt_if_compare": "is",
        "entity_id": "sensor.bedroom_humidity",
        "state_type": "num",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 560,
        "y": 900,
        "wires": [
            [
                "605c125667351b1d"
            ]
        ]
    },
    {
        "id": "589452f0e043686c",
        "type": "api-current-state",
        "z": "6a064f420a191bf8",
        "name": "",
        "server": "3ec50562615a9f50",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "num",
        "halt_if_compare": "is",
        "entity_id": "sensor.master_bedroom_temperature",
        "state_type": "num",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 600,
        "y": 960,
        "wires": [
            [
                "c00c1d09dc355e50"
            ]
        ]
    },
    {
        "id": "19c242d2027aedf7",
        "type": "api-current-state",
        "z": "6a064f420a191bf8",
        "name": "",
        "server": "3ec50562615a9f50",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "num",
        "halt_if_compare": "is",
        "entity_id": "sensor.living_room_temperature",
        "state_type": "num",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 580,
        "y": 1020,
        "wires": [
            [
                "31739342eb065d47"
            ]
        ]
    },
    {
        "id": "59ac828528febe57",
        "type": "api-current-state",
        "z": "6a064f420a191bf8",
        "name": "",
        "server": "3ec50562615a9f50",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "num",
        "halt_if_compare": "is",
        "entity_id": "sensor.living_room_temperature_2",
        "state_type": "num",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 590,
        "y": 1080,
        "wires": [
            [
                "8a3e7c2d711a2d47"
            ]
        ]
    },
    {
        "id": "921d40799aa20523",
        "type": "api-current-state",
        "z": "6a064f420a191bf8",
        "name": "",
        "server": "3ec50562615a9f50",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "num",
        "halt_if_compare": "is",
        "entity_id": "sensor.bedroom_temperature",
        "state_type": "num",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 570,
        "y": 1140,
        "wires": [
            [
                "480f8c2ce0a49284"
            ]
        ]
    },
    {
        "id": "605c125667351b1d",
        "type": "set-shared-state",
        "z": "6a064f420a191bf8",
        "state": "816d3fb762a92b71",
        "name": "Humidity of Bedroom",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 1100,
        "y": 900,
        "wires": []
    },
    {
        "id": "c463febc133f46b6",
        "type": "set-shared-state",
        "z": "6a064f420a191bf8",
        "state": "d19054ef0f693509",
        "name": "Humidity of Living Room Window",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 1140,
        "y": 840,
        "wires": []
    },
    {
        "id": "eb26439b8c2472f8",
        "type": "set-shared-state",
        "z": "6a064f420a191bf8",
        "state": "7e0b34e77bae8edb",
        "name": "Humidity of Living Room Center",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 1130,
        "y": 780,
        "wires": []
    },
    {
        "id": "06780408ced82219",
        "type": "set-shared-state",
        "z": "6a064f420a191bf8",
        "state": "51ddddf9304ec19f",
        "name": "Humidity of Master Bedroom",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 1120,
        "y": 720,
        "wires": []
    },
    {
        "id": "c00c1d09dc355e50",
        "type": "set-shared-state",
        "z": "6a064f420a191bf8",
        "state": "4faab2d5448df995",
        "name": "Temperature of Master Bedroom",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 1130,
        "y": 960,
        "wires": []
    },
    {
        "id": "31739342eb065d47",
        "type": "set-shared-state",
        "z": "6a064f420a191bf8",
        "state": "098765180c8f29ad",
        "name": "Temperature of Living Room Center",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 1140,
        "y": 1020,
        "wires": []
    },
    {
        "id": "8a3e7c2d711a2d47",
        "type": "set-shared-state",
        "z": "6a064f420a191bf8",
        "state": "0133e13457d0b692",
        "name": "Temperature of Living Room Window",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 1150,
        "y": 1080,
        "wires": []
    },
    {
        "id": "480f8c2ce0a49284",
        "type": "set-shared-state",
        "z": "6a064f420a191bf8",
        "state": "60f1a7e39e0a4f1c",
        "name": "Temperature of Bedroom",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 1110,
        "y": 1140,
        "wires": []
    },
    {
        "id": "5c5b49d9b27da7ce",
        "type": "function",
        "z": "6a064f420a191bf8",
        "name": "Build indoor humidity and temp report",
        "func": "// Define shell of report\nreport = {\n    \"Master Bedroom\": {\n        \"temperature\": 0,\n        \"humidity\": 0\n    },\n    \"Living Room Window\": {\n        \"temperature\": 0,\n        \"humidity\": 0\n    },\n    \"Living Room Center\": {\n        \"temperature\": 0,\n        \"humidity\": 0\n    },\n    \"Bedroom\": {\n        \"temperature\": 0,\n        \"humidity\": 0\n    },\n    \"Average\": {\n        \"temperature\": 0,\n        \"humidity\": 0\n    },\n    \"Outside\": {\n        \"temperature\": 0,\n        \"humidity\": 0\n    }\n}\n// Record Master Bedroom values\nreport[\"Master Bedroom\"].temperature = Math.round(global.get(\"state\").temperatureOfMasterBedroom.value)\nreport[\"Master Bedroom\"].humidity = global.get(\"state\").humidityOfMasterBedroom.value\n// Record Living Room Window values\nreport[\"Living Room Window\"].temperature = Math.round(global.get(\"state\").temperatureOfLivingRoomWindow.value)\nreport[\"Living Room Window\"].humidity = global.get(\"state\").humidityOfLivingRoomWindow.value\n// Record Living Room Center values\nreport[\"Living Room Center\"].temperature = Math.round(global.get(\"state\").temperatureOfLivingRoomCenter.value)\nreport[\"Living Room Center\"].humidity = global.get(\"state\").humidityOfLivingRoomCenter.value\n// Record Bedroom values\nreport[\"Bedroom\"].temperature = Math.round(global.get(\"state\").temperatureOfBedroom.value)\nreport[\"Bedroom\"].humidity = global.get(\"state\").humidityOfBedroom.value\n// Define function for averaging values\nconst average = array => Math.round(array.reduce((a, b) => a + b) / array.length);\n// Take average temperature\nreport[\"Average\"].temperature = average([\n                                            report[\"Master Bedroom\"].temperature,\n                                            report[\"Living Room Window\"].temperature,\n                                            report[\"Living Room Center\"].temperature,\n                                            //report[\"Bedroom\"].temperature\n                                        ])\n// Take average humidity                       \nreport[\"Average\"].humidity = average([\n                                            report[\"Master Bedroom\"].humidity,\n                                            report[\"Living Room Window\"].humidity,\n                                            report[\"Living Room Center\"].humidity,\n                                            //report[\"Bedroom\"].humidity\n                                        ])\n\n\n// Record Outside values\nreport[\"Outside\"].temperature = Math.round(global.get(\"state\").temperatureOfOutside.value)\nreport[\"Outside\"].humidity = global.get(\"state\").humidityOfOutside.value\n\nmsg.payload = report\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 550,
        "y": 1320,
        "wires": [
            [
                "2ca0e3b65317dcaa"
            ]
        ]
    },
    {
        "id": "67c5137b0466f356",
        "type": "log-elk",
        "z": "6a064f420a191bf8",
        "name": "Log",
        "logger": "e98cb8b7d7a02f27",
        "complete": "payload",
        "loglevel": "info",
        "x": 1530,
        "y": 1320,
        "wires": []
    },
    {
        "id": "142fd9870b53a95d",
        "type": "switch",
        "z": "6a064f420a191bf8",
        "name": "If it's a number",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "istype",
                "v": "number",
                "vt": "number"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 900,
        "y": 1140,
        "wires": [
            []
        ]
    },
    {
        "id": "ae87c948b424fbf9",
        "type": "switch",
        "z": "6a064f420a191bf8",
        "name": "If it's a number",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "istype",
                "v": "number",
                "vt": "number"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 900,
        "y": 1080,
        "wires": [
            []
        ]
    },
    {
        "id": "396fb4253e303c36",
        "type": "switch",
        "z": "6a064f420a191bf8",
        "name": "If it's a number",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "istype",
                "v": "number",
                "vt": "number"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 900,
        "y": 1020,
        "wires": [
            []
        ]
    },
    {
        "id": "6345360059b9e468",
        "type": "switch",
        "z": "6a064f420a191bf8",
        "name": "If it's a number",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "istype",
                "v": "number",
                "vt": "number"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 900,
        "y": 960,
        "wires": [
            []
        ]
    },
    {
        "id": "9a9bfb194f2bc4dd",
        "type": "switch",
        "z": "6a064f420a191bf8",
        "name": "If it's a number",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "istype",
                "v": "number",
                "vt": "number"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 900,
        "y": 900,
        "wires": [
            []
        ]
    },
    {
        "id": "5c02b4ad91b25140",
        "type": "switch",
        "z": "6a064f420a191bf8",
        "name": "If it's a number",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "istype",
                "v": "number",
                "vt": "number"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 900,
        "y": 840,
        "wires": [
            []
        ]
    },
    {
        "id": "26ef1be69d85f102",
        "type": "switch",
        "z": "6a064f420a191bf8",
        "name": "If it's a number",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "istype",
                "v": "number",
                "vt": "number"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 900,
        "y": 780,
        "wires": [
            []
        ]
    },
    {
        "id": "feadb618e7635a07",
        "type": "switch",
        "z": "6a064f420a191bf8",
        "name": "If it's a number",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "istype",
                "v": "number",
                "vt": "number"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 900,
        "y": 720,
        "wires": [
            []
        ]
    },
    {
        "id": "9c377bc17a4aa03a",
        "type": "delay",
        "z": "6a064f420a191bf8",
        "name": "",
        "pauseType": "delay",
        "timeout": "0",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "0",
        "randomLast": "60",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 320,
        "y": 720,
        "wires": [
            [
                "156f16e0c85e2816"
            ]
        ]
    },
    {
        "id": "414b598fd90ee4de",
        "type": "delay",
        "z": "6a064f420a191bf8",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "0",
        "randomLast": "60",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 320,
        "y": 780,
        "wires": [
            [
                "75cb9283e2cb7aba"
            ]
        ]
    },
    {
        "id": "9a39ae1dd8b22980",
        "type": "delay",
        "z": "6a064f420a191bf8",
        "name": "",
        "pauseType": "delay",
        "timeout": "4",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "0",
        "randomLast": "60",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 320,
        "y": 840,
        "wires": [
            [
                "2ec3a969aa01e5c2"
            ]
        ]
    },
    {
        "id": "9fe8377df9dba651",
        "type": "delay",
        "z": "6a064f420a191bf8",
        "name": "",
        "pauseType": "delay",
        "timeout": "6",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "0",
        "randomLast": "60",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 320,
        "y": 900,
        "wires": [
            [
                "b3fd89c4de936d7c"
            ]
        ]
    },
    {
        "id": "d0a15d3cd2962152",
        "type": "delay",
        "z": "6a064f420a191bf8",
        "name": "",
        "pauseType": "delay",
        "timeout": "8",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "0",
        "randomLast": "60",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 320,
        "y": 960,
        "wires": [
            [
                "589452f0e043686c"
            ]
        ]
    },
    {
        "id": "ccf4342cd237b4fe",
        "type": "delay",
        "z": "6a064f420a191bf8",
        "name": "",
        "pauseType": "delay",
        "timeout": "10",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "0",
        "randomLast": "60",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 320,
        "y": 1020,
        "wires": [
            [
                "19c242d2027aedf7"
            ]
        ]
    },
    {
        "id": "1e71b32d69eb7fe6",
        "type": "delay",
        "z": "6a064f420a191bf8",
        "name": "",
        "pauseType": "delay",
        "timeout": "12",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "0",
        "randomLast": "60",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 320,
        "y": 1080,
        "wires": [
            [
                "59ac828528febe57"
            ]
        ]
    },
    {
        "id": "bbaee6b986a4ee5a",
        "type": "delay",
        "z": "6a064f420a191bf8",
        "name": "",
        "pauseType": "delay",
        "timeout": "14",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "0",
        "randomLast": "60",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 320,
        "y": 1140,
        "wires": [
            [
                "921d40799aa20523"
            ]
        ]
    },
    {
        "id": "a8b85510e85625a1",
        "type": "delay",
        "z": "6a064f420a191bf8",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "minutes",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "0",
        "randomLast": "60",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 320,
        "y": 1320,
        "wires": [
            [
                "5c5b49d9b27da7ce"
            ]
        ]
    },
    {
        "id": "f9d66d0649e9bd11",
        "type": "delay",
        "z": "6a064f420a191bf8",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "hour",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": true,
        "outputs": 1,
        "x": 710,
        "y": 40,
        "wires": [
            [
                "3ac1f5afde110dd5"
            ]
        ]
    },
    {
        "id": "2262ccb67c3b1114",
        "type": "delay",
        "z": "6a064f420a191bf8",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "2",
        "rateUnits": "minute",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": false,
        "outputs": 1,
        "x": 720,
        "y": 100,
        "wires": [
            [
                "185597969597ddde"
            ]
        ]
    },
    {
        "id": "9487045d442fbd6a",
        "type": "api-call-service",
        "z": "6a064f420a191bf8",
        "name": "Restart Home Assistant",
        "server": "3ec50562615a9f50",
        "version": 5,
        "debugenabled": false,
        "domain": "homeassistant",
        "service": "restart",
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "x": 1650,
        "y": 360,
        "wires": [
            [
                "adc754d173d18011"
            ]
        ]
    },
    {
        "id": "d640980ca6e1b2b1",
        "type": "catch",
        "z": "6a064f420a191bf8",
        "name": "Catch Dyson Errors",
        "scope": [
            "c02601d37dfb8fc1",
            "b4138b425944434b",
            "2d3889f3b872a383",
            "4925b947985b2af7",
            "a78adf1024effbae",
            "b460a2f7c87f3795",
            "8292bb8f30d17629"
        ],
        "uncaught": false,
        "x": 890,
        "y": 360,
        "wires": [
            [
                "c838778390ca81b8"
            ]
        ]
    },
    {
        "id": "c838778390ca81b8",
        "type": "delay",
        "z": "6a064f420a191bf8",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "4",
        "rateUnits": "hour",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": false,
        "outputs": 1,
        "x": 1080,
        "y": 360,
        "wires": [
            [
                "e137a7a92df1509a"
            ]
        ]
    },
    {
        "id": "e137a7a92df1509a",
        "type": "delay",
        "z": "6a064f420a191bf8",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "minutes",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 1240,
        "y": 360,
        "wires": [
            [
                "a649f7d60ee87e24"
            ]
        ]
    },
    {
        "id": "adc754d173d18011",
        "type": "link out",
        "z": "6a064f420a191bf8",
        "name": "",
        "mode": "link",
        "links": [
            "6016baf9f8808810",
            "caa6aa12e7dda2e1"
        ],
        "x": 1795,
        "y": 360,
        "wires": []
    },
    {
        "id": "6016baf9f8808810",
        "type": "link in",
        "z": "6a064f420a191bf8",
        "name": "Reset Humidifiers",
        "links": [
            "adc754d173d18011"
        ],
        "x": 265,
        "y": 120,
        "wires": [
            [
                "b8f64fef44da2ad4"
            ]
        ]
    },
    {
        "id": "cf5205abceb397a2",
        "type": "comment",
        "z": "6a064f420a191bf8",
        "name": "Handle Dyson Communication Errors",
        "info": "",
        "x": 950,
        "y": 320,
        "wires": []
    },
    {
        "id": "a649f7d60ee87e24",
        "type": "change",
        "z": "6a064f420a191bf8",
        "name": "Override Rate Limits",
        "rules": [
            {
                "t": "set",
                "p": "rate",
                "pt": "msg",
                "to": "0",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1420,
        "y": 360,
        "wires": [
            [
                "9487045d442fbd6a"
            ]
        ]
    },
    {
        "id": "3ac1f5afde110dd5",
        "type": "delay",
        "z": "6a064f420a191bf8",
        "name": "",
        "pauseType": "delay",
        "timeout": "15",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 880,
        "y": 40,
        "wires": [
            [
                "b4138b425944434b"
            ]
        ]
    },
    {
        "id": "185597969597ddde",
        "type": "delay",
        "z": "6a064f420a191bf8",
        "name": "",
        "pauseType": "delay",
        "timeout": "15",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 880,
        "y": 100,
        "wires": [
            [
                "c02601d37dfb8fc1"
            ]
        ]
    },
    {
        "id": "1e9541493a2ef7b4",
        "type": "inject",
        "z": "6a064f420a191bf8",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 160,
        "y": 120,
        "wires": [
            [
                "b8f64fef44da2ad4"
            ]
        ]
    },
    {
        "id": "1ab2bb4d53bedd65",
        "type": "set-shared-state",
        "z": "6a064f420a191bf8",
        "state": "1ce72a9fb27d8577",
        "name": "Is Humdifier On?",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 1390,
        "y": 100,
        "wires": []
    },
    {
        "id": "fa5d9866f07171f2",
        "type": "set-shared-state",
        "z": "6a064f420a191bf8",
        "state": "1ce72a9fb27d8577",
        "name": "Is Humdifier On?",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 1390,
        "y": 40,
        "wires": []
    },
    {
        "id": "8a6956eba86703b9",
        "type": "change",
        "z": "6a064f420a191bf8",
        "name": "True",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "true",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1230,
        "y": 100,
        "wires": [
            [
                "1ab2bb4d53bedd65"
            ]
        ]
    },
    {
        "id": "fefbf7c03885030f",
        "type": "change",
        "z": "6a064f420a191bf8",
        "name": "False",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "false",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1230,
        "y": 40,
        "wires": [
            [
                "fa5d9866f07171f2"
            ]
        ]
    },
    {
        "id": "8938a2be3cfaf03a",
        "type": "delay",
        "z": "6a064f420a191bf8",
        "name": "",
        "pauseType": "delay",
        "timeout": "16",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "0",
        "randomLast": "60",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 320,
        "y": 1200,
        "wires": [
            [
                "c8d0a2af88c5d967"
            ]
        ]
    },
    {
        "id": "c8d0a2af88c5d967",
        "type": "api-current-state",
        "z": "6a064f420a191bf8",
        "name": "",
        "server": "3ec50562615a9f50",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "num",
        "halt_if_compare": "is",
        "entity_id": "weather.home",
        "state_type": "num",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "$entity().attributes.temperature",
                "valueType": "jsonata"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 520,
        "y": 1200,
        "wires": [
            [
                "8bb8368fdc6c8511"
            ]
        ]
    },
    {
        "id": "540b66982a79e256",
        "type": "set-shared-state",
        "z": "6a064f420a191bf8",
        "state": "21cd8d0ba24c57ec",
        "name": "Temperature Of Outside",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 1110,
        "y": 1200,
        "wires": []
    },
    {
        "id": "8bb8368fdc6c8511",
        "type": "switch",
        "z": "6a064f420a191bf8",
        "name": "If it's a number",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "istype",
                "v": "number",
                "vt": "number"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 896,
        "y": 1199,
        "wires": [
            [
                "540b66982a79e256"
            ]
        ]
    },
    {
        "id": "2dafe3bdd3ee5d2b",
        "type": "delay",
        "z": "6a064f420a191bf8",
        "name": "",
        "pauseType": "delay",
        "timeout": "18",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "0",
        "randomLast": "60",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 320,
        "y": 1260,
        "wires": [
            [
                "b801117a19b49b89"
            ]
        ]
    },
    {
        "id": "b801117a19b49b89",
        "type": "api-current-state",
        "z": "6a064f420a191bf8",
        "name": "",
        "server": "3ec50562615a9f50",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "num",
        "halt_if_compare": "is",
        "entity_id": "weather.home",
        "state_type": "num",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "$entity().attributes.humidity",
                "valueType": "jsonata"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 520,
        "y": 1260,
        "wires": [
            [
                "7fab3cc451e297b5"
            ]
        ]
    },
    {
        "id": "e02d8abb3fc61b7c",
        "type": "set-shared-state",
        "z": "6a064f420a191bf8",
        "state": "fdd67c92f6cdbe67",
        "name": "Humditiy of Outside",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 1100,
        "y": 1260,
        "wires": []
    },
    {
        "id": "7fab3cc451e297b5",
        "type": "switch",
        "z": "6a064f420a191bf8",
        "name": "If it's a number",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "istype",
                "v": "number",
                "vt": "number"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 896,
        "y": 1259,
        "wires": [
            [
                "e02d8abb3fc61b7c"
            ]
        ]
    },
    {
        "id": "2ca0e3b65317dcaa",
        "type": "function",
        "z": "6a064f420a191bf8",
        "name": "Add Dewpoint",
        "func": "// From https://www.decatur.de/javascript/dew/dew-js.html\n\n/**\n * File dew.js\n * Copyright 2003 Wolfgang Kuehn\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *       http://www.apache.org/licenses/LICENSE-2.0\n */\n\nvar KELVIN = 0;\nvar CELSIUS = 1;\nvar FAHRENHEIT = 2;\n\nvar C_OFFSET = 273.15;\nvar F_C = 9.0/5.0;\n\nvar RELATIVE = 1;\nvar ABSOLUTE = 2;\n\nfunction Temperatures() {\n  this.array = new Array();\n}\n\nTemperatures.prototype.add = function(t) {\n  if (t.value!=null)\n    this.array[this.array.length] = t;\n}\n\nvar temps = new Temperatures();\n\nTemperatures.prototype.syncronize = function() {\n  for (var e in this.array) {\n    var t = this.array[e];\n    if (t.value!=null)\n      t.onChange();\n  }\n}\n\nTemperatures.prototype.setScale = function(scale) {\n  for (var e in this.array)\n    this.array[e].setScale(scale);\n}\n\nfunction Temperature(value, scale, elem) {\n  this.value;\n  this.scale = scale;\n  this.element = elem;\n  this.set(value);\n  temps.add(this);\n}\n\nTemperature.prototype.onChange = function() {\n  var v = stringToFloat(this.element.value);\n  this.set(v);\n}\n\nTemperature.prototype.update = function() {\n  if (this.element!=null)\n    this.element.value = truncate(this.get(),2,ABSOLUTE);\n}\n\nTemperature.prototype.setScale = function(scale) {\n  this.scale = scale;\n  this.update(); \n}\n\nTemperature.prototype.getScale = function() {\n  return this.scale;\n}\n\nTemperature.prototype.getKelvin = function() {\n  return this.value;\n}\n\nTemperature.prototype.setKelvin = function(value) {\n  this.value = value;\n  this.update();\n}\n\nTemperature.prototype.get = function() {\n  var v = this.value;\n  if (this.scale==CELSIUS)\n    v -= C_OFFSET;\n  else if (this.scale==FAHRENHEIT)\n    v = 32+(v-C_OFFSET)*F_C;\n  return v;\n}\n\nTemperature.prototype.set = function(value) {\n  this.value = value;\n  if (this.scale==CELSIUS)\n    this.value += C_OFFSET;\n  else if (this.scale==FAHRENHEIT)\n    this.value = (this.value-32)/F_C+C_OFFSET;\n  this.update();\n}\n\nTemperature.prototype.setElement = function(element) {\n  this.element = element;\n  this.update();\n}\n\nfunction TemperatureChange(value, scale, element) {\n  this.scale = scale;\n  this.element = element;\n  this.set(value);\n  temps.add(this);\n}\n\nTemperatureChange.prototype = new Temperature();\n\nTemperatureChange.prototype.get = function() {\n  var v = this.value;\n  if (this.scale==FAHRENHEIT)\n    v = v*F_C;\n  return v;\n}\n\nTemperatureChange.prototype.set = function(value) {\n  this.value = value;\n  if (this.scale==FAHRENHEIT)\n    this.value = this.value/F_C;\n  this.update();\n}\n\n\nvar minT = 173; // -100 Deg. C.\nvar maxT = 678;\n\n/*\n * Saturation Vapor Pressure formula for range -100..0 Deg. C.\n * This is taken from\n *   ITS-90 Formulations for Vapor Pressure, Frostpoint Temperature,\n *   Dewpoint Temperature, and Enhancement Factors in the Range 100 to +100 C\n * by Bob Hardy\n * as published in \"The Proceedings of the Third International Symposium on Humidity & Moisture\",\n * Teddington, London, England, April 1998\n*/\nvar k0 = -5.8666426e3;\nvar k1 = 2.232870244e1;\nvar k2 = 1.39387003e-2;\nvar k3 = -3.4262402e-5;\nvar k4 = 2.7040955e-8;\nvar k5 = 6.7063522e-1;\n\nfunction pvsIce(T) {\n  lnP = k0/T + k1 + (k2 + (k3 + (k4*T))*T)*T + k5*Math.log(T);\n  return Math.exp(lnP);\n}\n\n/**\n * Saturation Vapor Pressure formula for range 273..678 Deg. K.\n * This is taken from the\n *   Release on the IAPWS Industrial Formulation 1997\n *   for the Thermodynamic Properties of Water and Steam\n * by IAPWS (International Association for the Properties of Water and Steam),\n * Erlangen, Germany, September 1997.\n *\n * This is Equation (30) in Section 8.1 \"The Saturation-Pressure Equation (Basic Equation)\"\n*/\n\nvar n1 = 0.11670521452767e4;\nvar n6 = 0.14915108613530e2;\nvar n2 = -0.72421316703206e6;\nvar n7 = -0.48232657361591e4;\nvar n3 = -0.17073846940092e2;\nvar n8 = 0.40511340542057e6;\nvar n4 = 0.12020824702470e5;\nvar n9 = -0.23855557567849;\nvar n5 = -0.32325550322333e7;\nvar n10 = 0.65017534844798e3;\n\nfunction pvsWater(T) {\n  var th = T+n9/(T-n10);\n  var A = (th+n1)*th+n2;\n  var B = (n3*th+n4)*th+n5;\n  var C = (n6*th+n7)*th+n8;\n\n  var p = 2*C/(-B+Math.sqrt(B*B-4*A*C));\n  p *= p;\n  p *= p;\n  return p*1e6;\n}\n\n/**\n * Compute Saturation Vapor Pressure for minT<T[Deg.K]<maxT.\n */\nfunction PVS(T) {\n  if (T<minT || T>maxT) return NaN;\n  else if (T<C_OFFSET)\n    return pvsIce(T);\n  else\n    return pvsWater(T);\n}\n\n/**\n * Compute dewPoint for given relative humidity RH[%] and temperature T[Deg.K].\n */\nfunction dewPoint(RH,T) {\n  return solve(PVS, RH/100*PVS(T), T);\n}\n\n/**\n * Newton's Method to solve f(x)=y for x with an initial guess of x0.\n */\nfunction solve(f,y,x0) {\n  var x = x0;\n  var maxCount = 10;\n  var count = 0;\n  do {\n    var xNew;\n    var dx = x/1000; \n    var z=f(x);\n    xNew = x + dx*(y-z)/(f(x+dx)-z);\n    if (Math.abs((xNew-x)/xNew)<0.0001) \n      return xNew;\n    else if (count>maxCount) {\n      xnew=NaN; \n      throw new Error(1, \"Solver does not converge.\");\n      break; \n    }\n    x = xNew;\n    count ++;\n  } while (true);\n}\n\nfunction truncate(x, precision, mode) {\n  if (x==0)\n    return 0;\n  var magnitude;\n  if (mode==RELATIVE)\n    magnitude = Math.round(Math.log(Math.abs(x))/Math.LN10);\n  else\n    magnitude = 0;\n  var scale = Math.pow(10,precision-magnitude);\n  return Math.round(x*scale)/scale;\n}\n\nfunction stringToFloat(s) {\n  if (s.search(/^\\s*(\\+|\\-)?\\d*(\\.\\d*)?\\s*$/)==-1)\n    throw new Error(\"'\"+s+\"' is not a valid number\", \"'\"+s+\"' is not a valid number\");\n  return parseFloat(s);\n}\n\nfunction convert () {\n  var scale;\n  if (document.FORM.TScale[1].checked)\n    scale = 1;\n  else if (document.FORM.TScale[2].checked)\n    scale = 2;\n  else\n    scale = 0;\n\n  this.temps.setScale(scale);\n}\n\n// Now back into my code\nreport = msg.payload\n\nfor (var space_name in report) {\n    if (Object.prototype.hasOwnProperty.call(report, space_name)) {\n        space = report[space_name]\n        \n        temp_in_kelvins = ((space.temperature-32)/F_C)+C_OFFSET\n        \n        dew_point = ((dewPoint(space.humidity,temp_in_kelvins)-C_OFFSET)*F_C)+32\n    \n        report[space_name][\"dew point\"] = Math.round(dew_point)\n    }\n}\n\n// Build msg for logging\nmsg.payload = report;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 800,
        "y": 1320,
        "wires": [
            [
                "13cdd239fd5c641c"
            ]
        ]
    },
    {
        "id": "4d52600e1ec8c9ea",
        "type": "get-shared-state",
        "z": "6a064f420a191bf8",
        "state": "3d96ef25996d1dd1",
        "name": "Reset",
        "triggerOnInit": false,
        "x": 70,
        "y": 620,
        "wires": [
            [
                "23755656ed766d1e",
                "3d5f80903bf0d5a5"
            ]
        ]
    },
    {
        "id": "c2f98e5cab73fa1d",
        "type": "comment",
        "z": "6a064f420a191bf8",
        "name": "Reset with trigger",
        "info": "",
        "x": 100,
        "y": 580,
        "wires": []
    },
    {
        "id": "3d5f80903bf0d5a5",
        "type": "delay",
        "z": "6a064f420a191bf8",
        "name": "",
        "pauseType": "delay",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 480,
        "y": 340,
        "wires": [
            [
                "2d3889f3b872a383"
            ]
        ]
    },
    {
        "id": "13cdd239fd5c641c",
        "type": "function",
        "z": "6a064f420a191bf8",
        "name": "Add Heat Index",
        "func": "// From https://github.com/iwanaga/heat-index/blob/master/index.js\n\n/*\nThe MIT License (MIT)\n\nCopyright (c) 2014 Yoshihiro Iwanaga\n\nPermission is hereby granted, free of charge, to any person obtaining a copy\nof this software and associated documentation files (the \"Software\"), to deal\nin the Software without restriction, including without limitation the rights\nto use, copy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the Software is\nfurnished to do so, subject to the following conditions:\n\nThe above copyright notice and this permission notice shall be included in all\ncopies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\nFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\nAUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\nLIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\nOUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\nSOFTWARE.\n*/\n\nvar HI = {\n    // utility functions\n    toFahrenheit: function (celsius) {\n        return (9 * celsius / 5 + 32);\n    },\n    toCelsius: function (fehrenheit) {\n        return (5 * (fehrenheit - 32) / 9);\n    },\n    getType: function (input) {\n        return ({}.toString.call(input).slice(8, -1));\n    },\n\n    // definition http://www.hpc.ncep.noaa.gov/html/heatindex_equation.shtml\n    // input = {\n    //     temperature: Number,  required\n    //     humidity   : Number,  required\n    //     fahrenheit : Boolean, optional\n    // }\n    heatIndex: function (input) {\n        if (arguments.length === 0) {\n            throw new Error(\"Invalid Argument. Need at least one.\");\n        }\n        if (HI.getType(input) !== 'Object') {\n            throw new TypeError(\"Invalid Argument. Expecting 'Object'\");\n        }\n        if (HI.getType(input.temperature) !== 'Number' ||\n            HI.getType(input.humidity) !== 'Number') {\n            throw new TypeError(\"Invalid Argument. temperature and humidity must be 'Number'\");\n        }\n\n        var t = HI.toFahrenheit(input.temperature) || 0,\n            h = input.humidity || 0;\n\n        if (input.fahrenheit) {\n            t = input.temperature;\n        }\n\n        // Steadman's result\n        var heatIndex = 0.5 * (t + 61 + (t - 68) * 1.2 + h * 0.094);\n\n        // regression equation of Rothfusz is appropriate\n        if (t >= 80) {\n            var heatIndexBase = (-42.379                      +\n                                   2.04901523 * t             +\n                                  10.14333127         * h     +\n                                  -0.22475541 * t     * h     +\n                                  -0.00683783 * t * t         +\n                                  -0.05481717         * h * h +\n                                   0.00122874 * t * t * h     +\n                                   0.00085282 * t     * h * h +\n                                  -0.00000199 * t * t * h * h);\n            // adjustment\n            if (h < 13 && t <= 112) {\n                heatIndex = heatIndexBase - (13 - h) / 4 * Math.sqrt((17 - Math.abs(t - 95)) / 17);\n            } else if (h > 85 && t <= 87) {\n                heatIndex = heatIndexBase + ((h - 85) / 10) * ((87 - t) / 5)\n            } else {\n                heatIndex = heatIndexBase;\n            }\n        }\n        return (input.fahrenheit ? heatIndex : HI.toCelsius(heatIndex));\n    }\n};\n\n// Now back into my code\nreport = msg.payload\n\nfor (var space_name in report) {\n    if (Object.prototype.hasOwnProperty.call(report, space_name)) {\n        space = report[space_name]\n        \n        object = {temperature: space.temperature, humidity: space.humidity, fahrenheit: true}\n\n        heat_index = HI.heatIndex(object)\n    \n        report[space_name][\"heat index\"] = Math.round(heat_index)\n    }\n}\n\nmsg.payload = report\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 980,
        "y": 1320,
        "wires": [
            [
                "9c17512707c3eacc"
            ]
        ]
    },
    {
        "id": "02049bc0fd4e568d",
        "type": "function",
        "z": "6a064f420a191bf8",
        "name": "Prep for logging",
        "func": "report = msg.payload\n\n// Build msg for logging\nmsg.payload = {};\nmsg.payload.object = report\nmsg.payload.type = \"object\"\nmsg.payload.object_string = JSON.stringify(msg.payload.object);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1380,
        "y": 1320,
        "wires": [
            [
                "67c5137b0466f356"
            ]
        ]
    },
    {
        "id": "dc9b616a983b60a1",
        "type": "set-shared-state",
        "z": "6a064f420a191bf8",
        "state": "b7959b8b695cb2e3",
        "name": "Current Climate",
        "triggerOnInit": true,
        "provideOutput": false,
        "outputs": 0,
        "x": 1380,
        "y": 1380,
        "wires": []
    },
    {
        "id": "d15e2659196fc1ca",
        "type": "inject",
        "z": "6a064f420a191bf8",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 1460,
        "y": 320,
        "wires": [
            [
                "9487045d442fbd6a"
            ]
        ]
    },
    {
        "id": "9c17512707c3eacc",
        "type": "function",
        "z": "6a064f420a191bf8",
        "name": "Set fan speeds",
        "func": "currentClimate = msg.payload\n\nfunction calculateFanSpeed(heatIndex) {\n  // Totally arbitrary formula reflecting our comfort.\n  rawFanSpeed = Math.sqrt((heatIndex-67)*3)\n  if (isNaN(rawFanSpeed)) {\n      rawFanSpeed = 2\n  }\n  actualFanSpeed = Math.max(2,rawFanSpeed) // Min fan speed of 2 when we're here\n  actualFanSpeed = Math.min(10, actualFanSpeed) // Max possible fan speed of 10\n  fanSpeedAsPercentage = Math.round(actualFanSpeed)*10\n  return fanSpeedAsPercentage;\n}\n\n// Handle Master Bedroom\nmasterBedroomHeatIndex = currentClimate[\"Master Bedroom\"][\"heat index\"]\ndesiredFanSpeed = calculateFanSpeed(masterBedroomHeatIndex)\ncurrentClimate[\"Master Bedroom\"][\"fan speed\"] = desiredFanSpeed\n\n// Handle Guest Suite\nguestSuiteHeatIndex = currentClimate[\"Bedroom\"][\"heat index\"]\ndesiredFanSpeed = calculateFanSpeed(guestSuiteHeatIndex)\ncurrentClimate[\"Bedroom\"][\"fan speed\"] = desiredFanSpeed\n\n// Handle Living Room\nlivingRoomHeatIndex = currentClimate[\"Living Room Center\"][\"heat index\"]\ndesiredFanSpeed = calculateFanSpeed(livingRoomHeatIndex)\ncurrentClimate[\"Living Room Center\"][\"fan speed\"] = desiredFanSpeed\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1160,
        "y": 1320,
        "wires": [
            [
                "02049bc0fd4e568d",
                "dc9b616a983b60a1"
            ]
        ]
    },
    {
        "id": "8677bb871d025c89",
        "type": "delay",
        "z": "6a064f420a191bf8",
        "name": "",
        "pauseType": "delay",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 840,
        "y": 500,
        "wires": [
            [
                "b460a2f7c87f3795"
            ]
        ]
    },
    {
        "id": "0e7095f3697a1233",
        "type": "delay",
        "z": "6a064f420a191bf8",
        "name": "",
        "pauseType": "delay",
        "timeout": "10",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 840,
        "y": 540,
        "wires": [
            [
                "8292bb8f30d17629"
            ]
        ]
    },
    {
        "id": "44cda3a058c5f5cc",
        "type": "function",
        "z": "0d2150a703bedcd6",
        "name": "Is Caroline Home?",
        "func": "if (global.get(\"state\").isCarolineHome.value) {\n    return msg;\n}\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 670,
        "y": 60,
        "wires": [
            [
                "07129761ac46de86"
            ]
        ]
    },
    {
        "id": "c847b6e97b66948b",
        "type": "get-shared-state",
        "z": "0d2150a703bedcd6",
        "state": "e3cb7570.0dbb48",
        "name": "Nick Home",
        "triggerOnInit": true,
        "x": 100,
        "y": 60,
        "wires": [
            [
                "9d7681a097b04acc"
            ]
        ]
    },
    {
        "id": "9d7681a097b04acc",
        "type": "switch",
        "z": "0d2150a703bedcd6",
        "name": "Is Nick no longer home?",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 290,
        "y": 60,
        "wires": [
            [
                "4d866f7c2e888ea3"
            ]
        ]
    },
    {
        "id": "652153416240f8b4",
        "type": "delay",
        "z": "0d2150a703bedcd6",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "day",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 130,
        "y": 120,
        "wires": [
            [
                "7cb519ff000e094a"
            ]
        ]
    },
    {
        "id": "4d866f7c2e888ea3",
        "type": "delay",
        "z": "0d2150a703bedcd6",
        "name": "",
        "pauseType": "delay",
        "timeout": "20",
        "timeoutUnits": "minutes",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 490,
        "y": 60,
        "wires": [
            [
                "44cda3a058c5f5cc"
            ]
        ]
    },
    {
        "id": "76ee9a333fd011df",
        "type": "ttsultimate",
        "z": "0d2150a703bedcd6",
        "name": "",
        "voice": "en-US",
        "ssml": false,
        "sonosipaddress": "10.212.100.226",
        "sonosvolume": "30",
        "sonoshailing": "Hailing_ComputerCall.mp3",
        "config": "89337ebbba16965d",
        "property": "payload",
        "propertyType": {},
        "rules": [],
        "playertype": "sonos",
        "speakingrate": "1",
        "speakingpitch": "0",
        "unmuteIfMuted": true,
        "x": 570,
        "y": 120,
        "wires": [
            [],
            []
        ]
    },
    {
        "id": "a58f3514bc59d688",
        "type": "link call",
        "z": "0d2150a703bedcd6",
        "name": "Reset Music",
        "links": [
            "b1f2b5145a191585"
        ],
        "timeout": "30",
        "x": 750,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "1b58fbbef7b0455c",
        "type": "catch",
        "z": "0d2150a703bedcd6",
        "name": "Catch TTS Error",
        "scope": [
            "76ee9a333fd011df"
        ],
        "uncaught": false,
        "x": 580,
        "y": 180,
        "wires": [
            [
                "a58f3514bc59d688"
            ]
        ]
    },
    {
        "id": "7cb519ff000e094a",
        "type": "function",
        "z": "0d2150a703bedcd6",
        "name": "Generate Notification Message",
        "func": "notification_message = \"Caroline, have you selected an EMDR pratctitioner?\"\n\nmsg.payload = notification_message\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 120,
        "wires": [
            [
                "76ee9a333fd011df"
            ]
        ]
    },
    {
        "id": "07129761ac46de86",
        "type": "function",
        "z": "0d2150a703bedcd6",
        "name": "Stop if anyone asleep",
        "func": "if (global.get(\"state\").isAnyoneAsleep.value) {\n    return null;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 880,
        "y": 60,
        "wires": [
            [
                "652153416240f8b4"
            ]
        ]
    },
    {
        "id": "48499f70f7e241ea",
        "type": "function",
        "z": "0d2150a703bedcd6",
        "name": "SideBrush",
        "func": "msg.payload = (100-(msg.payload[0]['side_brush_work_time']/720000*100)).toFixed(1);\n\nnode.status({fill:\"grey\",shape:\"ring\",text:msg.payload+'%'})\nmsg.payload = {\n    \"NeedAction\":msg.payload<10?true:false,\n    \"LifePercentage\":msg.payload\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 490,
        "y": 580,
        "wires": [
            [
                "0dd36d9179a45057"
            ]
        ]
    },
    {
        "id": "4a9057efbf51d7a8",
        "type": "miio-roborock-command",
        "z": "0d2150a703bedcd6",
        "name": "",
        "server": "b63f730b24581cdc",
        "command_name": "ⓘ Get consumables status",
        "command": "get_consumable",
        "commandType": "vacuum_cmd",
        "payload": "arguments",
        "payloadType": "vacuum_payload",
        "coordinates": "[\n   [22200,23500,28000,28000,1]\n]",
        "fan_speed": "",
        "homekit_stop_to_dock": true,
        "x": 220,
        "y": 500,
        "wires": [
            [
                "51534bf8c71afd93",
                "48499f70f7e241ea",
                "fbdd5450095d64c1",
                "70f88ee57574292e"
            ]
        ]
    },
    {
        "id": "51534bf8c71afd93",
        "type": "function",
        "z": "0d2150a703bedcd6",
        "name": "MainBrush",
        "func": "msg.payload = (100-(msg.payload[0]['main_brush_work_time']/1080000*100)).toFixed(1);\n\nnode.status({fill:\"grey\",shape:\"ring\",text:msg.payload+'%'})\n\n\nmsg.payload = {\n    \"NeedAction\":msg.payload<10?true:false,\n    \"LifePercentage\":msg.payload\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 490,
        "y": 460,
        "wires": [
            [
                "c38596ac1f7c9a51"
            ]
        ]
    },
    {
        "id": "fbdd5450095d64c1",
        "type": "function",
        "z": "0d2150a703bedcd6",
        "name": "MainFilter",
        "func": "msg.payload = (100-(msg.payload[0]['filter_work_time']/540000*100)).toFixed(1);\n\nnode.status({fill:\"grey\",shape:\"ring\",text:msg.payload+'%'})\nmsg.payload = {\n    \"NeedAction\":msg.payload<10?true:false,\n    \"LifePercentage\":msg.payload\n}\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 480,
        "y": 540,
        "wires": [
            [
                "a5b5cddbfa15e10f"
            ]
        ]
    },
    {
        "id": "70f88ee57574292e",
        "type": "function",
        "z": "0d2150a703bedcd6",
        "name": "Sensors",
        "func": "msg.payload = (100-(msg.payload[0]['sensor_dirty_time']/108000*100)).toFixed(1);\n\nnode.status({fill:\"grey\",shape:\"ring\",text:msg.payload+'%'})\nmsg.payload = {\n    \"NeedAction\":msg.payload<10?true:false,\n    \"LifePercentage\":msg.payload\n}\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 480,
        "y": 500,
        "wires": [
            [
                "41cdf9984d90bb63"
            ]
        ]
    },
    {
        "id": "ade63541efa85ad9",
        "type": "comment",
        "z": "0d2150a703bedcd6",
        "name": "Monitor Vacuum condition",
        "info": "",
        "x": 150,
        "y": 260,
        "wires": []
    },
    {
        "id": "2082f109d24fd5df",
        "type": "get-shared-state",
        "z": "0d2150a703bedcd6",
        "state": "e3cb7570.0dbb48",
        "name": "Nick Home",
        "triggerOnInit": false,
        "x": 100,
        "y": 400,
        "wires": [
            [
                "d2b122d332817454"
            ]
        ]
    },
    {
        "id": "d2b122d332817454",
        "type": "switch",
        "z": "0d2150a703bedcd6",
        "name": "Is Nick now home",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 270,
        "y": 400,
        "wires": [
            [
                "c7bf946f9d0edb67"
            ]
        ]
    },
    {
        "id": "f58432cd44c4ee58",
        "type": "delay",
        "z": "0d2150a703bedcd6",
        "name": "",
        "pauseType": "delay",
        "timeout": "20",
        "timeoutUnits": "minutes",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 610,
        "y": 400,
        "wires": [
            [
                "29ed3433950d1217"
            ]
        ]
    },
    {
        "id": "29ed3433950d1217",
        "type": "function",
        "z": "0d2150a703bedcd6",
        "name": "Stop if anyone asleep",
        "func": "if (global.get(\"state\").isAnyoneAsleep.value) {\n    return null;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 800,
        "y": 400,
        "wires": [
            [
                "4a9057efbf51d7a8"
            ]
        ]
    },
    {
        "id": "146375e5084782cc",
        "type": "function",
        "z": "0d2150a703bedcd6",
        "name": "Generate Notification Message",
        "func": "notification_message = \"Nick, the Vacuum filter needs cleaning\"\n\nmsg.payload = notification_message\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 890,
        "y": 540,
        "wires": [
            [
                "66a52590c9317bed"
            ]
        ]
    },
    {
        "id": "ca79f8be6dbfd91d",
        "type": "function",
        "z": "0d2150a703bedcd6",
        "name": "Generate Notification Message",
        "func": "notification_message = \"Nick, the Vacuum side brush needs replacement\"\n\nmsg.payload = notification_message\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 890,
        "y": 580,
        "wires": [
            [
                "66a52590c9317bed"
            ]
        ]
    },
    {
        "id": "3a8501bdb465f149",
        "type": "function",
        "z": "0d2150a703bedcd6",
        "name": "Generate Notification Message",
        "func": "notification_message = \"Nick, the Vacuum sensors need cleaning\"\n\nmsg.payload = notification_message\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 890,
        "y": 500,
        "wires": [
            [
                "66a52590c9317bed"
            ]
        ]
    },
    {
        "id": "bd29751017d59409",
        "type": "function",
        "z": "0d2150a703bedcd6",
        "name": "Generate Notification Message",
        "func": "notification_message = \"Nick, the Vacuum main brush need replacement\"\n\nmsg.payload = notification_message\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 890,
        "y": 460,
        "wires": [
            [
                "66a52590c9317bed"
            ]
        ]
    },
    {
        "id": "c38596ac1f7c9a51",
        "type": "switch",
        "z": "0d2150a703bedcd6",
        "name": "If NeedAction",
        "property": "payload.NeedAction",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 660,
        "y": 460,
        "wires": [
            [
                "bd29751017d59409"
            ]
        ]
    },
    {
        "id": "41cdf9984d90bb63",
        "type": "switch",
        "z": "0d2150a703bedcd6",
        "name": "If NeedAction",
        "property": "payload.NeedAction",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 660,
        "y": 500,
        "wires": [
            [
                "3a8501bdb465f149"
            ]
        ]
    },
    {
        "id": "a5b5cddbfa15e10f",
        "type": "switch",
        "z": "0d2150a703bedcd6",
        "name": "If NeedAction",
        "property": "payload.NeedAction",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 660,
        "y": 540,
        "wires": [
            [
                "146375e5084782cc"
            ]
        ]
    },
    {
        "id": "0dd36d9179a45057",
        "type": "switch",
        "z": "0d2150a703bedcd6",
        "name": "If NeedAction",
        "property": "payload.NeedAction",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 660,
        "y": 580,
        "wires": [
            [
                "ca79f8be6dbfd91d"
            ]
        ]
    },
    {
        "id": "31193921b3a643b8",
        "type": "inject",
        "z": "0d2150a703bedcd6",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 440,
        "y": 340,
        "wires": [
            [
                "29ed3433950d1217"
            ]
        ]
    },
    {
        "id": "66a52590c9317bed",
        "type": "delay",
        "z": "0d2150a703bedcd6",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "20",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 160,
        "y": 640,
        "wires": [
            [
                "c9bd838ac0165bad"
            ]
        ]
    },
    {
        "id": "c9bd838ac0165bad",
        "type": "ttsultimate",
        "z": "0d2150a703bedcd6",
        "name": "",
        "voice": "en-GB",
        "ssml": false,
        "sonosipaddress": "10.212.100.231",
        "sonosvolume": "25",
        "sonoshailing": "Hailing_ComputerCall.mp3",
        "config": "89337ebbba16965d",
        "property": "payload",
        "propertyType": {},
        "rules": [],
        "playertype": "sonos",
        "speakingrate": "1",
        "speakingpitch": "0",
        "unmuteIfMuted": false,
        "x": 330,
        "y": 640,
        "wires": [
            [],
            []
        ]
    },
    {
        "id": "e0383b358de144da",
        "type": "link call",
        "z": "0d2150a703bedcd6",
        "name": "Reset Music",
        "links": [
            "b1f2b5145a191585"
        ],
        "timeout": "30",
        "x": 510,
        "y": 700,
        "wires": [
            []
        ]
    },
    {
        "id": "b705ee2179e2857b",
        "type": "catch",
        "z": "0d2150a703bedcd6",
        "name": "Catch TTS Error",
        "scope": [
            "c9bd838ac0165bad"
        ],
        "uncaught": false,
        "x": 340,
        "y": 700,
        "wires": [
            [
                "e0383b358de144da"
            ]
        ]
    },
    {
        "id": "c7bf946f9d0edb67",
        "type": "delay",
        "z": "0d2150a703bedcd6",
        "name": "",
        "pauseType": "rate",
        "timeout": "20",
        "timeoutUnits": "minutes",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "day",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 450,
        "y": 400,
        "wires": [
            [
                "f58432cd44c4ee58"
            ]
        ]
    }
]